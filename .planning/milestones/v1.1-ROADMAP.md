# Milestone v1.1: Unified COP Architecture

**Status:** ✅ SHIPPED 2026-02-03
**Phases:** 7-12
**Total Plans:** 20

## Overview

Integrate MRM Code of Practice and RANZ Installation Guides into a unified navigation system with clear source attribution, enabling Building Code citation while providing rich installation content.

**Core Value:** Three-click access to authoritative roofing details with clear source attribution for Building Code citation.

## Phases

### Phase 7: Data Model Foundation

**Goal**: Establish cross-source linking infrastructure that preserves authority hierarchy
**Depends on**: None (foundation phase)
**Plans**: 3 plans

Plans:
- [x] 07-01: Schema additions (topics, detailLinks, legislativeReferences tables)
- [x] 07-02: Topic seeding and category mapping
- [x] 07-03: Query functions (getDetailsByTopic, getDetailWithLinks)

**Details:**
- Created detail_links table for MRM-RANZ cross-references
- Created topics and category_topics tables for semantic grouping
- Normalized legislative_references for NZBC citation format
- Migration ensuring all substrates exist with placeholder categories
- Query functions: getDetailsByTopic, getDetailWithRelatedContent
- 13 semantic topics seeded across sources

---

### Phase 8: Visual Authority System

**Goal**: Users can distinguish authoritative content from supplementary content at a glance
**Depends on**: Phase 7 (data model must exist for source attribution)
**Plans**: 2 plans

Plans:
- [x] 08-01: Foundation components (AuthoritativeContent, SupplementaryContent, ContentCapabilityBadges, getAuthorityLevel)
- [x] 08-02: Extended SourceBadge with authority variants and DetailCard enhancement

**Details:**
- AuthoritativeContent wrapper (blue border-left styling)
- SupplementaryContent wrapper (grey border-left styling)
- ContentCapabilityBadges (3D, Steps, Warnings, Case Law icons)
- SourceBadge with cva variants for authority styling
- VersionWatermark showing "MRM COP v25.12"
- Updated DetailCard with capability badges

---

### Phase 9: Unified Navigation

**Goal**: Users can browse by semantic topic and see all relevant content from all sources
**Depends on**: Phase 7 (topics tables), Phase 8 (source badges)
**Plans**: 4 plans

Plans:
- [x] 09-01: Topic page infrastructure (topics listing and detail pages)
- [x] 09-02: Filter components (SourceFilterTabs, CapabilityFilters, ComingSoonPlaceholder)
- [x] 09-03: Filter integration and enhanced queries
- [x] 09-04: Home page Topics section and flow verification

**Details:**
- TopicCategoryPage showing unified source content
- SourceFilterTabs component (All / MRM / RANZ)
- CapabilityFilters component (3D, Steps, Warnings, Case Law)
- URL state for all filters (shareable links, back button support)
- SectionNavigation for COP structure browsing
- ComingSoon placeholder for empty substrates
- Topics section on home page

---

### Phase 10: Detail Page Enhancement

**Goal**: Detail pages compose content from linked sources, showing MRM specs with RANZ 3D/steps when linked
**Depends on**: Phase 7 (detail links), Phase 8 (visual authority), Phase 9 (navigation context)
**Plans**: 4 plans

Plans:
- [x] 10-01: ImageGallery and RelatedContentTab components
- [x] 10-02: DetailViewer enhancement with linked content integration
- [x] 10-03: Detail page API integration and visual verification
- [x] 10-04: Gap closure (images schema + test detail_links data)

**Details:**
- Enhanced DetailViewer with linked guide integration
- ImageGallery component with ImageLightbox (zoom/pan, 12x12 close button)
- RelatedContentTab showing bidirectional links (supplements/supplementsTo)
- Dynamic section visibility based on content availability
- Derived display pattern: calculate display values from own + linked content
- Promise.all for parallel step fetching (200ms → 50ms latency)
- Images column added to details table schema

---

### Phase 11: Search Enhancement

**Goal**: Search respects authority hierarchy, prioritizing MRM content for consent documentation
**Depends on**: Phase 7 (source fields), Phase 8 (source badges)
**Plans**: 3 plans

Plans:
- [x] 11-01: Database migration and ts_rank API enhancement
- [x] 11-02: ConsentModeToggle component
- [x] 11-03: GroupedSearchResults and search page integration

**Details:**
- search_vector column with GIN index for full-text search
- Source-weighted search with MRM 2x relevance boost
- websearch_to_tsquery for safe natural language query handling
- GroupedSearchResults component (MRM section first, then RANZ)
- ConsentModeToggle hiding supplementary content
- SearchResultCard with authority-aware styling
- Section number detection with redirect URL
- Consent mode forces sourceId='mrm-cop' filter

---

### Phase 12: Content Linking Population

**Goal**: All MRM details are appropriately linked to RANZ guides, validated across all content scenarios
**Depends on**: Phase 7 (link table), Phase 10 (detail display), Phase 11 (search)
**Plans**: 4 plans

Plans:
- [x] 12-01: Suggestion script and link CRUD API
- [x] 12-02: Admin link management UI
- [x] 12-03: E2E tests for content scenarios
- [x] 12-04: Admin verification and population audit

**Details:**
- scripts/suggest-detail-links.ts (315 lines) with string-similarity package
- 274 suggestions generated (26 exact, 248 related)
- Three-tier confidence: exact (1.0), partial (>=0.7), related (>=0.5)
- Admin link CRUD API with Zod validation
- Admin links page at /admin/links
- Suggestions review page at /admin/links/suggestions
- Bulk "Approve All Exact" action
- 16 E2E tests for content scenarios (skip gracefully without auth)
- Link population audit report

---

## Milestone Summary

**Key Decisions:**
- MRM is authoritative (primary), RANZ is supplementary (decision from research)
- Blue border-left for authoritative, grey for supplementary
- Bidirectional link model: supplements and supplementsTo arrays
- URL state for all filters (shareable links, back button support)
- Content borrowing with source attribution
- Dual parameter pattern for consent mode (consentMode=true AND source=mrm-cop)
- Three-tier confidence for link suggestions

**Issues Resolved:**
- Self-referential FK in Drizzle causes TS error → add via migration SQL
- DetailCard replaced warning/failure badges with ContentCapabilityBadges
- ImageLightbox uses 12x12 close button for mobile accessibility
- Explicit length check for empty arrays prevents rendering "0"
- E2E tests require Clerk auth setup → tests skip gracefully

**Issues Deferred:**
- E2E tests with Playwright Clerk integration (tests skip without auth)
- Maximum link coverage is 11.6% given content overlap

**Technical Debt Incurred:**
- 3 orphaned exports (legislative-format utilities) - forward-looking, will be consumed when UI built

---

_For current project status, see .planning/ROADMAP.md_

---
*Archived: 2026-02-03 as part of v1.1 milestone completion*
