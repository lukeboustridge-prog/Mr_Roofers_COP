# Milestone v1.2: Digital COP

**Status:** SHIPPED 2026-02-08
**Phases:** 13-18
**Total Plans:** 11

## Overview

Restructure app navigation to mirror the MRM COP PDF's 19-chapter structure so roofers can navigate the digital version exactly as they would the printed document, with supplementary content (3D models, HTG guides, case law) surfacing inline as collapsible panels.

## Phases

### Phase 13: Data Foundation

**Goal**: COP structure is queryable in the database and chapter content is deliverable as lightweight per-chapter JSON files
**Depends on**: Nothing (first phase of v1.2; builds on v1.1 schema)
**Requirements**: COPR-01, COPR-02, COPR-04
**Plans**: 2 plans

Plans:
- [x] 13-01: Database schema and COP hierarchy import
- [x] 13-02: Chapter JSON split and section-detail linking

**What Shipped:**
- 5 new database tables (cop_sections, cop_section_images, cop_section_details, htg_content, cop_section_htg)
- 1,121 COP sections imported across 19 chapters with recursive hierarchy
- 105 section images imported (667 pending R2 upload)
- 19 per-chapter JSON files in /public/cop/ (3.7 MB total)
- Idempotent import scripts for hierarchy, images, and chapter JSON splitting

### Phase 14: Basic COP Reader

**Goal**: Users can browse and read COP chapter content in the app with the same structure and section numbers as the printed PDF
**Depends on**: Phase 13
**Requirements**: COPR-05, COPR-06
**Plans**: 2 plans

Plans:
- [x] 14-01: COP types, chapter grid index page, chapter reader shell, loading skeletons
- [x] 14-02: Recursive section renderer with inline images, chapter reader wiring

**What Shipped:**
- COP chapter grid at /cop with BookOpen icons and version display (v25.12)
- Chapter reader with recursive SectionRenderer (h2-h6 hierarchy)
- Inline R2-hosted technical diagrams via Next.js Image
- Content deduplication (strips duplicate section number + title from JSON)
- TypeScript types for COP JSON structure

### Phase 15: Navigation Chrome

**Goal**: Users can orient themselves within the COP hierarchy and navigate directly to any section via URL, breadcrumb, sidebar, or drawer
**Depends on**: Phase 14
**Requirements**: COPR-03, NAV-01, NAV-02, NAV-03
**Plans**: 2 plans

Plans:
- [x] 15-01: Deep-link section addressing, breadcrumbs, hash scroll polyfill, SW cache update
- [x] 15-02: TOC sidebar (desktop), mobile drawer (Sheet), scrollspy with IntersectionObserver

**What Shipped:**
- Section deep-linking (/cop/8.5.4 redirects to /cop/8#section-8.5.4)
- Hash scroll polyfill (useHashScroll hook) for Next.js App Router
- Hierarchical breadcrumbs (COP > Chapter N: Title)
- Desktop sticky TOC sidebar (w-72, auto-scroll to active)
- Mobile slide-out drawer (Sheet component)
- IntersectionObserver scrollspy with -20% / -75% rootMargin
- Service worker v2 with /cop route and JSON caching

### Phase 16: Supplementary Panels

**Goal**: Supplementary content (3D models, case law, related details) appears inline within COP sections as collapsible panels that are visually distinct from authoritative content
**Depends on**: Phase 14 (reader must render sections), Phase 13 (section-detail links)
**Requirements**: SUPP-01, SUPP-02
**Plans**: 1 plan

Plans:
- [x] 16-01: Collapsible panel components, supplementary data query, full pipeline from page.tsx through SectionRenderer

**What Shipped:**
- Radix Collapsible-based SupplementaryPanel (grey border, collapsed by default)
- SupplementaryDetailCard for linked details (code badge, 3D indicator, source badge)
- getSupplementaryContent database query (2 queries, Map-serialized for client boundary)
- Full pipeline: Server Component query -> ChapterContent -> SectionRenderer -> Panel

### Phase 17: HTG Content Pipeline

**Goal**: HTG installation guides extracted from RANZ PDFs appear as inline supplementary panels within the relevant COP sections
**Depends on**: Phase 16 (supplementary panel infrastructure)
**Requirements**: HTG-01, HTG-02, HTG-03
**Plans**: 2 plans

Plans:
- [x] 17-01: HTG PDF extraction with unpdf, import script, populate htg_content table
- [x] 17-02: HTG-to-COP section mapping script, cop_section_htg population

**What Shipped:**
- 350 HTG records extracted from 5 PDFs (78 flashings, 138 penetrations, 134 cladding)
- unpdf-based extraction with per-page granularity
- 484 HTG-to-COP section mappings
- Two-mode mapping script (--suggest for analysis, --insert for population)
- HTG panels auto-displayed via Phase 16 infrastructure

### Phase 18: Mode Transition and Polish

**Goal**: COP Reader is the primary Planner navigation path and Fixer mode continues unchanged, completing the Digital COP experience
**Depends on**: Phase 15 (navigation), Phase 16 (panels), Phase 17 (HTG)
**Requirements**: MODE-01, MODE-02
**Plans**: 2 plans

Plans:
- [x] 18-01: Navigation link updates (dashboard, sidebar, mobile nav) + SW cache v3
- [x] 18-02: E2E regression tests for mode transition and backward compatibility

**What Shipped:**
- Dashboard Planner card links to /cop with BookOpen icon and chapter messaging
- Sidebar "COP Reader" with path prefix matching for /cop/* routes
- Mobile nav "COP Reader" in slide-out menu
- Service worker v3 (cache refresh for updated navigation)
- 5 E2E regression tests (Planner->COP, legacy /planner, Fixer unchanged, all routes, sidebar)
- All existing routes preserved for backward compatibility

---

## Milestone Summary

**Key Decisions:**
- Hybrid data model: COP hierarchy in PostgreSQL, text content in per-chapter static JSON
- Routes use `/cop/[sectionNumber]` with dot notation (e.g. `/cop/8.5.4`)
- COP Reader is additive — all existing routes remain functional
- Only 4 new npm packages (3 Radix primitives + unpdf for build-time)
- Single [chapterNumber] route handles both chapters and sections by detecting dots
- Collapsible (NOT Accordion) for independent panel state per section
- Map serialization via Object.fromEntries() to cross Server/Client boundary
- Per-page HTG extraction (350 records, not per-PDF bulk)

**Issues Resolved:**
- Source JSON duplicate section 13.1 (auto-skip with warning)
- unpdf Buffer-to-Uint8Array conversion requirement
- unpdf mergePages:false returns array, not string
- Content deduplication via regex stripping in SectionRenderer
- Next.js route conflict for chapters vs sections (single dynamic route)

**Issues Deferred:**
- 667 COP section images pending R2 upload
- Chapter 19 (618 KB) exceeds 200 KB target — consider pagination
- Section-detail linking found zero automatic relationships — manual curation needed
- Pre-existing ESLint warnings in CopImage.tsx, link-cop-section-details.ts, map-htg-to-cop.ts

**Technical Debt Incurred:**
- Unused import warnings in 3 files from Phase 17
- Playwright browser binaries not installed (E2E tests need `npx playwright install`)

---

_For current project status, see .planning/ROADMAP.md_
