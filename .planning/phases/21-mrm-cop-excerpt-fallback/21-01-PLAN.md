---
phase: 21-mrm-cop-excerpt-fallback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/cop-excerpt.ts
  - app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
  - app/(dashboard)/fixer/[detailId]/page.tsx
  - components/details/DetailViewer.tsx
autonomous: true
must_haves:
  truths:
    - "Section-ref step instructions (e.g. '5.1', '5.1A') are parsed into COP section numbers"
    - "COP section content is loaded from public/cop/chapter-N.json for each section number"
    - "Excerpt data (title, truncated content, deep-link URL) is resolved for MRM-only detail steps"
    - "DetailViewer receives COP excerpt data as a prop alongside existing detail data"
  artifacts:
    - path: "lib/cop-excerpt.ts"
      provides: "COP excerpt resolution utility"
      exports: ["resolveCopExcerpts", "CopExcerptData"]
  key_links:
    - from: "lib/cop-excerpt.ts"
      to: "public/cop/chapter-N.json"
      via: "fs.readFileSync + JSON.parse"
      pattern: "readFileSync.*chapter-"
    - from: "app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx"
      to: "lib/cop-excerpt.ts"
      via: "import resolveCopExcerpts"
      pattern: "resolveCopExcerpts"
---

<objective>
Create the COP excerpt resolution utility and wire it into detail page server components so DetailViewer receives COP excerpt data for MRM-only details with section-ref steps.

Purpose: MRM-only details (190 without RANZ match) currently show useless section-reference steps like "5.1" or "5.1A Ridge-Hip Junction". This plan creates the data pipeline to resolve those references into actual COP section content (title + excerpt text + deep-link URL).

Output: `lib/cop-excerpt.ts` utility that parses section-ref instructions, loads chapter JSON, and returns excerpt data. Both planner and fixer detail pages pass this data to DetailViewer as a new `copExcerpts` prop.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-ranz-steps-as-primary/20-01-SUMMARY.md

Key references:
@components/details/DetailViewer.tsx — Has isSectionRefStep() helper (lines 194-212), isRanzStepsPrimary logic
@app/(dashboard)/cop/[chapterNumber]/page.tsx — Shows COP chapter JSON loading pattern and deep-link redirect pattern
@types/cop.ts — CopSection interface with number, title, content, subsections
@app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx — Server component that fetches detail data
@app/(dashboard)/fixer/[detailId]/page.tsx — Fixer detail page (same pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create COP excerpt resolution utility</name>
  <files>lib/cop-excerpt.ts</files>
  <action>
Create `lib/cop-excerpt.ts` with:

1. **Type definition:**
```typescript
export interface CopExcerptData {
  sectionNumber: string;    // e.g. "5.1", "8.5.4"
  title: string;            // Section title from JSON
  excerpt: string;          // First ~200 chars of content, trimmed to sentence boundary
  deepLinkUrl: string;      // e.g. "/cop/5#section-5.1" or "/cop/8#section-8.5.4"
  chapterNumber: number;
  chapterTitle: string;
}
```

2. **`parseSectionNumber(instruction: string): string | null`** — Extracts section number from step instruction text.
   - Match pattern: `/^(\d+(?:\.\d+)*[A-Z]?)/` to extract leading section number
   - Examples: "5.1" -> "5.1", "5.1A Ridge-Hip Junction" -> "5.1A", "ROOF DRAINAGE" -> null
   - Return null if no section number pattern found

3. **`findSectionInChapter(sections: CopSection[], sectionNumber: string): CopSection | null`** — Recursively searches chapter sections/subsections for matching section number.
   - Use existing `CopSection` type from `@/types/cop`
   - Match on `section.number === sectionNumber`
   - Recurse into `section.subsections`

4. **`truncateToSentence(text: string, maxLength: number = 200): string`** — Truncates content to nearest sentence boundary within maxLength.
   - Split on sentence-ending punctuation (`. `, `.\n`)
   - If no sentence boundary found within maxLength, truncate at word boundary and append "..."

5. **`resolveCopExcerpts(steps: Array<{ instruction: string; stepNumber: number }>): CopExcerptData[]`** — Main function.
   - For each step, call `parseSectionNumber(step.instruction)`
   - Skip steps where parseSectionNumber returns null
   - Determine chapter number from section number (first integer before any dot)
   - Load chapter JSON: `fs.readFileSync(path.join(process.cwd(), 'public', 'cop', 'chapter-${chapterNum}.json'), 'utf-8')`
   - Cache loaded chapters in a local Map to avoid re-reading same file
   - Find section in chapter using `findSectionInChapter`
   - If section found, build CopExcerptData with:
     - `deepLinkUrl`: `/cop/${chapterNum}#section-${sectionNumber}`
     - `excerpt`: `truncateToSentence(section.content)`
   - Return array of resolved excerpts (may be fewer than input steps if some don't match)

**Important:** This runs server-side only (uses `fs`). Do NOT add `'use client'` directive.
Follow the same pattern as `app/(dashboard)/cop/[chapterNumber]/page.tsx` for loading chapter JSON.
Handle section numbers with letter suffixes like "5A", "5.1A" — the chapter number is always the leading integer.
  </action>
  <verify>
TypeScript compilation passes: `npx tsc --noEmit lib/cop-excerpt.ts` (or full build check).
Verify the module exports CopExcerptData type and resolveCopExcerpts function.
  </verify>
  <done>
lib/cop-excerpt.ts exists with resolveCopExcerpts function that parses section-ref instructions, loads COP chapter JSON, and returns excerpt data with title, truncated content, and deep-link URL.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire COP excerpts into detail pages and DetailViewer</name>
  <files>
    app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
    app/(dashboard)/fixer/[detailId]/page.tsx
    components/details/DetailViewer.tsx
  </files>
  <action>
**In both planner and fixer detail pages** (server components):

1. Import `resolveCopExcerpts` from `@/lib/cop-excerpt`
2. After fetching detail data, check if the detail has steps that are section-refs (reuse the same heuristic as `isSectionRefStep` in DetailViewer.tsx):
   - If detail has steps AND is NOT RANZ-linked (no `supplements` with steps), call `resolveCopExcerpts(detail.steps)`
   - Pass the result as `copExcerpts` prop to `<DetailViewer />`
3. Only resolve excerpts for MRM-only details (those without RANZ linked guide steps). The `isRanzStepsPrimary` logic in DetailViewer already handles the RANZ case.

**In `components/details/DetailViewer.tsx`:**

1. Add `copExcerpts` to `DetailViewerProps`:
```typescript
import type { CopExcerptData } from '@/lib/cop-excerpt';

interface DetailViewerProps {
  detail: DetailWithRelations;
  stageMetadata?: DetailStageMetadata | null;
  copExcerpts?: CopExcerptData[];
  isLoading?: boolean;
  showBreadcrumb?: boolean;
}
```

2. Destructure `copExcerpts` from props in the component function signature.

3. Add a computed flag: `const hasCopExcerpts = (copExcerpts?.length ?? 0) > 0 && ownStepsAreSectionRefs && !isRanzStepsPrimary;`
   - This ensures COP excerpts only show when: detail has section-ref steps, no RANZ steps override, and excerpts were resolved.

No UI rendering changes in this plan — Plan 02 handles the UI display. This plan just gets the data flowing through.
  </action>
  <verify>
`npm run build` passes without errors. Check that both planner and fixer detail pages import and call resolveCopExcerpts. Check that DetailViewer accepts the new copExcerpts prop.
  </verify>
  <done>
Both detail page server components resolve COP excerpts for MRM-only details and pass them to DetailViewer. DetailViewer accepts copExcerpts prop and computes hasCopExcerpts flag. Build passes.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run build` passes without errors
2. `lib/cop-excerpt.ts` exports `resolveCopExcerpts` and `CopExcerptData`
3. Both planner and fixer detail page server components call `resolveCopExcerpts` for details with section-ref steps
4. `DetailViewer` component accepts `copExcerpts` prop of type `CopExcerptData[]`
</verification>

<success_criteria>
- COP excerpt resolution utility exists and handles section number parsing, chapter JSON loading, and excerpt truncation
- Detail page server components resolve COP excerpts and pass to DetailViewer
- No existing functionality broken (RANZ steps primary logic, 3D sync, etc.)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/21-mrm-cop-excerpt-fallback/21-01-SUMMARY.md`
</output>
