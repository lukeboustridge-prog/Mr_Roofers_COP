---
phase: 21-mrm-cop-excerpt-fallback
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - components/details/DetailViewer.tsx
  - components/details/CopExcerptFallback.tsx
autonomous: true
must_haves:
  truths:
    - "MRM-only detail pages show COP section excerpts instead of bare section-ref steps"
    - "Each COP excerpt displays section title, truncated content text, and chapter attribution"
    - "Each COP excerpt has a deep-link button that navigates to the full COP Reader section"
    - "Section-reference steps are not visible as installation steps on any detail page"
    - "Roofer on an MRM-only detail page sees actionable content (excerpt text + link) not just a reference code"
  artifacts:
    - path: "components/details/CopExcerptFallback.tsx"
      provides: "COP excerpt inline display component with deep-links"
      exports: ["CopExcerptFallback"]
  key_links:
    - from: "components/details/CopExcerptFallback.tsx"
      to: "/cop/{chapterNumber}#section-{sectionNumber}"
      via: "Next.js Link component"
      pattern: "href.*cop.*section-"
    - from: "components/details/DetailViewer.tsx"
      to: "components/details/CopExcerptFallback.tsx"
      via: "import CopExcerptFallback"
      pattern: "CopExcerptFallback"
---

<objective>
Create the COP excerpt fallback UI component and integrate it into DetailViewer so MRM-only details display inline COP section excerpts with deep-links instead of bare section-reference steps.

Purpose: Roofers on MRM-only detail pages currently see useless steps like "5.1" or "ROOF DRAINAGE". After this plan, they'll see actual COP content excerpts with a button to read the full section in the COP Reader.

Output: `CopExcerptFallback` component renders COP excerpts inline. DetailViewer shows this component instead of the Installation tab when detail has section-ref steps and COP excerpts are available.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-mrm-cop-excerpt-fallback/21-01-SUMMARY.md

Key references:
@components/details/DetailViewer.tsx — Has copExcerpts prop (from Plan 01), hasCopExcerpts flag, Installation tab rendering
@components/details/StepByStep.tsx — Existing step display component (for reference on styling patterns)
@lib/cop-excerpt.ts — CopExcerptData type (from Plan 01)
@components/ui/card.tsx — Card, CardContent, CardHeader, CardTitle
@components/ui/button.tsx — Button component
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CopExcerptFallback component</name>
  <files>components/details/CopExcerptFallback.tsx</files>
  <action>
Create `components/details/CopExcerptFallback.tsx` as a client component (`'use client'`):

1. **Props interface:**
```typescript
import type { CopExcerptData } from '@/lib/cop-excerpt';

interface CopExcerptFallbackProps {
  excerpts: CopExcerptData[];
  className?: string;
}
```

2. **Component structure** — renders as a Card (matching StepByStep visual pattern):

```
<Card>
  <CardHeader>
    <CardTitle with BookOpen icon>
      "COP Reference Sections"
    </CardTitle>
    <CardDescription>
      "This detail references the following Code of Practice sections"
    </CardDescription>
  </CardHeader>
  <CardContent>
    {excerpts.map(excerpt => (
      <ExcerptCard key={excerpt.sectionNumber} excerpt={excerpt} />
    ))}
  </CardContent>
</Card>
```

3. **ExcerptCard sub-component** — each excerpt displayed as:
```
<div className="rounded-lg border bg-white p-4 space-y-2">
  {/* Section header */}
  <div className="flex items-start justify-between gap-3">
    <div>
      <Badge variant="outline" className="font-mono mb-1">
        Section {excerpt.sectionNumber}
      </Badge>
      <h4 className="font-medium text-slate-900">{excerpt.title}</h4>
      <p className="text-xs text-slate-500">Chapter {excerpt.chapterNumber}: {excerpt.chapterTitle}</p>
    </div>
  </div>

  {/* Excerpt text */}
  <p className="text-sm text-slate-600 leading-relaxed">
    {excerpt.excerpt}
  </p>

  {/* Deep-link button */}
  <Link href={excerpt.deepLinkUrl}>
    <Button variant="outline" size="sm" className="mt-2">
      <BookOpen className="h-4 w-4 mr-2" />
      Read full section in COP
      <ArrowUpRight className="h-3 w-3 ml-1" />
    </Button>
  </Link>
</div>
```

4. **Styling notes:**
   - Use `space-y-3` between excerpt cards
   - Use `BookOpen` icon from lucide-react for the card title (matches COP Reader pattern)
   - Use `ArrowUpRight` icon for the deep-link button (matches existing external link pattern in DetailViewer)
   - Badge for section number uses `font-mono` (matches existing detail code badge pattern)
   - Content text uses `text-sm text-slate-600` (matches existing content text styling)

5. **Empty state:** If `excerpts` array is empty, return null (DetailViewer handles fallback).

Import from: `lucide-react` (BookOpen, ArrowUpRight), `@/components/ui/card`, `@/components/ui/button`, `@/components/ui/badge`, `next/link`, `@/lib/utils` (cn).
  </action>
  <verify>
TypeScript compilation passes. Component file exists and exports CopExcerptFallback.
  </verify>
  <done>
CopExcerptFallback component renders COP section excerpts with section number badge, title, excerpt text, chapter attribution, and deep-link button to COP Reader.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate CopExcerptFallback into DetailViewer</name>
  <files>components/details/DetailViewer.tsx</files>
  <action>
Update DetailViewer.tsx to use CopExcerptFallback instead of the Installation tab when COP excerpts are available:

1. **Import CopExcerptFallback:**
```typescript
import { CopExcerptFallback } from './CopExcerptFallback';
```

2. **Replace Installation tab content for section-ref details:**

Currently the Installation tab (lines 669-691) shows `<StepByStep>` for ALL details with steps. Modify this logic:

- When `hasCopExcerpts` is true (MRM-only detail with section-ref steps and resolved excerpts):
  - Change the Installation tab label to "COP References" with BookOpen icon instead of Wrench icon
  - Show `<CopExcerptFallback excerpts={copExcerpts!} />` instead of `<StepByStep>`
  - Update the badge count to show number of COP excerpts

- When `hasCopExcerpts` is false:
  - Keep existing `<StepByStep>` rendering unchanged

3. **Filter out section-ref steps from display when COP excerpts available:**

The `displaySteps` variable (line 224-228) currently includes all steps. When `hasCopExcerpts` is true, the steps shown in the Installation tab are replaced entirely by COP excerpts, so no filtering of displaySteps is needed — we just render a different component.

4. **Specific code change in the Tabs section:**

Replace the Installation tab trigger (around line 560-570):
```tsx
{/* Show COP References tab when excerpts available, otherwise Installation tab */}
{hasCopExcerpts ? (
  <TabsTrigger value="installation" className="...">
    <BookOpen className="h-4 w-4 mr-2" />
    COP References
    <Badge variant="secondary" className="ml-2 text-xs">
      {copExcerpts!.length}
    </Badge>
  </TabsTrigger>
) : steps.length > 0 ? (
  <TabsTrigger value="installation" className="...">
    <Wrench className="h-4 w-4 mr-2" />
    Installation
    <Badge variant="secondary" className="ml-2 text-xs">
      {steps.length}
    </Badge>
  </TabsTrigger>
) : null}
```

Replace the Installation tab content (around line 669-691):
```tsx
{(hasCopExcerpts || steps.length > 0) && (
  <TabsContent value="installation" className="mt-6">
    {hasCopExcerpts ? (
      <CopExcerptFallback excerpts={copExcerpts!} />
    ) : (
      <>
        {areStepsBorrowed && linkedGuideWithSteps && (
          <div className="mb-4 p-3 bg-slate-50 border border-slate-200 rounded-lg">
            <SourceAttribution ... />
          </div>
        )}
        <ContentWrapper>
          <StepByStep ... />
        </ContentWrapper>
      </>
    )}
  </TabsContent>
)}
```

5. **Ensure BookOpen is already imported** — it is (line 13), so no new import needed for the icon.

6. **Do NOT remove the `isSectionRefStep` helper** — it's still used for `ownStepsAreSectionRefs` and `isRanzStepsPrimary` logic, and will be used by hasCopExcerpts.
  </action>
  <verify>
`npm run build` passes. On an MRM-only detail page with section-ref steps:
- Tab label shows "COP References" with BookOpen icon
- Tab content shows CopExcerptFallback with excerpt cards
- Deep-link buttons point to correct COP Reader URLs (e.g., /cop/5#section-5.1)
- On RANZ-matched details, Installation tab still shows RANZ steps as before
- On details with real installation steps (not section-refs), Installation tab works normally
  </verify>
  <done>
DetailViewer shows CopExcerptFallback with COP section excerpts and deep-links on MRM-only details instead of bare section-reference steps. RANZ-matched details and real installation steps are unaffected.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. MRM-only detail pages show "COP References" tab with excerpt cards instead of bare section-ref steps
3. Each excerpt card shows: section number badge, title, excerpt text, chapter attribution, deep-link button
4. Deep-link buttons navigate to correct COP Reader sections (e.g., /cop/5#section-5.1)
5. RANZ-matched details (61 pages) still show RANZ installation steps as primary
6. Details with real installation steps (non-section-refs) show normal Installation tab
7. No section-reference steps visible as bare step items on any detail page
</verification>

<success_criteria>
- Roofer on an MRM-only detail page sees COP section title, excerpt text, and a link to the full COP section
- No bare section numbers ("5.1", "5.1A") shown as installation steps
- Deep-link buttons work and navigate to the COP Reader at the correct section
- All 251 detail pages render correctly (61 RANZ-matched + 190 MRM-only)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/21-mrm-cop-excerpt-fallback/21-02-SUMMARY.md`
</output>
