---
phase: 15-navigation-chrome
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - components/cop/use-scrollspy.ts
  - components/cop/TOCTree.tsx
  - components/cop/ChapterContent.tsx
  - app/(dashboard)/cop/[chapterNumber]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Desktop users see a collapsible TOC sidebar listing all sections in the chapter"
    - "Mobile users see a floating button that opens a slide-out drawer with the TOC"
    - "As the user scrolls through chapter content, the TOC highlights the currently visible section"
    - "Clicking a TOC item scrolls the page to that section"
    - "The TOC sidebar auto-scrolls to keep the highlighted item visible"
  artifacts:
    - path: "components/cop/use-scrollspy.ts"
      provides: "IntersectionObserver-based scrollspy hook"
      contains: "IntersectionObserver"
    - path: "components/cop/TOCTree.tsx"
      provides: "Recursive TOC tree with active section highlighting"
      contains: "TOCTree"
    - path: "components/cop/ChapterContent.tsx"
      provides: "Client component wrapper with TOC sidebar, drawer, scrollspy, and hash scroll"
      contains: "useScrollspy"
    - path: "app/(dashboard)/cop/[chapterNumber]/page.tsx"
      provides: "Server component passing chapter data to ChapterContent client wrapper"
      contains: "ChapterContent"
  key_links:
    - from: "components/cop/use-scrollspy.ts"
      to: "DOM section elements"
      via: "IntersectionObserver observing section-* IDs"
      pattern: "getElementById"
    - from: "components/cop/TOCTree.tsx"
      to: "components/cop/use-scrollspy.ts"
      via: "activeId prop from scrollspy hook"
      pattern: "activeId"
    - from: "components/cop/ChapterContent.tsx"
      to: "components/cop/use-hash-scroll.ts"
      via: "useHashScroll() for scroll-to-section on navigation"
      pattern: "useHashScroll"
    - from: "components/cop/ChapterContent.tsx"
      to: "components/ui/sheet.tsx"
      via: "Sheet component for mobile drawer"
      pattern: "Sheet"
---

<objective>
Create the TOC sidebar (desktop), mobile drawer, and scrollspy highlighting so users can orient themselves within COP chapter content and navigate to any section.

Purpose: Users on desktop see a persistent sidebar showing the chapter structure with the current section highlighted as they scroll (NAV-02, NAV-03). Mobile users access the same TOC via a slide-out drawer.
Output: useScrollspy hook, TOCTree component, ChapterContent client wrapper with sidebar/drawer layout.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-navigation-chrome/15-RESEARCH.md
@.planning/phases/15-navigation-chrome/15-01-SUMMARY.md

Key existing files:
@types/cop.ts
@components/cop/SectionRenderer.tsx
@components/cop/use-hash-scroll.ts
@components/cop/Breadcrumbs.tsx
@components/ui/sheet.tsx
@app/(dashboard)/cop/[chapterNumber]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scrollspy hook and TOCTree component</name>
  <files>
    components/cop/use-scrollspy.ts
    components/cop/TOCTree.tsx
  </files>
  <action>
    **1. Create scrollspy hook** at `components/cop/use-scrollspy.ts`:
    - 'use client' directive
    - Export `useScrollspy(sectionIds: string[]): string` hook returning the active section ID
    - Use `IntersectionObserver` with `rootMargin: '-20% 0px -75% 0px'` (triggers when section is in top 20% of viewport -- slightly tighter than research suggestion for better accuracy)
    - `threshold: 0` (fire as soon as section crosses boundary)
    - Track intersecting sections in a `Set<string>` (use `useRef` to avoid re-renders)
    - On intersection changes, find the TOPMOST intersecting section by matching against `sectionIds` array order (DOM order) and call `setActiveId`
    - Observe all elements matching the provided IDs using `document.getElementById`
    - Cleanup: disconnect observer on unmount, clear the Set
    - Handle edge case: if no sections are intersecting, keep the last known activeId (don't clear it)
    - Memoize: Use `useRef` for the observer to avoid recreating on every render. Only recreate when `sectionIds` array changes (compare by JSON.stringify or length)

    **2. Create TOCTree component** at `components/cop/TOCTree.tsx`:
    - 'use client' directive
    - Props: `{ sections: CopSection[], chapterNumber: number, activeId: string, level?: number, onItemClick?: () => void }`
    - The `onItemClick` callback is called when a TOC item is clicked (used to close mobile drawer)
    - Recursive rendering: each section renders as a list item, subsections render nested `<TOCTree>`
    - Active highlighting: if `activeId === \`section-${section.number}\``, apply active styles (bg-primary/10 text-primary font-semibold border-l-2 border-primary)
    - Inactive styles: text-slate-600 hover:text-slate-900 hover:bg-slate-50
    - Each item is a `<a href={\`#section-${section.number}\`}>` (hash link for same-page scroll, NOT a Next.js Link since we want hash-only navigation)
    - onClick handler: call `onItemClick?.()` after click (to close mobile drawer)
    - Auto-scroll active item into view: use `useEffect` + `useRef` on the active item, call `scrollIntoView({ behavior: 'smooth', block: 'nearest' })` when activeId changes
    - Indentation: `ml-3` per nesting level (level 0 = no indent, level 1 = ml-3, etc.)
    - Text size: `text-sm` for all levels, but `text-xs` for level 3+
    - Section number displayed as subtle prefix: `<span className="text-slate-400 mr-1.5 tabular-nums">{section.number}</span>`
    - Title truncated with `truncate` class to prevent overflow in narrow sidebar
    - Imports: `CopSection` from `@/types/cop`, `cn` from `@/lib/utils`, `useEffect`, `useRef` from React
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Verify `use-scrollspy.ts` creates IntersectionObserver with correct rootMargin
    - Verify `TOCTree.tsx` renders recursive list with active highlighting
    - Verify observer disconnect in cleanup
  </verify>
  <done>
    - useScrollspy hook tracks active section via IntersectionObserver
    - TOCTree renders recursive section list with active highlighting and auto-scroll
    - Both components are client-side ('use client')
  </done>
</task>

<task type="auto">
  <name>Task 2: ChapterContent client wrapper with sidebar, drawer, and page integration</name>
  <files>
    components/cop/ChapterContent.tsx
    app/(dashboard)/cop/[chapterNumber]/page.tsx
  </files>
  <action>
    **1. Create ChapterContent client wrapper** at `components/cop/ChapterContent.tsx`:
    - 'use client' directive
    - This component wraps the chapter content with TOC sidebar (desktop) and drawer (mobile)
    - Props: `{ chapterData: CopChapter }` -- receives full chapter data from the Server Component parent
    - Inside, it:
      a. Collects all section IDs by flattening the section tree recursively into an array of `section-${number}` strings (depth-first, matching DOM order)
      b. Calls `useScrollspy(sectionIds)` to get `activeId`
      c. Calls `useHashScroll()` from `@/components/cop/use-hash-scroll` for hash navigation polyfill
      d. Manages mobile drawer open/close state with `useState`

    **Helper function** `flattenSectionIds(sections: CopSection[]): string[]`:
    ```typescript
    function flattenSectionIds(sections: CopSection[]): string[] {
      const ids: string[] = [];
      for (const section of sections) {
        ids.push(`section-${section.number}`);
        if (section.subsections) {
          ids.push(...flattenSectionIds(section.subsections));
        }
      }
      return ids;
    }
    ```
    Memoize with `useMemo` to avoid recalculating on every render.

    **Layout structure:**
    ```tsx
    <div className="flex gap-0">
      {/* Desktop TOC sidebar -- hidden on mobile */}
      <aside className="hidden lg:block w-72 shrink-0 sticky top-0 h-screen overflow-y-auto border-r border-slate-200 py-4 px-3">
        <h2 className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3 px-2">Contents</h2>
        <TOCTree
          sections={chapterData.sections}
          chapterNumber={chapterData.chapterNumber}
          activeId={activeId}
        />
      </aside>

      {/* Main content area */}
      <div className="flex-1 min-w-0">
        {/* Mobile TOC trigger -- visible on mobile/tablet only */}
        <div className="lg:hidden sticky top-0 z-10 bg-white/95 backdrop-blur border-b border-slate-200 px-4 py-2">
          <Sheet open={drawerOpen} onOpenChange={setDrawerOpen}>
            <SheetTrigger asChild>
              <button className="flex items-center gap-2 text-sm text-slate-600 hover:text-slate-900 py-1">
                <List className="h-4 w-4" />
                <span>Contents</span>
              </button>
            </SheetTrigger>
            <SheetContent side="left" className="w-80 p-0">
              <div className="p-4 border-b border-slate-200">
                <h2 className="text-sm font-semibold text-slate-900">
                  Chapter {chapterData.chapterNumber}: {chapterData.title}
                </h2>
              </div>
              <div className="overflow-y-auto h-[calc(100vh-65px)] py-3 px-3">
                <TOCTree
                  sections={chapterData.sections}
                  chapterNumber={chapterData.chapterNumber}
                  activeId={activeId}
                  onItemClick={() => setDrawerOpen(false)}
                />
              </div>
            </SheetContent>
          </Sheet>
        </div>

        {/* Breadcrumbs */}
        <Breadcrumbs chapterData={chapterData} />

        {/* Chapter header */}
        <div className="mb-8">
          <h1 ...>Chapter {N}: {title}</h1>
          <Badge + section count ...>
        </div>

        <hr ... />

        {/* Chapter content -- SectionRenderer for each root section */}
        <div id="chapter-content" className="mt-8">
          {chapterData.sections.map(section => (
            <SectionRenderer key={section.number} section={section} chapterNumber={chapterData.chapterNumber} />
          ))}
        </div>

        {/* Scroll to top */}
        <div className="mt-12 mb-8 text-center">
          <a href="#" className="text-sm text-slate-400 hover:text-slate-600">Back to top</a>
        </div>
      </div>
    </div>
    ```

    Import: `Sheet, SheetContent, SheetTrigger` from `@/components/ui/sheet`, `List` from `lucide-react`, `TOCTree` from `./TOCTree`, `SectionRenderer` from `./SectionRenderer`, `Breadcrumbs` from `./Breadcrumbs`, `useScrollspy` from `./use-scrollspy`, `useHashScroll` from `./use-hash-scroll`, `Badge` from `@/components/ui/badge`, `CopChapter, CopSection` from `@/types/cop`.

    **2. Refactor chapter page** at `app/(dashboard)/cop/[chapterNumber]/page.tsx`:
    - The page remains a Server Component (reads JSON from filesystem)
    - Remove ALL rendering JSX below the redirect/validation logic
    - Remove imports for: ArrowLeft, Badge, Link (for "Back to COP"), SectionRenderer, Breadcrumbs (these move into ChapterContent)
    - KEEP: fs, path, notFound, redirect imports, CopChapter/CopSection type imports, findSection function
    - ADD: import `ChapterContent` from `@/components/cop/ChapterContent`
    - ADD: import `Link` from `next/link` (still needed for Back to COP link which stays in the server component)
    - ADD: import `ArrowLeft` from `lucide-react` (still needed for Back link)

    The page now renders:
    ```tsx
    return (
      <div className="flex flex-col">
        {/* Back navigation -- stays in server component */}
        <div className="px-4 pt-4 md:px-6 lg:px-8">
          <Link
            href="/cop"
            className="text-sm text-slate-500 hover:text-slate-700 flex items-center gap-1 mb-4"
          >
            <ArrowLeft className="h-4 w-4" />
            Back to COP
          </Link>
        </div>

        {/* Client component handles TOC sidebar, drawer, scrollspy, content rendering */}
        <ChapterContent chapterData={chapterData} />
      </div>
    );
    ```

    The ChapterContent client component receives the full `chapterData` object and handles all interactive elements (sidebar, drawer, scrollspy, hash scroll).

    IMPORTANT: The `container max-w-4xl` class from the old page should move to the main content column inside ChapterContent (NOT the outer flex wrapper, since the sidebar sits outside the content area). Apply `container max-w-4xl p-4 md:p-6 lg:p-8` to the main content inner div.

    IMPORTANT: The Breadcrumbs component is imported as a Server Component, but since it is rendered inside a Client Component (ChapterContent), React will treat it as a Client Component. This is fine -- Breadcrumbs has no server-only dependencies (no fs, no database calls). It uses only Link, cn, and lucide-react icons, all of which work client-side. Verify Breadcrumbs does not use 'use server' or server-only imports.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Verify `ChapterContent.tsx` imports and uses `useScrollspy`, `useHashScroll`, `Sheet`, `TOCTree`
    - Verify `app/(dashboard)/cop/[chapterNumber]/page.tsx` passes `chapterData` to `ChapterContent` and is still a Server Component (no 'use client')
    - Verify sidebar is `hidden lg:block` and drawer trigger is `lg:hidden`
    - Verify flattenSectionIds produces correct DOM-order array
  </verify>
  <done>
    - Desktop: TOC sidebar visible on lg+ breakpoint with scrollspy highlighting
    - Mobile/tablet: "Contents" button opens Sheet drawer with full TOC
    - Clicking TOC item scrolls to section (hash navigation) and closes mobile drawer
    - Scrollspy highlights currently visible section in TOC
    - TOC auto-scrolls to keep active item visible
    - Chapter page remains a Server Component, ChapterContent is the client boundary
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Desktop: Open /cop/8 in browser at lg+ width -- TOC sidebar visible on left with full section tree
3. Scroll through chapter content -- TOC highlights the currently visible section
4. Click a TOC item -- page scrolls to that section
5. Mobile: Open /cop/8 at mobile width -- "Contents" button visible, tap opens drawer
6. Drawer shows same TOC tree, tap item scrolls to section and closes drawer
7. Navigate to /cop/8.5.4 -- redirects to /cop/8, scrolls to section 8.5.4 (deep-link + hash scroll working together)
</verification>

<success_criteria>
- NAV-02 satisfied: Desktop shows collapsible TOC sidebar, mobile shows slide-out drawer
- NAV-03 satisfied: Scrollspy highlights currently visible section as user scrolls
- NAV-01 fully satisfied with breadcrumbs from Plan 01 and TOC navigation from this plan
- All Phase 15 success criteria met (deep-linking, breadcrumbs, sidebar/drawer, scrollspy, SW cache)
</success_criteria>

<output>
After completion, create `.planning/phases/15-navigation-chrome/15-02-SUMMARY.md`
</output>
