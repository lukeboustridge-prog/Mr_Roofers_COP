---
phase: 15-navigation-chrome
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(dashboard)/cop/[sectionNumber]/page.tsx
  - components/cop/use-hash-scroll.ts
  - components/cop/Breadcrumbs.tsx
  - app/(dashboard)/cop/[chapterNumber]/page.tsx
  - public/sw.js
autonomous: true

must_haves:
  truths:
    - "User navigates to /cop/8.5.4 and is redirected to /cop/8#section-8.5.4"
    - "Invalid section numbers (e.g. /cop/99.9) return 404"
    - "Breadcrumb trail shows full hierarchy (COP > Chapter 8 > 8.5 Title > 8.5.4 Title) with each level tappable"
    - "Hash scroll works on both hard navigation and client-side Link navigation"
    - "Service worker CACHE_VERSION is v2 and /cop route is in STATIC_ASSETS"
  artifacts:
    - path: "app/(dashboard)/cop/[sectionNumber]/page.tsx"
      provides: "Deep-link redirect route"
      contains: "redirect"
    - path: "components/cop/use-hash-scroll.ts"
      provides: "Hash scroll polyfill for Next.js App Router"
      contains: "scrollIntoView"
    - path: "components/cop/Breadcrumbs.tsx"
      provides: "Hierarchy breadcrumb trail"
      contains: "buildBreadcrumbs"
    - path: "public/sw.js"
      provides: "Updated service worker with v2 cache"
      contains: "CACHE_VERSION = 'v2'"
  key_links:
    - from: "app/(dashboard)/cop/[sectionNumber]/page.tsx"
      to: "public/cop/chapter-*.json"
      via: "fs.readFileSync to validate section exists"
      pattern: "fs\\.readFileSync"
    - from: "components/cop/Breadcrumbs.tsx"
      to: "types/cop.ts"
      via: "CopSection type for hierarchy traversal"
      pattern: "CopSection"
    - from: "app/(dashboard)/cop/[chapterNumber]/page.tsx"
      to: "components/cop/Breadcrumbs.tsx"
      via: "import and render breadcrumbs above chapter header"
      pattern: "Breadcrumbs"
---

<objective>
Create the deep-link section addressing route, breadcrumb navigation, hash scroll polyfill, and service worker cache update for COP chapter navigation.

Purpose: Users can navigate directly to any COP section via URL (COPR-03), see where they are in the hierarchy (NAV-01), and have correct offline caching for new routes.
Output: Deep-link route at /cop/[sectionNumber], Breadcrumbs component, useHashScroll hook, updated service worker.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-navigation-chrome/15-RESEARCH.md

Key existing files:
@types/cop.ts
@components/cop/SectionRenderer.tsx
@app/(dashboard)/cop/[chapterNumber]/page.tsx
@public/sw.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deep-link route, hash scroll hook, and service worker update</name>
  <files>
    app/(dashboard)/cop/[sectionNumber]/page.tsx
    components/cop/use-hash-scroll.ts
    public/sw.js
  </files>
  <action>
    **1. Create deep-link route** at `app/(dashboard)/cop/[sectionNumber]/page.tsx`:
    - Server Component that handles URLs like `/cop/8.5.4`
    - Parse `sectionNumber` param (await params -- Next.js 14 async pattern)
    - Extract chapter number from first part of dot-separated number (e.g., "8.5.4" -> chapter 8)
    - Validate chapter number is 1-19 integer, else `notFound()`
    - Read chapter JSON from `public/cop/chapter-{N}.json` using `fs.readFileSync` (same pattern as existing chapter page)
    - Walk section hierarchy recursively to verify the section number exists (recursive `findSection` that checks `section.number` and traverses `subsections`)
    - If section not found, `notFound()`
    - If found, `redirect(`/cop/${chapterNumber}#section-${sectionNumber}`)` from `next/navigation`
    - Import types from `@/types/cop` (CopChapter, CopSection)

    IMPORTANT: The `[sectionNumber]` route param will contain dots (e.g., "8.5.4"). Next.js App Router handles this correctly -- dots are valid in dynamic route segments. However, this route MUST NOT conflict with `[chapterNumber]`. Since chapter numbers are plain integers (1-19) and section numbers contain dots, the `[chapterNumber]` route will match first for plain integers. For dot-containing params, we need to handle this differently.

    SOLUTION: Instead of a separate `[sectionNumber]` folder (which would conflict with `[chapterNumber]` since both are catch-all dynamic segments), modify the existing `[chapterNumber]/page.tsx` to detect dot-containing params and redirect. BUT wait -- the research says to create a separate route. The issue is Next.js can only have ONE dynamic segment at the same path level. So we need a DIFFERENT approach:

    Create the route at `app/(dashboard)/cop/[sectionNumber]/page.tsx` BUT recognize that Next.js will try to match ANY `/cop/X` to BOTH routes. Since we cannot have two dynamic segments at the same level, instead:

    **Modify `app/(dashboard)/cop/[chapterNumber]/page.tsx`** to handle BOTH cases:
    - If `chapterNumber` param contains a dot (e.g., "8.5.4"), treat it as a section number and redirect to chapter page with hash
    - If `chapterNumber` param is a plain integer (1-19), render the chapter as before
    - This avoids route conflicts entirely

    So: Do NOT create `app/(dashboard)/cop/[sectionNumber]/page.tsx`. Instead, update the existing `[chapterNumber]/page.tsx` to detect section numbers (contains dots) and redirect.

    Add to the top of the existing `ChapterPage` component, BEFORE the existing chapter number validation:
    ```typescript
    // Handle section deep-links (e.g., /cop/8.5.4 -> redirect to /cop/8#section-8.5.4)
    if (chapterNumber.includes('.')) {
      const parts = chapterNumber.split('.');
      const chapterNum = parseInt(parts[0], 10);
      if (isNaN(chapterNum) || chapterNum < 1 || chapterNum > 19) {
        notFound();
      }
      // Verify chapter file exists
      const chapterPath = path.join(process.cwd(), 'public', 'cop', `chapter-${chapterNum}.json`);
      if (!fs.existsSync(chapterPath)) {
        notFound();
      }
      // Verify section exists in chapter data
      const chapterData: CopChapter = JSON.parse(fs.readFileSync(chapterPath, 'utf-8'));
      const sectionExists = findSection(chapterData.sections, chapterNumber);
      if (!sectionExists) {
        notFound();
      }
      redirect(`/cop/${chapterNum}#section-${chapterNumber}`);
    }
    ```

    Add the `findSection` helper function at the bottom of the file:
    ```typescript
    function findSection(sections: CopSection[], targetNumber: string): boolean {
      for (const section of sections) {
        if (section.number === targetNumber) return true;
        if (section.subsections) {
          if (findSection(section.subsections, targetNumber)) return true;
        }
      }
      return false;
    }
    ```

    Add `redirect` to the `next/navigation` import. Add `CopSection` to the `@/types/cop` import.

    **2. Create hash scroll polyfill** at `components/cop/use-hash-scroll.ts`:
    - 'use client' directive at top
    - Custom hook `useHashScroll()` that:
      - Uses `usePathname()` from `next/navigation`
      - On mount and pathname change, checks `window.location.hash`
      - If hash exists, finds element by ID (`hash.replace('#', '')`)
      - Uses `setTimeout(() => element.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100)` to delay for DOM readiness
      - Also listens for `hashchange` event for same-page navigation
      - Cleanup: removes hashchange listener on unmount
    - Export the hook

    **3. Update service worker** in `public/sw.js`:
    - Change `CACHE_VERSION` from `'v1'` to `'v2'`
    - Add `'/cop'` to the `STATIC_ASSETS` array (the COP grid index page)
    - The `/cop/[chapterNumber]` pages will be dynamically cached by `networkFirstWithOfflineFallback` (HTML pages strategy) -- no additional changes needed for those
    - Chapter JSON files (`/cop/chapter-*.json`) will be cached by `cacheFirstStrategy` when they match the static asset extension pattern -- BUT `.json` is not in the current regex. Add `json` to the static asset extension match: change `\.(js|css|woff|woff2|png|jpg|jpeg|svg|ico|glb)$` to `\.(js|css|woff|woff2|png|jpg|jpeg|svg|ico|glb|json)$`
  </action>
  <verify>
    - `npx tsc --noEmit` passes (TypeScript compilation)
    - Manually verify: `app/(dashboard)/cop/[chapterNumber]/page.tsx` contains `redirect` import and `findSection` function
    - Verify `components/cop/use-hash-scroll.ts` exports `useHashScroll`
    - Verify `public/sw.js` has `CACHE_VERSION = 'v2'` and `/cop` in STATIC_ASSETS and `json` in asset extension regex
  </verify>
  <done>
    - /cop/8.5.4 redirects to /cop/8#section-8.5.4 (section deep-linking works)
    - /cop/99.9 returns 404 (invalid chapter)
    - /cop/8.99.99 returns 404 (invalid section)
    - Hash scroll hook exists and handles both mount and hashchange events
    - Service worker caches /cop route and JSON files for offline use
  </done>
</task>

<task type="auto">
  <name>Task 2: Breadcrumb component and chapter page integration</name>
  <files>
    components/cop/Breadcrumbs.tsx
    app/(dashboard)/cop/[chapterNumber]/page.tsx
  </files>
  <action>
    **1. Create Breadcrumbs component** at `components/cop/Breadcrumbs.tsx`:
    - Server Component (no 'use client' needed -- breadcrumbs are static based on chapter data)
    - Props: `{ chapterData: CopChapter, currentSection?: string }` where currentSection is the section number being viewed (optional, used when navigating to a specific section via hash)
    - For the chapter page (no specific section), breadcrumbs are: COP > Chapter {N}: {title}
    - For a section deep-link, breadcrumbs show full hierarchy: COP > Chapter {N} > {parent sections...} > Current Section

    Build breadcrumbs with a `buildBreadcrumbs` function:
    ```typescript
    interface BreadcrumbItem {
      label: string;
      href: string;
      current?: boolean;
    }

    function buildBreadcrumbs(chapterData: CopChapter, currentSection?: string): BreadcrumbItem[] {
      const crumbs: BreadcrumbItem[] = [
        { label: 'COP', href: '/cop' }
      ];

      if (!currentSection) {
        // Chapter-level page -- chapter is the current item
        crumbs.push({
          label: `Chapter ${chapterData.chapterNumber}: ${chapterData.title}`,
          href: `/cop/${chapterData.chapterNumber}`,
          current: true
        });
        return crumbs;
      }

      // Section deep-link -- walk hierarchy
      crumbs.push({
        label: `Chapter ${chapterData.chapterNumber}`,
        href: `/cop/${chapterData.chapterNumber}`
      });

      const parts = currentSection.split('.');
      // Build intermediate breadcrumbs by walking the section tree
      let currentSections = chapterData.sections;
      for (let i = 1; i < parts.length; i++) {
        const num = parts.slice(0, i + 1).join('.');
        const found = currentSections.find(s => s.number === num);
        if (found) {
          const isLast = i === parts.length - 1;
          crumbs.push({
            label: `${found.number} ${found.title}`,
            href: `/cop/${found.number}`,
            current: isLast
          });
          currentSections = found.subsections || [];
        }
      }

      return crumbs;
    }
    ```

    Render breadcrumbs as a `<nav aria-label="Breadcrumb">` with an `<ol>` list:
    - Each item is an `<li>` containing a `<Link>` (from `next/link`) except the `current` item which is a `<span>` with `aria-current="page"`
    - Separator: ChevronRight icon (from lucide-react, h-3 w-3, text-slate-400) between items
    - Styling: text-sm, text-slate-500, hover:text-slate-700 for links, text-slate-900 font-medium for current
    - Truncation: On mobile, show only COP and current item (hide intermediate with `hidden sm:inline-flex` on middle items) -- keep accessible, just visually hidden on small screens
    - Import `Link` from 'next/link', `ChevronRight` from 'lucide-react', `cn` from '@/lib/utils', `CopChapter` from '@/types/cop'

    **2. Wire Breadcrumbs into chapter page** at `app/(dashboard)/cop/[chapterNumber]/page.tsx`:
    - Import `Breadcrumbs` from `@/components/cop/Breadcrumbs`
    - Place `<Breadcrumbs chapterData={chapterData} />` immediately after the "Back to COP" link and before the chapter header `<div className="mb-8">`
    - Remove or keep the "Back to COP" ArrowLeft link -- KEEP IT, since it provides a clear tap target, and breadcrumbs provide hierarchical context. But move breadcrumbs between the back link and the header, with `mb-4` spacing.

    The chapter page does NOT pass `currentSection` to Breadcrumbs since hash-based section navigation is handled client-side and the Server Component cannot read the hash. The breadcrumbs on the chapter page always show "COP > Chapter N: Title". (Future enhancement: client-side breadcrumb update based on scrollspy active section in Plan 15-02.)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Verify `components/cop/Breadcrumbs.tsx` renders `<nav aria-label="Breadcrumb">` with `<ol>` list
    - Verify chapter page imports and renders Breadcrumbs component
    - Verify breadcrumb items use Next.js Link with correct hrefs
  </verify>
  <done>
    - Breadcrumb trail renders on chapter page showing "COP > Chapter N: Title"
    - COP breadcrumb links to /cop
    - Current chapter breadcrumb shows as non-link text
    - Separator icons between breadcrumb items
    - Accessible markup with aria-label and aria-current
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Deep-link handling: `/cop/8.5.4` param detected (contains dot), validated, redirects to `/cop/8#section-8.5.4`
3. Invalid deep-links: `/cop/99.9` and `/cop/8.99.99` return 404
4. Breadcrumbs render on chapter page with correct hierarchy
5. Hash scroll hook exported and ready for use
6. Service worker CACHE_VERSION bumped to v2, /cop in STATIC_ASSETS, json in cached extensions
</verification>

<success_criteria>
- COPR-03 satisfied: User can navigate to any section via URL containing section number
- NAV-01 partially satisfied: Breadcrumbs show chapter-level hierarchy (full section hierarchy shown after scrollspy in Plan 02)
- Service worker correctly caches new COP routes for offline use
- Hash scroll polyfill ready for Plan 02 to consume
</success_criteria>

<output>
After completion, create `.planning/phases/15-navigation-chrome/15-01-SUMMARY.md`
</output>
