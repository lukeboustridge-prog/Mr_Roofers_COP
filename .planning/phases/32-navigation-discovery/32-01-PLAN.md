---
phase: 32-navigation-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/encyclopedia/search-index.ts
  - app/api/encyclopedia/search/route.ts
  - components/encyclopedia/EncyclopediaSearch.tsx
  - app/(dashboard)/encyclopedia/cop/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can type a query on the encyclopedia index page and see matching COP sections in a dropdown"
    - "Search results show chapter context, section number, title, and a text snippet"
    - "Searching by section number (e.g. '8.5.4') returns that exact section as first result"
    - "Clicking a search result navigates to the correct encyclopedia chapter and section anchor"
  artifacts:
    - path: "lib/encyclopedia/search-index.ts"
      provides: "Server-side singleton search index built from 19 chapter JSONs with title + content text search"
      exports: ["searchCopSections", "SearchResult"]
    - path: "app/api/encyclopedia/search/route.ts"
      provides: "GET /api/encyclopedia/search?q=query endpoint returning matched sections"
      exports: ["GET"]
    - path: "components/encyclopedia/EncyclopediaSearch.tsx"
      provides: "Client search input with autocomplete dropdown showing results with chapter/section context"
  key_links:
    - from: "app/api/encyclopedia/search/route.ts"
      to: "lib/encyclopedia/search-index.ts"
      via: "searchCopSections function call"
      pattern: "searchCopSections"
    - from: "components/encyclopedia/EncyclopediaSearch.tsx"
      to: "/api/encyclopedia/search"
      via: "fetch with debounced query"
      pattern: "fetch.*api/encyclopedia/search"
    - from: "app/(dashboard)/encyclopedia/cop/page.tsx"
      to: "components/encyclopedia/EncyclopediaSearch.tsx"
      via: "component import and render"
      pattern: "EncyclopediaSearch"
---

<objective>
Build search autocomplete for the COP encyclopedia that searches across all 1,121 COP section titles and content text, returning results with chapter context and text snippets.

Purpose: NAV-03 requires full-text search across COP content with autocomplete showing chapter/section context. The existing /search page only covers details and failure cases, not COP section content from the chapter JSONs.

Output: API endpoint + search index module + autocomplete UI component integrated into the encyclopedia index page.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow
@lib/encyclopedia/reference-resolver.ts  — Singleton pattern reading all 19 chapter JSONs. Reuse same approach for search index.
@types/cop.ts  — CopSection type with number, title, content, subsections
@types/encyclopedia.ts  — ReferenceMap type pattern
@components/ui/command.tsx  — shadcn Command component (used by Plan 02 for command palette)
@app/(dashboard)/encyclopedia/cop/page.tsx  — Current encyclopedia index page (add search bar here)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search index module and API endpoint</name>
  <files>
    lib/encyclopedia/search-index.ts
    app/api/encyclopedia/search/route.ts
  </files>
  <action>
Create `lib/encyclopedia/search-index.ts`:
- Follow the EXACT same singleton pattern as `reference-resolver.ts` (module-level cache, build once from 19 chapter JSONs)
- Build a flat array of `SearchIndexEntry` objects by recursively walking all sections:
  ```typescript
  interface SearchIndexEntry {
    sectionNumber: string;   // e.g. "8.5.4"
    title: string;           // Section title
    chapterNumber: number;   // For chapter context
    chapterTitle: string;    // For display
    content: string;         // Full section content text
    level: number;           // Section depth
    url: string;             // e.g. "/encyclopedia/cop/8#section-8.5.4"
  }
  ```
- Export `SearchResult` interface (same fields minus content, plus `snippet: string`)
- Export `searchCopSections(query: string, limit?: number): SearchResult[]` function:
  - Lowercase the query for case-insensitive matching
  - FIRST: Check for exact section number match (query matches entry.sectionNumber exactly or starts with it) — return those first
  - THEN: Score remaining entries by title match (higher weight) and content match (lower weight)
  - Title match scoring: full word match in title = 10 points, partial match in title = 5 points
  - Content match scoring: each occurrence in content = 1 point (cap at 5)
  - Generate snippet: find first occurrence of query in content, extract ~120 chars around it with "..." truncation
  - Sort by score descending, return top `limit` results (default 10)
  - If query is empty or < 2 chars, return empty array

Create `app/api/encyclopedia/search/route.ts`:
- GET handler with `q` query parameter from URL searchParams
- Validate: if no `q` or `q.length < 2`, return empty array `[]`
- Call `searchCopSections(q, 15)` and return JSON response
- Add `export const dynamic = 'force-dynamic'` to prevent caching stale results
- Return `{ results: SearchResult[] }` shape
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors.
    Manually test: `curl "http://localhost:3000/api/encyclopedia/search?q=flashing"` returns JSON with matching sections.
  </verify>
  <done>
    API endpoint returns search results with section number, title, chapter context, URL, and text snippet for any query >= 2 chars. Section number queries (e.g., "8.5.4") return exact matches first.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EncyclopediaSearch autocomplete component and integrate into index page</name>
  <files>
    components/encyclopedia/EncyclopediaSearch.tsx
    app/(dashboard)/encyclopedia/cop/page.tsx
  </files>
  <action>
Create `components/encyclopedia/EncyclopediaSearch.tsx` as a `'use client'` component:
- Search input with Search icon (lucide) and placeholder "Search COP sections..."
- Debounced fetch (300ms) to `/api/encyclopedia/search?q={query}` using useState + useEffect pattern
- Show results in an absolutely-positioned dropdown below the input (bg-white shadow-lg rounded-lg border z-50)
- Each result item shows:
  - Section number in mono font (text-xs font-mono text-slate-500)
  - Section title in font-medium
  - Chapter context as small badge or label ("Chapter 8: External Moisture Flashings")
  - Text snippet in text-xs text-slate-500, truncated to 2 lines
- On result click: use `router.push(result.url)` to navigate to the section
- Close dropdown on blur (with slight delay for click events) and on Escape key
- Show "No results found" when query >= 2 chars and results empty
- Show loading spinner during fetch
- Include keyboard hint: small "Cmd+K" badge on the right side of the input (this will trigger the command palette from Plan 02)

Modify `app/(dashboard)/encyclopedia/cop/page.tsx`:
- Import and render `<EncyclopediaSearch />` between the page header and the chapter grid
- Wrap it in a `<div className="mb-8">` for spacing
- Keep existing server component structure — the search component is a client island
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors.
    Visit `/encyclopedia/cop` — search bar visible above chapter grid.
    Type "flashing" — dropdown shows matching sections with chapter context and snippets.
    Click a result — navigates to correct chapter page with section anchor.
  </verify>
  <done>
    Search autocomplete on encyclopedia index page shows matching COP sections with chapter/section context, text snippets, and navigates to correct section on click.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with 0 errors
2. `/api/encyclopedia/search?q=flashing` returns JSON results with sectionNumber, title, chapterNumber, chapterTitle, url, snippet fields
3. `/api/encyclopedia/search?q=8.5.4` returns exact section match as first result
4. `/api/encyclopedia/search?q=a` returns empty results (< 2 chars)
5. `/encyclopedia/cop` page shows search bar above chapter grid
6. Typing in search shows autocomplete dropdown with matching results
7. Clicking result navigates to correct chapter and section
</verification>

<success_criteria>
- Search autocomplete works across all COP content (1,121 sections)
- Results show chapter/section context with text snippets
- Section number queries return exact matches first
- Search input visible on encyclopedia index page
- Navigation to search results works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/32-navigation-discovery/32-01-SUMMARY.md`
</output>
