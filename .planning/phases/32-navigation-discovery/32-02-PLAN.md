---
phase: 32-navigation-discovery
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - components/encyclopedia/CommandPalette.tsx
  - components/encyclopedia/ArticleRenderer.tsx
  - app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
  - app/(dashboard)/encyclopedia/cop/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can press Cmd+K (Mac) or Ctrl+K (Windows) from any encyclopedia page to open a command palette"
    - "Command palette shows matching COP sections as user types, grouped by chapter"
    - "Selecting a result in the command palette navigates to the correct section"
    - "Command palette closes on Escape, outside click, or after navigation"
    - "Cmd+K hint is visible in the encyclopedia search bar"
  artifacts:
    - path: "components/encyclopedia/CommandPalette.tsx"
      provides: "Global command palette using shadcn CommandDialog with Cmd+K keyboard shortcut"
      exports: ["CommandPalette"]
    - path: "components/encyclopedia/ArticleRenderer.tsx"
      provides: "Updated to include CommandPalette for chapter pages"
    - path: "app/(dashboard)/encyclopedia/cop/page.tsx"
      provides: "Updated to include CommandPalette for index page"
  key_links:
    - from: "components/encyclopedia/CommandPalette.tsx"
      to: "/api/encyclopedia/search"
      via: "fetch on input change"
      pattern: "fetch.*api/encyclopedia/search"
    - from: "components/encyclopedia/CommandPalette.tsx"
      to: "components/ui/command.tsx"
      via: "CommandDialog, CommandInput, CommandList, CommandEmpty, CommandGroup, CommandItem imports"
      pattern: "CommandDialog|CommandInput"
    - from: "components/encyclopedia/ArticleRenderer.tsx"
      to: "components/encyclopedia/CommandPalette.tsx"
      via: "component import and render"
      pattern: "CommandPalette"
---

<objective>
Add a global command palette (Cmd+K) to all encyclopedia pages enabling fast section jumping by number or keyword, using the search API from Plan 01.

Purpose: NAV-04 requires a command palette for power-user navigation. Cmd+K is the standard shortcut. The shadcn Command component (cmdk) is already installed and provides the dialog, input, list, and item primitives.

Output: CommandPalette component rendered on both encyclopedia index and chapter pages, wired to the search API.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-navigation-discovery/32-01-SUMMARY.md  — Search API endpoint and EncyclopediaSearch component

# Key references
@components/ui/command.tsx  — shadcn CommandDialog, CommandInput, CommandList, CommandEmpty, CommandGroup, CommandItem
@components/encyclopedia/ArticleRenderer.tsx  — Client wrapper where CommandPalette will be rendered for chapter pages
@app/(dashboard)/encyclopedia/cop/page.tsx  — Encyclopedia index where CommandPalette will be rendered
@app/api/encyclopedia/search/route.ts  — Search API from Plan 01 (GET /api/encyclopedia/search?q=)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommandPalette component with Cmd+K shortcut</name>
  <files>
    components/encyclopedia/CommandPalette.tsx
  </files>
  <action>
Create `components/encyclopedia/CommandPalette.tsx` as a `'use client'` component:

- Use shadcn's `CommandDialog` as the wrapper (it provides Dialog + Command integration)
- Register global keyboard listener for Cmd+K (Mac) / Ctrl+K (Windows):
  - `useEffect` with `keydown` listener checking `e.metaKey || e.ctrlKey` and `e.key === 'k'`
  - `e.preventDefault()` to prevent browser default (Chrome address bar focus)
  - Toggle dialog open state
- On input change in CommandInput:
  - Debounce 200ms (shorter than search bar since command palette expects fast typing)
  - Fetch from `/api/encyclopedia/search?q={query}&limit=20`
  - Store results in state
- Group results by chapterNumber using `CommandGroup` with heading "Chapter N: Title"
- Each result rendered as `CommandItem`:
  - `value` prop: `{sectionNumber} {title}` (cmdk uses this for built-in filtering)
  - Display: section number in mono font + title
  - Snippet below in smaller text (if available)
  - `onSelect` handler: close dialog + `router.push(result.url)`
- When no query entered (empty state), show:
  - `CommandGroup` heading "Quick Jump" with all 19 chapter entries (hardcoded from reference-resolver pattern — chapter numbers 1-19)
  - Each chapter shows "Chapter N: Title" and navigates to `/encyclopedia/cop/{N}`
- `CommandEmpty`: Show "No sections found" message
- Pass `shouldFilter={false}` to the Command root since we do server-side filtering via API (not cmdk's built-in client filter)
- Use `useRouter` from next/navigation for navigation

Props interface:
```typescript
interface CommandPaletteProps {
  /** Optional: preloaded chapter titles for quick-jump when palette is empty */
  chapters?: { chapterNumber: number; title: string }[];
}
```

If `chapters` prop not provided, fetch chapter titles once on first dialog open from a simple mapping or hardcode the 19 chapter titles (they're static and won't change).
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors.
    Component can be imported and rendered without runtime errors.
  </verify>
  <done>
    CommandPalette component opens on Cmd+K, searches COP sections via API, groups by chapter, navigates on select, closes on Escape/outside click.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate CommandPalette into encyclopedia index and chapter pages</name>
  <files>
    components/encyclopedia/ArticleRenderer.tsx
    app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
    app/(dashboard)/encyclopedia/cop/page.tsx
  </files>
  <action>
Modify `components/encyclopedia/ArticleRenderer.tsx`:
- Import `CommandPalette` from `./CommandPalette`
- Render `<CommandPalette />` inside the component, AFTER the floating back-to-top button (before closing `</div>`)
- The CommandPalette is self-contained with its own keyboard listener, so no prop wiring needed

Modify `app/(dashboard)/encyclopedia/cop/page.tsx`:
- This is a Server Component, so we need a client wrapper for the command palette
- Import `CommandPalette` and render it at the bottom of the page JSX
- Since this page is a Server Component, wrap the CommandPalette import in a dynamic import or create a small client island:
  - Add `import { CommandPalette } from '@/components/encyclopedia/CommandPalette'` — this works because Server Components can render Client Components
  - Add `<CommandPalette />` after the chapter grid div

Modify `app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx`:
- No changes needed here — CommandPalette is already rendered via ArticleRenderer (which is a client component on this page)

Verify the Cmd+K hint in the EncyclopediaSearch component from Plan 01:
- The search bar should already show a "Cmd+K" or "Ctrl+K" keyboard badge on the right side (from Plan 01 Task 2)
- If not present, add it: a small `<kbd>` element showing the shortcut
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors.
    Visit `/encyclopedia/cop` — press Cmd+K — command palette opens.
    Visit `/encyclopedia/cop/8` — press Cmd+K — command palette opens.
    Type "flashing" — results appear grouped by chapter.
    Select a result — navigates to correct section.
    Press Escape — palette closes.
  </verify>
  <done>
    Command palette accessible via Cmd+K on both encyclopedia index and chapter pages. Results grouped by chapter. Navigation works. Palette closes on Escape or selection.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with 0 errors
2. Cmd+K (Mac) / Ctrl+K (Windows) opens command palette on `/encyclopedia/cop`
3. Cmd+K opens command palette on `/encyclopedia/cop/8` (any chapter page)
4. Typing in command palette shows matching sections grouped by chapter
5. Typing a section number (e.g., "8.5.4") shows that section as a result
6. Selecting a result navigates to the correct section and closes the palette
7. Pressing Escape closes the palette
8. Empty state shows chapter quick-jump list
9. "Cmd+K" hint badge visible on the encyclopedia search bar
</verification>

<success_criteria>
- Command palette opens on Cmd+K from any encyclopedia page
- Results grouped by chapter with section number and title
- Selecting a result navigates to the correct section
- Palette closes on Escape, outside click, and navigation
- Quick-jump to chapters available when palette is empty
</success_criteria>

<output>
After completion, create `.planning/phases/32-navigation-discovery/32-02-SUMMARY.md`
</output>
