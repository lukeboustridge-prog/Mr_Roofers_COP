---
phase: 14-basic-cop-reader
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - components/cop/SectionRenderer.tsx
  - components/cop/CopImage.tsx
  - app/(dashboard)/cop/[chapterNumber]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can read chapter content as scrollable text with proper heading hierarchy (h2 for sections, h3 for subsections, h4+ for deeper levels)"
    - "Technical diagrams appear inline within their parent section content, not in a separate gallery"
    - "Section numbers are visible alongside section titles throughout the chapter"
    - "Images display with proper aspect ratio and optional captions"
    - "Chapter content renders recursively through all nesting levels"
  artifacts:
    - path: "components/cop/SectionRenderer.tsx"
      provides: "Recursive section renderer with heading hierarchy"
      exports: ["SectionRenderer"]
      min_lines: 40
    - path: "components/cop/CopImage.tsx"
      provides: "COP image component with Next.js Image optimization and caption"
      exports: ["CopImage"]
      min_lines: 20
    - path: "app/(dashboard)/cop/[chapterNumber]/page.tsx"
      provides: "Updated chapter reader using SectionRenderer"
      exports: ["default"]
  key_links:
    - from: "components/cop/SectionRenderer.tsx"
      to: "components/cop/CopImage.tsx"
      via: "import and render for section images"
      pattern: "import.*CopImage"
    - from: "app/(dashboard)/cop/[chapterNumber]/page.tsx"
      to: "components/cop/SectionRenderer.tsx"
      via: "import and render for each top-level section"
      pattern: "import.*SectionRenderer"
    - from: "components/cop/SectionRenderer.tsx"
      to: "types/cop.ts"
      via: "CopSection type for props"
      pattern: "import.*CopSection.*from.*types/cop"
    - from: "components/cop/CopImage.tsx"
      to: "next/image"
      via: "Next.js Image component for R2 URLs"
      pattern: "import Image from.*next/image"
---

<objective>
Build the recursive section content renderer with inline images for the COP chapter reader. Replaces the basic content rendering from Plan 01 with a production-quality component that handles the full section hierarchy (up to 5 levels deep), renders inline technical diagrams using Next.js Image optimization, and displays proper heading hierarchy matching the printed COP structure.

Purpose: Satisfies COPR-05 (scrollable rich text with proper heading hierarchy, paragraphs, tables, and figures) and the inline image requirement (technical diagrams appear within their parent section, not in a gallery).

Output: Two new components (SectionRenderer, CopImage) and an updated chapter reader page that uses them.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\LukeBoustridge\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice\.planning\ROADMAP.md
@C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice\.planning\STATE.md
@C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice\.planning\phases\14-basic-cop-reader\14-RESEARCH.md

Prior plan summary (needed for types and page structure):
@C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice\.planning\phases\14-basic-cop-reader\14-01-SUMMARY.md

Key codebase files:
@C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice\types\cop.ts
@C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice\app\(dashboard)\cop\[chapterNumber]\page.tsx
@C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice\next.config.mjs
@C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice\lib\utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CopImage and SectionRenderer components</name>
  <files>
    components/cop/CopImage.tsx
    components/cop/SectionRenderer.tsx
  </files>
  <action>
**Step 1: Create components/cop/CopImage.tsx**

A Server Component (no 'use client') that renders a COP technical diagram using Next.js Image component.

```
Props: {
  image: CopImage (from types/cop.ts)
  chapterNumber: number
  sectionNumber: string
}
```

Implementation:
- Import `Image` from `next/image` and `CopImage as CopImageType` from `@/types/cop`
- Import `cn` from `@/lib/utils`
- The image URL is a FULL R2 URL already embedded in the JSON (e.g. "https://pub-5f4c0432c70b4389a92d23c5a0047e17.r2.dev/images/mrm/..."). Do NOT use getPublicUrl() -- use the URL directly.
- next.config.mjs already has `**.r2.dev` in remotePatterns, so Next.js Image will work directly.
- Wrap in a `<figure>` element with `my-6` margin
- Use Next.js `<Image>` component with:
  - `src={image.url}` (the full R2 URL)
  - `width={image.dimensions.width}` and `height={image.dimensions.height}` from the JSON data
  - `alt={image.caption || "COP Chapter ${chapterNumber} Section ${sectionNumber} diagram"}`
  - `className="rounded-lg border border-slate-200"` for visual framing
  - `quality={80}` for good quality-to-size ratio
  - `sizes="(max-width: 768px) 100vw, (max-width: 1024px) 80vw, 720px"` for responsive sizing
- If `image.caption` is non-empty string, render a `<figcaption>` below the image with `text-sm text-slate-500 mt-2 text-center` styling
- Export as named export: `export function CopImage(...)`

**Step 2: Create components/cop/SectionRenderer.tsx**

A Server Component that recursively renders a COP section and all its subsections with proper heading hierarchy and inline images.

```
Props: {
  section: CopSection (from types/cop.ts)
  chapterNumber: number
}
```

Implementation:
- Import `CopSection` from `@/types/cop`
- Import `CopImage` from `./CopImage`
- Import `cn` from `@/lib/utils`

Heading hierarchy mapping:
- `level 1` -> `<h2>` (chapter-level sections are top-level headings within a page that already has h1)
- `level 2` -> `<h3>`
- `level 3` -> `<h4>`
- `level 4` -> `<h5>`
- `level 5+` -> `<h6>`
- Use `Math.min(section.level + 1, 6)` to compute heading level, then render dynamically

Heading styles by level:
- h2: `text-xl font-bold text-slate-900 md:text-2xl mt-10 mb-4`
- h3: `text-lg font-semibold text-slate-800 md:text-xl mt-8 mb-3`
- h4: `text-base font-semibold text-slate-800 mt-6 mb-2`
- h5/h6: `text-sm font-semibold text-slate-700 mt-4 mb-2`

Use a styles lookup object keyed by heading tag name, and apply with cn().

Each section renders:
1. An HTML `<section>` wrapper with `id={`section-${section.number}`}` for future deep-linking (Phase 15)
2. The heading with format: `{section.number}  {section.title}` (section number in a lighter color span: `text-slate-400 font-normal mr-2`)
   - IMPORTANT: Only show heading if the section has a title AND the title is different from the content's first line. Some sections (like the chapter root) have content that starts with the section number and title repeated. For the level-1 root section, SKIP rendering the heading (the page h1 already shows "Chapter N: Title").
3. Content rendered with `whitespace-pre-line text-slate-700 leading-relaxed` CSS
   - IMPORTANT: The content field often starts with the section number and title repeated (e.g. "8.5.2 \nBarge And Verge \n...actual content"). Strip the leading section number + title from the content before rendering. A simple approach: if content starts with the section number, find the content after the title line and render from there. Use a regex: `content.replace(new RegExp('^' + section.number.replace('.', '\\.') + '\\s*\\n' + section.title.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*\\n', 'i'), '').trim()`. If stripping fails or produces empty string, render the original content.
4. Inline images: After content text, if `section.images` exists and has items, render each using `<CopImage image={img} chapterNumber={chapterNumber} sectionNumber={section.number} />`
5. Subsections: If `section.subsections` exists and has items, recursively render `<SectionRenderer section={sub} chapterNumber={chapterNumber} />` for each

The level-1 root section skip rule:
- If `section.level === 1`, do NOT render a heading for it (page h1 already shows the chapter title)
- Still render its content (if it has unique content beyond the title) and its images and subsections

Export as named export: `export function SectionRenderer(...)`
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation of both components. Check that:
- CopImage.tsx imports from types/cop and uses next/image
- SectionRenderer.tsx imports CopImage and recursively renders sections
- No 'use client' directive in either file
  </verify>
  <done>
- SectionRenderer recursively renders sections with heading levels h2-h6 based on section.level
- Section numbers appear alongside titles with visual hierarchy
- Content renders with whitespace-pre-line for preserved line breaks
- Leading section number + title duplication is stripped from content text
- CopImage renders inline figures with Next.js Image optimization, proper alt text, and optional captions
- Image URLs are used directly from JSON (full R2 URLs)
- Both components are Server Components (no 'use client')
- Each section has an id attribute for future deep-linking
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SectionRenderer into chapter reader page</name>
  <files>
    app/(dashboard)/cop/[chapterNumber]/page.tsx
  </files>
  <action>
Update the chapter reader page created in Plan 01 to use the SectionRenderer component instead of the basic content rendering.

Changes to make:
1. Add import: `import { SectionRenderer } from '@/components/cop/SectionRenderer'`
2. Replace the basic content rendering loop (which iterates over sections and renders h2 + whitespace-pre-line divs) with:

```tsx
<div id="chapter-content" className="mt-8">
  {chapter.sections.map((section) => (
    <SectionRenderer
      key={section.number}
      section={section}
      chapterNumber={chapter.chapterNumber}
    />
  ))}
</div>
```

3. Keep everything else from Plan 01 intact:
   - Back link to /cop
   - h1 with "Chapter {N}: {title}"
   - Version badge
   - Section count text
   - Container max-w-4xl
   - fs.readFileSync JSON loading
   - notFound() validation
   - All imports

4. Add a visual separator between the header area and content: `<hr className="border-slate-200 my-6" />` between the header metadata and the chapter-content div.

5. Add a "scroll to top" anchor at the bottom of the page (optional but good UX for long chapters):
```tsx
<div className="mt-12 mb-8 text-center">
  <a href="#" className="text-sm text-slate-400 hover:text-slate-600">
    Back to top
  </a>
</div>
```

Do NOT change the page from Server Component to Client Component.
Do NOT modify the loading.tsx skeleton.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify compilation. Then start dev server and verify:
1. /cop/1 -- Chapter 1 renders with proper heading hierarchy (h2 for Disclaimer and Copyright, h3 for Update-Policy, etc.)
2. /cop/8 -- Chapter 8 renders with inline technical diagrams visible within sections (e.g. section 8.3A should show thermal expansion joint image)
3. /cop/19 -- Largest chapter (618KB) loads and renders without errors
4. Section headings show section numbers in lighter color
5. Content has proper line breaks (whitespace-pre-line working)
6. Images load from R2 CDN (check Network tab -- images should load from pub-xxx.r2.dev)
7. All sections and subsections render recursively (check Chapter 8 which has deep nesting)
  </verify>
  <done>
- Chapter reader uses SectionRenderer for full recursive content display
- All section levels render with appropriate heading sizes (h2 through h6)
- Technical diagrams appear inline within their parent sections (not in a gallery)
- Images load via Next.js Image component with optimization (WebP/AVIF format, responsive sizes)
- Large chapters (Chapter 19, 618KB) render without errors
- Content is scrollable as a single page per chapter
- COPR-05 satisfied: scrollable rich text with heading hierarchy, paragraphs, and figures
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- no TypeScript errors
2. /cop/8 renders Chapter 8 with all sections, subsections, and inline images
3. /cop/8 section 8.3A shows the thermal expansion joint diagram inline (not in a gallery)
4. Heading hierarchy is correct: h1 = page title, h2 = top-level sections, h3 = subsections, etc.
5. Section numbers appear alongside titles throughout
6. Content has preserved line breaks (no collapsed whitespace)
7. Images from R2 load successfully (check browser DevTools Network tab)
8. /cop/19 (largest chapter) loads and renders completely
9. /cop/1 renders the Introduction chapter with Disclaimer, Scope, Standards, etc. as properly nested sections
</verification>

<success_criteria>
- SectionRenderer handles arbitrary nesting depth with correct heading levels
- CopImage renders inline figures with Next.js optimization and optional captions
- All 19 chapters render with proper visual hierarchy matching the printed COP
- Technical diagrams appear inline within parent sections (COPR-05, success criterion 3)
- Content is scrollable rich text with headings, paragraphs, and figures (COPR-05)
- No runtime errors on any chapter including the largest (Chapter 19)
</success_criteria>

<output>
After completion, create `.planning/phases/14-basic-cop-reader/14-02-SUMMARY.md`
</output>
