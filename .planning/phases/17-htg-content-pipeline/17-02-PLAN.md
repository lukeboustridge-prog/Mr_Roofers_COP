---
phase: 17-htg-content-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - lib/db/map-htg-to-cop.ts
  - package.json
autonomous: false

must_haves:
  truths:
    - "HTG content records are mapped to corresponding COP sections in the cop_section_htg table"
    - "Flashings HTG pages link to Chapter 8 flashing-related sections"
    - "Penetrations HTG pages link to Chapter 9 penetration-related sections"
    - "Cladding HTG pages link to Chapter 6 cladding-related sections"
    - "HTG guides appear as collapsible inline panels within relevant COP sections in the browser"
  artifacts:
    - path: "lib/db/map-htg-to-cop.ts"
      provides: "HTG-to-COP mapping script with keyword-based suggestions and manual insert mode"
      min_lines: 60
    - path: "package.json"
      provides: "db:map-htg-to-cop npm script entry"
      contains: "db:map-htg-to-cop"
  key_links:
    - from: "lib/db/map-htg-to-cop.ts"
      to: "lib/db/schema.ts"
      via: "imports copSectionHtg, htgContent, copSections tables"
      pattern: "import.*copSectionHtg.*from.*schema"
    - from: "lib/db/queries/supplementary.ts"
      to: "cop_section_htg table"
      via: "getSupplementaryContent query joins copSectionHtg"
      pattern: "copSectionHtg"
    - from: "components/cop/SectionRenderer.tsx"
      to: "SupplementaryPanel"
      via: "renders HTG guides in collapsible panels"
      pattern: "htgGuides"
---

<objective>
Create HTG-to-COP section mappings in cop_section_htg table so that HTG guides appear as supplementary panels within relevant COP chapter sections.

Purpose: Connects extracted HTG content (from Plan 01) to the COP sections they relate to. Once mappings exist in cop_section_htg, the Phase 16 infrastructure automatically displays them as collapsible panels.
Output: lib/db/map-htg-to-cop.ts script + populated cop_section_htg table + HTG panels visible in the COP Reader.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-htg-content-pipeline/17-RESEARCH.md
@.planning/phases/17-htg-content-pipeline/17-01-SUMMARY.md

Relevant source files:
@lib/db/import-cop-hierarchy.ts (pattern to follow)
@lib/db/schema.ts (copSectionHtg, htgContent, copSections tables)
@lib/db/queries/supplementary.ts (getSupplementaryContent — already queries copSectionHtg, no changes needed)
@components/cop/SectionRenderer.tsx (already renders HTG guides in panels, lines 98-109 — no changes needed)
@package.json (add db:map-htg-to-cop script)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HTG-to-COP mapping script and insert initial mappings</name>
  <files>
    lib/db/map-htg-to-cop.ts
    package.json
  </files>
  <action>
    1. Add npm script to package.json scripts:
       `"db:map-htg-to-cop": "npx tsx lib/db/map-htg-to-cop.ts"`

    2. Create `lib/db/map-htg-to-cop.ts` following the import-cop-hierarchy.ts pattern:

    - Load dotenv FIRST: `import { config } from 'dotenv'; config({ path: '.env.local' });`
    - Import `db` from `./index`, `copSectionHtg`, `htgContent`, `copSections` from `./schema`
    - Import `eq`, `and`, `like` from `drizzle-orm`

    The script has two modes, controlled by a CLI arg:

    **Mode 1 (default): `--suggest`**
    Outputs suggested HTG-to-COP mappings based on keyword matching. Does NOT insert into database.

    Define MAPPING_RULES:
    ```
    [
      { sourceDocument: 'flashings', copChapters: [8], keywords: ['flashing', 'ridge', 'valley', 'apron', 'soaker', 'barge', 'gutter'] },
      { sourceDocument: 'penetrations', copChapters: [9], keywords: ['penetration', 'pipe', 'vent', 'chimney', 'skylight', 'plumbing'] },
      { sourceDocument: 'cladding', copChapters: [6, 7], keywords: ['cladding', 'wall', 'fixing', 'fastener', 'flashing'] },
    ]
    ```

    For each rule:
      a) Query htg_content WHERE sourceDocument = rule.sourceDocument AND content is not empty
      b) Query cop_sections WHERE chapterNumber IN rule.copChapters
      c) For each HTG page, for each COP section: check if any keyword appears in BOTH the HTG page content AND the COP section title (case-insensitive)
      d) Log suggested mappings: `SUGGEST: {htg.id} -> {section.sectionNumber} "{section.title}" (matched: {keywords})`
      e) Count suggestions per sourceDocument

    **Mode 2: `--insert`**
    Inserts a CURATED set of broad mappings. This is the initial seeding — maps entire HTG guides (all pages of a sourceDocument) to top-level COP chapter sections, providing a baseline that the user can refine later.

    Curated mappings strategy:
      a) Query all htg_content records, grouped by sourceDocument
      b) Query cop_sections for the matching chapters:
         - flashings -> all level-1 and level-2 sections in Chapter 8
         - penetrations -> all level-1 and level-2 sections in Chapter 9
         - cladding -> all level-1 and level-2 sections in Chapter 6
      c) For each sourceDocument, pick a representative subset of HTG pages (e.g., every 5th page, or pages with substantial content > 100 chars) to avoid creating thousands of mapping rows
      d) Map each selected HTG page to the chapter-level section (e.g., cop-8 for flashings) with relevance: 'supplementary'
      e) Clear existing cop_section_htg before inserting (idempotent)
      f) Batch insert mappings
      g) Log: total mappings inserted, breakdown by sourceDocument

    IMPORTANT: The --insert mode creates BROAD initial mappings. The goal is to get SOMETHING showing in the supplementary panels so the user can see HTG data flowing through the pipeline. Fine-grained page-to-section mappings require manual expert curation later.

    Notes on mapping granularity:
    - Research found ZERO automatic section-detail links in Phase 13-02
    - Keyword matching will produce NOISY suggestions — that's expected
    - The --insert mode should be conservative: map to chapter-level sections only
    - Use relevance: 'supplementary' for all initial mappings
    - Add notes field: 'Auto-generated initial mapping — requires manual curation'
  </action>
  <verify>
    1. `npm run db:map-htg-to-cop -- --suggest` runs and outputs suggested mappings to console
    2. `npm run db:map-htg-to-cop -- --insert` runs and inserts mappings into cop_section_htg
    3. Verify mappings exist: run `npm run db:studio` and check cop_section_htg table has rows linking htg_content records to cop_sections
    4. Running --insert twice produces same row count (idempotent)
  </verify>
  <done>
    - map-htg-to-cop.ts script exists with --suggest and --insert modes
    - cop_section_htg table has initial mappings linking HTG content to COP chapter sections
    - db:map-htg-to-cop npm script added to package.json
    - Satisfies requirement HTG-02: Extracted HTG content mapped to corresponding MRM COP sections
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    HTG content pipeline: PDFs extracted into htg_content table (Plan 01), mappings created in cop_section_htg table (Task 1 above). Phase 16 infrastructure (SupplementaryPanel, getSupplementaryContent query, SectionRenderer) should now automatically display HTG guides as collapsible panels within the mapped COP sections.
  </what-built>
  <how-to-verify>
    1. Run `npm run dev` to start the development server
    2. Navigate to the COP Reader chapter that has HTG mappings:
       - Visit http://localhost:3000/cop/8 (Chapter 8 - Flashings) — should show "Related HTG Guides" panel
       - Visit http://localhost:3000/cop/9 (Chapter 9 - Penetrations) — should show HTG panel if penetrations extracted
       - Visit http://localhost:3000/cop/6 (Chapter 6 - Cladding) — should show HTG panel if cladding extracted
    3. Verify the "Related HTG Guides" panel:
       - Panel should appear collapsed by default (grey border, "Supplementary" label)
       - Click to expand — should show HTG guide names and source document labels
       - Content should come from real PDF extraction (not placeholder data)
    4. Check that sections WITHOUT HTG mappings do NOT show the HTG panel (e.g., visit /cop/1 Chapter 1)
    5. Verify the HTG panel styling is consistent with other supplementary panels (detail cards, case law)
  </how-to-verify>
  <resume-signal>Type "approved" if HTG panels display correctly in mapped chapters, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. cop_section_htg table has rows linking htg_content records to cop_sections
2. COP Reader shows "Related HTG Guides" collapsible panel in chapters 6, 8, and/or 9
3. Chapters without HTG mappings show no HTG panel
4. HTG panels use existing Phase 16 SupplementaryPanel infrastructure (no new UI components created)
5. No changes needed to supplementary.ts query or SectionRenderer.tsx (data flows automatically)
</verification>

<success_criteria>
- HTG-02 satisfied: HTG content mapped to corresponding COP sections
- HTG-03 satisfied: HTG guides appear as collapsible inline panels using Phase 16 infrastructure
- map-htg-to-cop.ts provides both suggestion and insertion modes
- End-to-end pipeline verified: PDF extraction -> database -> query -> UI display
</success_criteria>

<output>
After completion, create `.planning/phases/17-htg-content-pipeline/17-02-SUMMARY.md`
</output>
