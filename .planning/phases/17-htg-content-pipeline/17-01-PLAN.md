---
phase: 17-htg-content-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/import-htg-content.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "HTG content from the 3 RANZ PDFs (Flashings, Penetrations, Cladding) exists as structured records in the htg_content database table"
    - "Each htg_content record has a valid sourceDocument, guideName, content text, and pdfPage number"
    - "The import script is idempotent — running it twice produces the same row count"
  artifacts:
    - path: "lib/db/import-htg-content.ts"
      provides: "HTG PDF extraction and database import script"
      min_lines: 80
    - path: "package.json"
      provides: "db:import-htg-content npm script entry"
      contains: "db:import-htg-content"
  key_links:
    - from: "lib/db/import-htg-content.ts"
      to: "lib/db/schema.ts"
      via: "imports htgContent table"
      pattern: "import.*htgContent.*from.*schema"
    - from: "lib/db/import-htg-content.ts"
      to: "unpdf"
      via: "extractText for PDF text extraction"
      pattern: "import.*extractText.*from.*unpdf"
---

<objective>
Extract text content from the 3 RANZ HTG PDFs (Flashings, Penetrations, Cladding) into the existing htg_content database table using a build-time import script.

Purpose: Populates the HTG data that Phase 16's supplementary panel infrastructure will display. Without this data, HTG panels remain empty.
Output: lib/db/import-htg-content.ts script + populated htg_content table with page-level records from all 3 PDFs.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-htg-content-pipeline/17-RESEARCH.md

Relevant source files:
@lib/db/import-cop-hierarchy.ts (pattern to follow: dotenv, batch insert, idempotent delete-before-insert)
@lib/db/schema.ts (htgContent table definition - already exists)
@lib/db/index.ts (lazy db proxy - import pattern)
@package.json (add db:import-htg-content script)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install unpdf and create HTG import script</name>
  <files>
    lib/db/import-htg-content.ts
    package.json
  </files>
  <action>
    1. Install unpdf: `npm install unpdf`

    2. Add npm script to package.json scripts:
       `"db:import-htg-content": "npx tsx lib/db/import-htg-content.ts"`

    3. Create `lib/db/import-htg-content.ts` following the import-cop-hierarchy.ts pattern:

    - Load dotenv FIRST (before any other imports): `import { config } from 'dotenv'; config({ path: '.env.local' });`
    - Import `db` from `./index`, `htgContent` and `copSectionHtg` from `./schema`
    - Import `extractText` from `unpdf`
    - Import `fs` and `path` from Node.js

    Define HTG_PDFS array with 5 entries (all PDF files), grouped by sourceDocument:

    ```
    Flashings (1 file):
      - HTG_content/Artwork/Flashings Guide Artwork 2020/wetransfer-acc95a/RANZ Metal Roof Flashings - Web Quality 20200703republish.pdf
      - sourceDocument: 'flashings'
      - guideName: 'RANZ Metal Roof Flashings Guide'

    Penetrations (1 file):
      - HTG_content/Artwork/Penetrations Artwork/RANZ Metal Roof Penetrations - Press Quality 2020republish.pdf
      - sourceDocument: 'penetrations'
      - guideName: 'RANZ Metal Roof Penetrations Guide'

    Cladding (3 files — Cover, 2pp, 4x32pp — all with sourceDocument: 'cladding'):
      - HTG_content/Artwork/Cladding guide artwork/174548 Metal Wall Cladding.Cover.1A.PDF
        guideName: 'RANZ Metal Wall Cladding Guide - Cover'
      - HTG_content/Artwork/Cladding guide artwork/174548 Metal Wall Cladding.2pp.1A.PDF
        guideName: 'RANZ Metal Wall Cladding Guide - 2pp'
      - HTG_content/Artwork/Cladding guide artwork/174548 Metal Wall Cladding.4 x 32pp.1A.PDF
        guideName: 'RANZ Metal Wall Cladding Guide - Main'
    ```

    Main importHtgContent() function:

    a) Delete existing htg_content records (idempotent):
       - MUST delete copSectionHtg FIRST (FK constraint), then htgContent
       - `await db.delete(copSectionHtg);`
       - `await db.delete(htgContent);`

    b) Track cumulative page offset per sourceDocument for multi-file Cladding concatenation.
       Use a Map<string, number> to track the running page count per sourceDocument.

    c) For each PDF in HTG_PDFS:
       - Resolve path via `path.join(process.cwd(), pdf.file)`
       - Check file exists with `fs.existsSync()`, warn and `continue` if missing
       - Read PDF buffer: `fs.readFileSync(pdfPath)`
       - Extract text: `const result = await extractText(pdfBuffer, { mergePages: false })`
       - NOTE: unpdf `extractText` with `mergePages: false` returns `{ text: string, totalPages: number }` where `text` is an array of page texts (check the actual return type — may be `string[]` or `{ pages: string[] }`). Log what comes back and handle accordingly.
       - Get the page offset for this sourceDocument from the offset Map (default 0)
       - Create records array: for each page of extracted text, create an object:
         ```
         {
           id: `${pdf.sourceDocument}-p${pageOffset + idx + 1}`,
           sourceDocument: pdf.sourceDocument,
           guideName: `${pdf.guideName} - Page ${pageOffset + idx + 1}`,
           content: pageText.trim(),
           images: null,
           pdfPage: pageOffset + idx + 1,
         }
         ```
       - Filter out records with empty content (pages that are pure images)
       - Update the offset Map: add the number of total pages to the running offset for this sourceDocument
       - Batch insert in groups of 50 (some pages may have large text):
         `await db.insert(htgContent).values(batch)`
       - Log progress: file name, pages extracted, records inserted (non-empty pages)

    d) Final summary log: total records inserted across all PDFs, breakdown by sourceDocument

    IMPORTANT NOTES:
    - The 352MB Penetrations PDF may cause memory pressure. If extractText throws a memory error, catch it and log a warning suggesting the user increase Node.js heap: `NODE_OPTIONS='--max-old-space-size=4096' npm run db:import-htg-content`
    - Cladding's 3 files share sourceDocument 'cladding' — page numbers must be sequential across files (Cover p1, 2pp p2-3, Main p4+)
    - Process Cladding files in order: Cover first, 2pp second, Main last
    - Use path.join for cross-platform compatibility (Windows paths)
  </action>
  <verify>
    1. `npm run db:import-htg-content` completes without errors
    2. Script logs show records inserted for at least the Flashings PDF (3.1MB, reliable extraction)
    3. Run script a second time — row count in logs should match first run (idempotent)
    4. Check the htg_content table has records: use a quick query in the script's summary output, or inspect via `npm run db:studio`
  </verify>
  <done>
    - htg_content table contains page-level records from all extractable HTG PDFs
    - Each record has id (e.g., flashings-p1), sourceDocument, guideName, content (text), pdfPage
    - The db:import-htg-content npm script exists and runs successfully
    - Script is idempotent (clears and re-inserts on each run)
    - Satisfies requirement HTG-01: Content extracted from the 3 RANZ HTG PDFs into structured data
  </done>
</task>

</tasks>

<verification>
1. `npm run db:import-htg-content` exits with code 0
2. Script output shows records inserted for flashings, penetrations (if extractable), and cladding sourceDocuments
3. Running the script twice produces identical row counts (idempotent behavior)
4. htg_content table rows have non-empty content fields (at least for Flashings which is a smaller, web-quality PDF)
</verification>

<success_criteria>
- HTG-01 satisfied: Content from the 3 RANZ HTG PDFs is extracted into structured htg_content records
- import-htg-content.ts follows project conventions (dotenv, batch insert, idempotent)
- unpdf installed as dependency
- db:import-htg-content npm script added to package.json
</success_criteria>

<output>
After completion, create `.planning/phases/17-htg-content-pipeline/17-01-SUMMARY.md`
</output>
