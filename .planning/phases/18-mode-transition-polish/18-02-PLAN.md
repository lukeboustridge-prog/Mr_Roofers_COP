---
phase: 18-mode-transition-polish
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - tests/navigation.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E test confirms Planner mode card navigates to /cop"
    - "E2E test confirms legacy /planner route still loads substrate grid"
    - "E2E test confirms Fixer mode is completely unchanged"
    - "E2E test confirms sidebar COP Reader link navigates to /cop"
    - "All existing navigation E2E tests still pass"
  artifacts:
    - path: "tests/navigation.spec.ts"
      provides: "Phase 18 mode transition E2E tests alongside existing navigation tests"
      contains: "Mode Transition"
  key_links:
    - from: "tests/navigation.spec.ts"
      to: "/cop"
      via: "Playwright navigation assertions"
      pattern: "toHaveURL.*\\/cop"
    - from: "tests/navigation.spec.ts"
      to: "/planner"
      via: "Legacy route backward compatibility test"
      pattern: "goto.*\\/planner"
---

<objective>
Add E2E regression tests verifying the Phase 18 mode transition: Planner navigates to COP Reader, legacy /planner still works, Fixer mode unchanged.

Purpose: Prevent regressions on the mode transition and verify backward compatibility of all routes. This is the final verification for v1.2 Digital COP.
Output: Extended navigation.spec.ts with Phase 18 test suite.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-mode-transition-polish/18-RESEARCH.md
@.planning/phases/18-mode-transition-polish/18-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 18 mode transition E2E tests</name>
  <files>tests/navigation.spec.ts</files>
  <action>
    Append a new test.describe block to the existing tests/navigation.spec.ts file. Do NOT modify any existing tests -- only add new ones at the end of the file, inside the outer 'Navigation' describe block.

    Add the following test suite:

    ```typescript
    test.describe('Phase 18: Mode Transition', () => {
      test('Planner mode card navigates to COP Reader', async ({ page }) => {
        await page.goto('/');
        // Wait for dashboard to load
        await expect(page.getByRole('heading', { name: /welcome/i })).toBeVisible({ timeout: 10000 });
        // Click the Planner mode card (now labeled with COP-related description)
        await page.getByRole('link', { name: /planner mode/i }).click();
        // Should navigate to COP Reader, not /planner
        await expect(page).toHaveURL('/cop');
        // COP Reader page should load with chapter grid
        await expect(page.getByRole('heading', { level: 1 })).toBeVisible();
      });

      test('legacy /planner route still works', async ({ page }) => {
        // Direct navigation to old route must not 404
        await page.goto('/planner');
        // Should show substrate selection grid (backward compatibility)
        await expect(page.getByRole('heading', { name: /select.*substrate/i })).toBeVisible({ timeout: 10000 });
        await expect(page.getByRole('link', { name: /long run metal/i })).toBeVisible();
      });

      test('Fixer mode unchanged', async ({ page }) => {
        await page.goto('/');
        await expect(page.getByRole('heading', { name: /welcome/i })).toBeVisible({ timeout: 10000 });
        // Click Fixer mode card
        await page.getByRole('link', { name: /fixer mode/i }).click();
        // Should navigate to /fixer (unchanged)
        await expect(page).toHaveURL('/fixer');
        await expect(page.getByRole('heading', { name: /fixer mode/i })).toBeVisible();
      });

      test('all primary routes remain accessible', async ({ page }) => {
        // Verify no broken routes
        const routes = ['/planner', '/fixer', '/search', '/favourites', '/cop'];
        for (const route of routes) {
          const response = await page.goto(route);
          expect(response?.status()).toBeLessThan(400);
        }
      });

      test('sidebar COP Reader link works on desktop', async ({ page }) => {
        // Use desktop viewport (default is 1280x720)
        await page.goto('/');
        // Find sidebar COP Reader link
        const copLink = page.getByRole('link', { name: /cop reader/i });
        await expect(copLink).toBeVisible();
        await copLink.click();
        await expect(page).toHaveURL('/cop');
      });
    });
    ```

    The tests cover:
    1. Dashboard Planner card -> /cop (MODE-02 core requirement)
    2. Legacy /planner backward compatibility (MODE-01 / no broken links)
    3. Fixer mode completely unchanged (MODE-01 core requirement)
    4. All primary routes return non-error status codes (no broken links)
    5. Desktop sidebar COP Reader link works

    Do NOT add tests for mobile navigation sheet (Playwright sheet interactions are flaky and the mobile nav is covered by the dashboard card test which works on all viewports).
  </action>
  <verify>
    Run `npx playwright test tests/navigation.spec.ts --reporter=list` to execute all navigation tests.
    All existing tests must still pass. All new Phase 18 tests must pass.
    If the dev server is not running, start it first with `npx next dev` in background.
  </verify>
  <done>
    5 new E2E tests pass confirming: Planner->COP Reader navigation, legacy /planner works, Fixer unchanged, all routes accessible, sidebar COP Reader link works. All pre-existing navigation tests continue to pass.
  </done>
</task>

</tasks>

<verification>
1. `npx playwright test tests/navigation.spec.ts` -- all tests pass (existing + new)
2. New test suite "Phase 18: Mode Transition" contains 5 tests
3. No existing tests modified or removed
</verification>

<success_criteria>
- All 5 Phase 18 E2E tests pass
- All pre-existing navigation tests still pass (Three-Click, Fixer Mode, Mobile Navigation)
- Test file has no TypeScript errors
- MODE-01 verified: Fixer mode test passes, legacy /planner test passes
- MODE-02 verified: Planner card -> /cop test passes, sidebar COP Reader test passes
</success_criteria>

<output>
After completion, create `.planning/phases/18-mode-transition-polish/18-02-SUMMARY.md`
</output>
