---
phase: 29-foundation-article-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tailwind.config.ts
  - app/(dashboard)/encyclopedia/cop/page.tsx
  - app/(dashboard)/encyclopedia/cop/loading.tsx
  - app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
  - app/(dashboard)/encyclopedia/cop/[chapter]/loading.tsx
  - lib/feature-flags.ts
  - next.config.mjs
  - components/layout/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Tailwind typography plugin is installed and configured for prose styling"
    - "Encyclopedia routes at /encyclopedia/cop and /encyclopedia/cop/[chapter] render without error"
    - "Feature flag NEXT_PUBLIC_ENCYCLOPEDIA_ENABLED controls sidebar link visibility"
    - "Existing /cop/ routes continue to work without changes"
  artifacts:
    - path: "lib/feature-flags.ts"
      provides: "Feature flag utility"
      exports: ["isEncyclopediaEnabled"]
    - path: "app/(dashboard)/encyclopedia/cop/page.tsx"
      provides: "Encyclopedia chapter index"
      min_lines: 30
    - path: "app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx"
      provides: "Encyclopedia chapter article route"
      min_lines: 40
    - path: "tailwind.config.ts"
      provides: "Typography plugin registration"
      contains: "@tailwindcss/typography"
  key_links:
    - from: "app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx"
      to: "public/cop/chapter-{N}.json"
      via: "fs.readFileSync"
      pattern: "readFileSync.*chapter-"
    - from: "components/layout/Sidebar.tsx"
      to: "lib/feature-flags.ts"
      via: "conditional rendering"
      pattern: "isEncyclopediaEnabled"
---

<objective>
Install @tailwindcss/typography plugin, create feature flag utility, scaffold encyclopedia route structure at /encyclopedia/cop/ with chapter index and chapter article pages that read from existing chapter JSON data.

Purpose: Establish the route foundation and infrastructure that Plans 02-03 will build upon, ensuring encyclopedia routes coexist with existing /cop/ routes via feature flag gating.

Output: Working encyclopedia routes rendering basic chapter content, typography plugin available, feature flag controlling sidebar visibility.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@tailwind.config.ts
@app/(dashboard)/cop/page.tsx
@app/(dashboard)/cop/[chapterNumber]/page.tsx
@components/layout/Sidebar.tsx
@next.config.mjs
@middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install typography plugin, create feature flag, scaffold encyclopedia routes</name>
  <files>
    tailwind.config.ts
    lib/feature-flags.ts
    app/(dashboard)/encyclopedia/cop/page.tsx
    app/(dashboard)/encyclopedia/cop/loading.tsx
    app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
    app/(dashboard)/encyclopedia/cop/[chapter]/loading.tsx
    next.config.mjs
  </files>
  <action>
    1. Install @tailwindcss/typography:
       `npm install @tailwindcss/typography`

    2. Add typography plugin to tailwind.config.ts:
       - Add `require("@tailwindcss/typography")` to the plugins array (alongside existing tailwindcss-animate)
       - Do NOT modify any other Tailwind config

    3. Create `lib/feature-flags.ts`:
       ```typescript
       export function isEncyclopediaEnabled(): boolean {
         return process.env.NEXT_PUBLIC_ENCYCLOPEDIA_ENABLED === 'true';
       }
       ```
       Simple env var check. Works on both server and client (NEXT_PUBLIC_ prefix).

    4. Create `app/(dashboard)/encyclopedia/cop/page.tsx` — Encyclopedia chapter index:
       - Server Component (no 'use client')
       - Read all 19 chapter JSONs using fs.readFileSync (same pattern as existing cop/page.tsx)
       - Extract metadata only (chapterNumber, title, version, sectionCount)
       - Render page header: "NZ Metal Roofing Code of Practice" as h1
       - Below header: version string "v25.12 — 1 December 2025" and "NZ Metal Roof and Wall Cladding Code of Practice" subtitle
       - Render chapter grid using Card components (same pattern as cop/page.tsx) but link to `/encyclopedia/cop/{chapterNumber}`
       - Import type CopChapterMeta from @/types/cop

    5. Create `app/(dashboard)/encyclopedia/cop/loading.tsx`:
       - Loading skeleton matching the chapter grid layout
       - Use Skeleton components from @/components/ui/skeleton

    6. Create `app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx` — Chapter article page:
       - Server Component reading chapter JSON via fs.readFileSync (same pattern as cop/[chapterNumber]/page.tsx)
       - Validate chapter param is number 1-19, notFound() if invalid
       - Handle section deep-links: if param contains '.', extract chapter number and redirect to `/encyclopedia/cop/{chapterNum}#section-{fullNumber}`
       - Fetch supplementary content using existing getSupplementaryContent() query
       - Render basic structure: Back link to /encyclopedia/cop, chapter title as h1, version badge
       - Pass chapterData + supplementaryContent to a placeholder div (will be replaced by ArticleRenderer in Plan 02)
       - For now, render sections using a simple recursive map that outputs:
         - Section heading with section number as anchor `id="section-{number}"`
         - Section content as `<div className="prose prose-slate max-w-none">`
         - Subsections recursively
       - This basic rendering will be replaced by ArticleRenderer in Plan 02 — keep it simple

    7. Create `app/(dashboard)/encyclopedia/cop/[chapter]/loading.tsx`:
       - Loading skeleton for article page

    8. Update next.config.mjs:
       - Add outputFileTracingIncludes for encyclopedia routes:
         ```
         '/encyclopedia/cop': ['./public/cop/**'],
         '/encyclopedia/cop/[chapter]': ['./public/cop/**'],
         ```
       - Keep existing /cop entries unchanged
  </action>
  <verify>
    - `npm run build` completes without errors
    - Navigate to /encyclopedia/cop — chapter grid renders
    - Navigate to /encyclopedia/cop/1 — chapter 1 content renders with prose styling
    - Navigate to /cop — existing COP reader still works unchanged
  </verify>
  <done>
    Encyclopedia routes render chapter content with Tailwind typography prose styling. Feature flag utility exists. Existing /cop/ routes are unaffected. Typography plugin is available for prose class usage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire feature flag to sidebar navigation</name>
  <files>
    components/layout/Sidebar.tsx
  </files>
  <action>
    1. Read existing Sidebar.tsx to understand current navigation structure and links.

    2. Add conditional encyclopedia link:
       - Import `isEncyclopediaEnabled` from `@/lib/feature-flags`
       - Add "Encyclopedia" link pointing to `/encyclopedia/cop` in the sidebar navigation
       - Wrap with condition: only show if `isEncyclopediaEnabled()` returns true
       - Use BookOpen icon from lucide-react (or Library icon — pick what fits alongside existing icons)
       - Place it AFTER existing COP link in the navigation order

    3. Ensure the link uses the same styling pattern as other sidebar links (active state highlighting, icon + text).

    4. Do NOT modify existing links. The existing "Code of Practice" link to /cop stays unchanged.
  </action>
  <verify>
    - Without NEXT_PUBLIC_ENCYCLOPEDIA_ENABLED=true in .env.local, sidebar does NOT show Encyclopedia link
    - With NEXT_PUBLIC_ENCYCLOPEDIA_ENABLED=true, sidebar shows Encyclopedia link and navigates to /encyclopedia/cop
    - Existing sidebar links all work as before
  </verify>
  <done>
    Sidebar conditionally shows Encyclopedia navigation link based on feature flag. All existing navigation unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. /encyclopedia/cop renders chapter grid with all 19 chapters
3. /encyclopedia/cop/8 renders Chapter 8 content with `prose` class styling
4. /encyclopedia/cop/8.5.4 redirects to /encyclopedia/cop/8#section-8.5.4
5. /cop still renders the existing COP reader unchanged
6. Feature flag controls sidebar link visibility
7. Tailwind typography plugin classes (prose, prose-slate) are available
</verification>

<success_criteria>
- Encyclopedia route structure exists and serves content
- Feature flag utility created and wired to sidebar
- Typography plugin installed and configured
- Existing /cop/ routes completely unaffected
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/29-foundation-article-architecture/29-01-SUMMARY.md`
</output>
