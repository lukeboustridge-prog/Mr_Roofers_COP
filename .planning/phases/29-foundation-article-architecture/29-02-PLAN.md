---
phase: 29-foundation-article-architecture
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - components/encyclopedia/ArticleRenderer.tsx
  - components/encyclopedia/ArticleSectionHeading.tsx
  - components/encyclopedia/ArticleVersionBanner.tsx
  - components/encyclopedia/ArticleTOC.tsx
  - components/encyclopedia/ArticleContent.tsx
  - app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
autonomous: true

must_haves:
  truths:
    - "COP sections render as continuous prose with heading hierarchy (h2-h6) and section numbers"
    - "Section numbers display prominently as deep-link anchors with shareable URLs"
    - "Legislative typography applies: formal section numbering, hierarchical headings, high-contrast readable prose"
    - "Version identification shows COP edition and date for MBIE citation validity"
    - "TOC sidebar appears on desktop with scrollspy highlighting"
  artifacts:
    - path: "components/encyclopedia/ArticleRenderer.tsx"
      provides: "Client wrapper with TOC sidebar, scrollspy, back-to-top"
      min_lines: 80
    - path: "components/encyclopedia/ArticleSectionHeading.tsx"
      provides: "Section heading with anchor link and section number"
      min_lines: 20
    - path: "components/encyclopedia/ArticleVersionBanner.tsx"
      provides: "COP version and edition banner for citation"
      min_lines: 15
    - path: "components/encyclopedia/ArticleTOC.tsx"
      provides: "Recursive TOC tree for encyclopedia articles"
      min_lines: 30
    - path: "components/encyclopedia/ArticleContent.tsx"
      provides: "Recursive article section renderer with prose styling"
      min_lines: 50
  key_links:
    - from: "components/encyclopedia/ArticleRenderer.tsx"
      to: "components/encyclopedia/ArticleTOC.tsx"
      via: "import and render"
      pattern: "ArticleTOC"
    - from: "components/encyclopedia/ArticleRenderer.tsx"
      to: "components/encyclopedia/ArticleContent.tsx"
      via: "import and render"
      pattern: "ArticleContent"
    - from: "components/encyclopedia/ArticleContent.tsx"
      to: "components/encyclopedia/ArticleSectionHeading.tsx"
      via: "import for heading rendering"
      pattern: "ArticleSectionHeading"
    - from: "app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx"
      to: "components/encyclopedia/ArticleRenderer.tsx"
      via: "import and render"
      pattern: "ArticleRenderer"
---

<objective>
Create the encyclopedia article component suite with legislative typography, heading hierarchy, deep-link section anchors, version citation banner, scrollspy TOC sidebar, and continuous prose rendering.

Purpose: Deliver the core user-facing article experience that transforms COP content from flat sections into a Wikipedia-style article with formal legislative typography. This is the visual and structural heart of the encyclopedia.

Output: Complete ArticleRenderer component suite rendering COP chapters as continuous prose articles with TOC, scrollspy, deep-link anchors, and version banner.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-foundation-article-architecture/29-01-SUMMARY.md

@components/cop/ChapterContent.tsx
@components/cop/SectionRenderer.tsx
@components/cop/TOCTree.tsx
@components/cop/use-scrollspy.ts
@components/cop/use-hash-scroll.ts
@components/authority/VersionWatermark.tsx
@types/cop.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ArticleVersionBanner and ArticleSectionHeading components</name>
  <files>
    components/encyclopedia/ArticleVersionBanner.tsx
    components/encyclopedia/ArticleSectionHeading.tsx
  </files>
  <action>
    1. Create `components/encyclopedia/ArticleVersionBanner.tsx`:
       - Server Component (no 'use client')
       - Props: `version: string` (e.g., "v25.12"), `className?: string`
       - Renders a subtle but formal banner below the page title:
         - "NZ Metal Roof and Wall Cladding Code of Practice"
         - Version + date: "Version 25.12 — 1 December 2025"
         - "Published by Master Roofers NZ" on a second line
       - Styling: border-l-4 border-primary/30 pl-4 py-2 bg-slate-50 text-sm text-slate-600
       - Include `aria-label="Document version information"` for accessibility
       - This fulfills ARTICLE-07 (version identification for MBIE citation validity)

    2. Create `components/encyclopedia/ArticleSectionHeading.tsx`:
       - Server Component (no 'use client')
       - Props: `number: string, title: string, level: number, className?: string`
       - Renders heading (h2-h6) based on level:
         - level 1 -> skip (page h1 handles chapter title, same as existing SectionRenderer)
         - level 2 -> h2: text-2xl font-bold, border-b border-slate-200 pb-2 mt-14 mb-6
         - level 3 -> h3: text-xl font-semibold mt-10 mb-4
         - level 4 -> h4: text-lg font-semibold mt-8 mb-3
         - level 5 -> h5: text-base font-semibold mt-6 mb-2
         - level 6 -> h6: text-sm font-semibold mt-4 mb-2
       - Section number renders as a prominent styled span BEFORE the title:
         - `<span className="text-primary/60 font-mono text-[0.85em] mr-3 select-all">{number}</span>`
         - `select-all` allows easy copy of section number for citation
       - The heading ID is `section-{number}` for deep-link anchoring
       - Add a subtle hover-visible link icon (Link2 from lucide-react) after the title:
         - `<a href="#section-{number}" className="ml-2 opacity-0 group-hover:opacity-40 transition-opacity">`
         - Wrap the heading in a group: `className="group"`
         - This enables shareable anchor links on hover (ARTICLE-05)
       - All headings use `text-slate-900` for high contrast (legislative readability)
  </action>
  <verify>
    - TypeScript compiles without errors
    - ArticleVersionBanner renders version info with citation-appropriate formatting
    - ArticleSectionHeading renders correct heading level with section number and hover anchor link
  </verify>
  <done>
    Version banner and section heading components exist with legislative typography, section number prominence, and hover anchor links for deep-linking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ArticleTOC, ArticleContent, and ArticleRenderer components</name>
  <files>
    components/encyclopedia/ArticleTOC.tsx
    components/encyclopedia/ArticleContent.tsx
    components/encyclopedia/ArticleRenderer.tsx
    app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
  </files>
  <action>
    1. Create `components/encyclopedia/ArticleTOC.tsx`:
       - Client component ('use client') — needs scrollspy active state
       - Props: `sections: CopSection[], activeId: string | null, onItemClick?: () => void`
       - Recursive tree rendering (similar to existing TOCTree.tsx but with encyclopedia styling):
         - Each item shows section number in mono font + title
         - Active item has `bg-primary/10 text-primary font-medium border-l-2 border-primary` styling
         - Inactive items: `text-slate-600 hover:text-slate-900 hover:bg-slate-50`
         - Indentation: ml-3 per level (same as existing TOCTree)
         - Text sizing: text-sm for levels 1-2, text-xs for level 3+
       - Uses `<a href="#section-{number}">` for navigation (smooth scroll via CSS `scroll-behavior: smooth`)
       - Auto-scrolls active item into view with `scrollIntoView({ behavior: 'smooth', block: 'nearest' })`
       - Calls `onItemClick?.()` on item click (for mobile drawer close)

    2. Create `components/encyclopedia/ArticleContent.tsx`:
       - Server Component (no 'use client')
       - Props: `section: CopSection, chapterNumber: number, supplementaryContent?: Record<string, SupplementaryData>`
       - Recursive section renderer with encyclopedia prose styling:
         - Use ArticleSectionHeading for headings (level > 1)
         - Content wrapped in `<div className="prose prose-slate max-w-none prose-headings:scroll-mt-20">`:
           - prose-slate gives high-contrast slate color scheme
           - max-w-none prevents prose from constraining width
           - prose-headings:scroll-mt-20 ensures headings aren't hidden behind sticky header when scrolled to
         - Content text rendered with `whitespace-pre-line` to preserve line breaks
         - Each section wrapped in `<section id="section-{number}" className="scroll-mt-20">`
           - scroll-mt-20 for proper anchor scroll offset below sticky headers
       - Images: Render using existing CopImage component
       - Supplementary panels: Render using existing SupplementaryPanel + SupplementaryDetailCard (same as SectionRenderer)
       - Subsections: Recursive ArticleContent rendering

    3. Create `components/encyclopedia/ArticleRenderer.tsx`:
       - Client component ('use client') — manages scrollspy, drawer, scroll state
       - Props: `chapterData: CopChapter, supplementaryContent?: Record<string, SupplementaryData>`
       - Structure modeled on existing ChapterContent.tsx but with encyclopedia styling:
         a. Desktop TOC sidebar (hidden lg:block):
            - `w-72 shrink-0 sticky top-0 h-screen overflow-y-auto border-r border-slate-200`
            - Header: "Contents" in uppercase tracking-wider
            - ArticleTOC with scrollspy active highlighting
         b. Mobile TOC drawer (lg:hidden):
            - Sticky top bar with "Contents" button opening Sheet drawer
            - ArticleTOC inside drawer with onItemClick to close
         c. Main content area:
            - Breadcrumb: COP Reader > Encyclopedia > Chapter {N}
            - Chapter title as h1 with formal styling: `text-3xl font-bold text-slate-900 md:text-4xl`
            - ArticleVersionBanner below title
            - Visual separator (hr)
            - Map sections through ArticleContent component
            - Bottom spacer
         d. Floating back-to-top button (same pattern as ChapterContent)
       - Uses existing useScrollspy hook from components/cop/use-scrollspy.ts
       - Uses existing useHashScroll hook from components/cop/use-hash-scroll.ts
       - Flattens section IDs same way as ChapterContent

    4. Update `app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx`:
       - Replace the placeholder content rendering with ArticleRenderer component
       - Import ArticleRenderer from @/components/encyclopedia/ArticleRenderer
       - Pass chapterData and supplementaryContent as props
       - Keep all the server-side data loading (fs.readFileSync, getSupplementaryContent) unchanged
       - Keep back navigation link pointing to /encyclopedia/cop
  </action>
  <verify>
    - `npm run build` completes without errors
    - /encyclopedia/cop/8 renders Chapter 8 with:
      - TOC sidebar on desktop with scrollspy
      - Section numbers as prominent anchors
      - Prose typography styling
      - Version banner below title
      - Mobile TOC drawer on small screens
    - /encyclopedia/cop/8#section-8.5.4 scrolls to section 8.5.4
    - Hovering over a section heading shows link icon for deep-linking
  </verify>
  <done>
    Complete ArticleRenderer suite renders COP chapters as continuous prose articles with TOC sidebar, scrollspy, deep-link anchors, version banner, and legislative typography.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. /encyclopedia/cop/1 renders with ArticleRenderer (TOC sidebar, prose styling, version banner)
3. /encyclopedia/cop/8 renders all sections with heading hierarchy (h2-h6)
4. Section numbers display prominently with mono font and select-all for easy citation copying
5. Hovering headings shows anchor link icon
6. Scrollspy highlights active section in TOC as user scrolls
7. Mobile drawer opens/closes correctly
8. Back-to-top button appears after scrolling
9. Version banner shows "Version 25.12 — 1 December 2025" and "Published by Master Roofers NZ"
</verification>

<success_criteria>
- Legislative typography: formal section numbers, hierarchical headings, high-contrast prose
- Deep-link anchors with shareable URLs via heading hover links
- Version identification visible for MBIE citation validity
- TOC sidebar with scrollspy on desktop, drawer on mobile
- Continuous prose rendering with whitespace-pre-line content
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/29-foundation-article-architecture/29-02-SUMMARY.md`
</output>
