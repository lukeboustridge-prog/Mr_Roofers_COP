---
phase: 29-foundation-article-architecture
plan: 03
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - types/encyclopedia.ts
  - lib/encyclopedia/substrate-config.ts
  - app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Content architecture supports substrate parameter with metal roofing populated"
    - "URL supports ?substrate=profiled-metal query parameter"
    - "Substrate config provides metadata (name, description, COP chapters) for each substrate"
    - "Architecture is ready for future substrates without route changes"
  artifacts:
    - path: "types/encyclopedia.ts"
      provides: "Encyclopedia type definitions including substrate types"
      exports: ["SubstrateConfig", "EncyclopediaArticle"]
      min_lines: 20
    - path: "lib/encyclopedia/substrate-config.ts"
      provides: "Substrate configuration with chapter mappings"
      exports: ["getSubstrateConfig", "getAllSubstrates", "DEFAULT_SUBSTRATE"]
      min_lines: 30
  key_links:
    - from: "app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx"
      to: "lib/encyclopedia/substrate-config.ts"
      via: "import for substrate resolution"
      pattern: "getSubstrateConfig|DEFAULT_SUBSTRATE"
    - from: "lib/encyclopedia/substrate-config.ts"
      to: "types/encyclopedia.ts"
      via: "type import"
      pattern: "SubstrateConfig"
---

<objective>
Create substrate-aware content architecture with TypeScript types and substrate configuration that supports the current metal roofing COP and is extensible for future substrates (concrete tile, membrane, etc.) without route changes.

Purpose: Fulfill SUBSTRATE-01 by establishing the substrate parameter pattern from the foundation. Metal roofing is populated as the first and default substrate. The architecture supports adding future substrates by adding config entries without modifying routes or components.

Output: Encyclopedia types, substrate config module, chapter page reading substrate from URL query parameter.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-foundation-article-architecture/29-01-SUMMARY.md

@types/cop.ts
@lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create encyclopedia types and substrate configuration</name>
  <files>
    types/encyclopedia.ts
    lib/encyclopedia/substrate-config.ts
  </files>
  <action>
    1. Create `types/encyclopedia.ts`:
       ```typescript
       /**
        * Encyclopedia type definitions
        * Supports substrate-aware content architecture for the COP encyclopedia
        */

       /** Substrate identifier — matches database substrate IDs */
       export type SubstrateId =
         | 'profiled-metal'
         | 'pressed-metal'
         | 'concrete-tile'
         | 'clay-tile'
         | 'membrane'
         | 'shingle';

       /** Configuration for a substrate within the encyclopedia */
       export interface SubstrateConfig {
         id: SubstrateId;
         name: string;
         shortName: string;
         description: string;
         /** COP source identifier (matches content_sources.id) */
         copSourceId: string;
         /** Which COP chapters apply to this substrate (all 19 for metal) */
         chapters: number[];
         /** Whether content is populated and ready */
         isPopulated: boolean;
       }

       /** Article metadata for an encyclopedia page */
       export interface EncyclopediaArticle {
         chapterNumber: number;
         title: string;
         version: string;
         sectionCount: number;
         substrate: SubstrateId;
         /** ISO date of COP edition (for citation) */
         editionDate: string;
         /** Source identifier for authority attribution */
         sourceId: string;
       }
       ```

    2. Create `lib/encyclopedia/substrate-config.ts`:
       ```typescript
       import type { SubstrateConfig, SubstrateId } from '@/types/encyclopedia';

       /**
        * Substrate configurations for the encyclopedia
        *
        * Metal roofing is the first and only populated substrate.
        * Future substrates will be added here as content is ingested.
        */
       const SUBSTRATE_CONFIGS: Record<SubstrateId, SubstrateConfig> = {
         'profiled-metal': {
           id: 'profiled-metal',
           name: 'Profiled Metal Roofing',
           shortName: 'Metal',
           description: 'NZ Metal Roof and Wall Cladding Code of Practice',
           copSourceId: 'mrm-cop',
           chapters: Array.from({ length: 19 }, (_, i) => i + 1),
           isPopulated: true,
         },
         'pressed-metal': {
           id: 'pressed-metal',
           name: 'Pressed Metal Tiles',
           shortName: 'Pressed Metal',
           description: 'Pressed metal tile roofing systems',
           copSourceId: 'mrm-cop',
           chapters: [],
           isPopulated: false,
         },
         'concrete-tile': {
           id: 'concrete-tile',
           name: 'Concrete Tile Roofing',
           shortName: 'Concrete Tile',
           description: 'Concrete roof tile systems',
           copSourceId: '',
           chapters: [],
           isPopulated: false,
         },
         'clay-tile': {
           id: 'clay-tile',
           name: 'Clay Tile Roofing',
           shortName: 'Clay Tile',
           description: 'Clay roof tile systems',
           copSourceId: '',
           chapters: [],
           isPopulated: false,
         },
         'membrane': {
           id: 'membrane',
           name: 'Membrane Roofing',
           shortName: 'Membrane',
           description: 'Membrane roofing systems',
           copSourceId: '',
           chapters: [],
           isPopulated: false,
         },
         'shingle': {
           id: 'shingle',
           name: 'Shingle Roofing',
           shortName: 'Shingle',
           description: 'Asphalt and composite shingle systems',
           copSourceId: '',
           chapters: [],
           isPopulated: false,
         },
       };

       /** Default substrate when none specified */
       export const DEFAULT_SUBSTRATE: SubstrateId = 'profiled-metal';

       /** Get config for a specific substrate */
       export function getSubstrateConfig(id: SubstrateId): SubstrateConfig {
         return SUBSTRATE_CONFIGS[id];
       }

       /** Get all substrate configs */
       export function getAllSubstrates(): SubstrateConfig[] {
         return Object.values(SUBSTRATE_CONFIGS);
       }

       /** Get only populated substrates (ready for display) */
       export function getPopulatedSubstrates(): SubstrateConfig[] {
         return Object.values(SUBSTRATE_CONFIGS).filter(s => s.isPopulated);
       }

       /** Validate a string is a valid substrate ID */
       export function isValidSubstrate(id: string): id is SubstrateId {
         return id in SUBSTRATE_CONFIGS;
       }
       ```
  </action>
  <verify>
    - TypeScript compiles without errors
    - `getSubstrateConfig('profiled-metal')` returns metal config with 19 chapters
    - `getPopulatedSubstrates()` returns only profiled-metal
    - `isValidSubstrate('profiled-metal')` returns true
    - `isValidSubstrate('unknown')` returns false
  </verify>
  <done>
    Encyclopedia types and substrate config exist with metal roofing as the populated default substrate and architecture supporting future substrate additions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire substrate parameter into encyclopedia chapter page</name>
  <files>
    app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
  </files>
  <action>
    1. Update `app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx` to accept substrate query parameter:
       - Add `searchParams` to the page props: `searchParams: Promise<{ substrate?: string }>`
       - Resolve substrate: read `substrate` from searchParams, validate with `isValidSubstrate()`, fall back to DEFAULT_SUBSTRATE
       - Get substrate config: `const substrateConfig = getSubstrateConfig(resolvedSubstrate)`
       - Validate chapter is in substrate's chapters array: if `!substrateConfig.chapters.includes(chapterNum)` then notFound()
       - Pass substrate info to ArticleRenderer (if it exists from Plan 02) or the content area:
         - Add `substrateName={substrateConfig.shortName}` and `substrateId={substrateConfig.id}` props
       - Update the ArticleVersionBanner (or where version is shown) to include substrate context:
         - e.g., "Profiled Metal Roofing — Version 25.12 — 1 December 2025"

    2. If ArticleRenderer exists (from Plan 02), update its props interface to accept:
       ```typescript
       substrateId?: SubstrateId;
       substrateName?: string;
       ```
       And pass these through to ArticleVersionBanner. If ArticleRenderer doesn't exist yet (Plan 02 hasn't run), add the substrate info to whatever rendering exists.

    3. The substrate parameter is additive — default behavior (no ?substrate param) shows metal roofing content, which is the same as ?substrate=profiled-metal.
  </action>
  <verify>
    - `npm run build` passes
    - /encyclopedia/cop/8 renders metal roofing content (default substrate)
    - /encyclopedia/cop/8?substrate=profiled-metal renders same content with explicit substrate
    - /encyclopedia/cop/8?substrate=concrete-tile returns 404 (not populated, no chapters)
    - /encyclopedia/cop/8?substrate=invalid falls back to default substrate (profiled-metal)
    - Version banner shows substrate name in context
  </verify>
  <done>
    Encyclopedia chapter page reads substrate from URL query parameter, validates against substrate config, and renders content for the resolved substrate. Architecture supports future substrates without route changes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. types/encyclopedia.ts exports SubstrateConfig and EncyclopediaArticle types
3. lib/encyclopedia/substrate-config.ts exports getSubstrateConfig, getAllSubstrates, DEFAULT_SUBSTRATE
4. /encyclopedia/cop/8 renders with default metal roofing substrate
5. /encyclopedia/cop/8?substrate=profiled-metal renders explicitly with metal substrate
6. Unpopulated substrates return 404 for chapters
7. Invalid substrate params fall back to default
</verification>

<success_criteria>
- Substrate-aware content architecture established with types and config
- Metal roofing is populated default substrate
- URL query parameter supports explicit substrate selection
- Unpopulated substrates are gracefully handled (404)
- Architecture extensible for future substrates without route changes
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/29-foundation-article-architecture/29-03-SUMMARY.md`
</output>
