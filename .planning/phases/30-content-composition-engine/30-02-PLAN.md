---
phase: 30-content-composition-engine
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - components/encyclopedia/PracticalGuidanceBlock.tsx
  - components/encyclopedia/InlineCaseLawCallout.tsx
  - components/encyclopedia/ArticleContent.tsx
  - app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
autonomous: true

must_haves:
  truths:
    - "HTG guide content appears within COP articles as clearly-labeled Practical Guidance blocks with RANZ HTG source attribution"
    - "Supplementary content (HTG, details, case law) is visually distinct from authoritative COP text"
    - "Authority hierarchy is enforced: MRM COP text renders as default prose, RANZ HTG in emerald-accented blocks, case law in amber-accented callouts"
    - "Source attribution is always visible on non-authoritative content blocks"
    - "Metal roofing content renders with all composed supplementary data (details, HTG content, case law)"
  artifacts:
    - path: "components/encyclopedia/PracticalGuidanceBlock.tsx"
      provides: "Inline Practical Guidance block rendering HTG full-text content with source badge"
      min_lines: 40
    - path: "components/encyclopedia/InlineCaseLawCallout.tsx"
      provides: "Inline case law callout with case ID, summary, outcome, PDF link"
      min_lines: 35
    - path: "components/encyclopedia/ArticleContent.tsx"
      provides: "Updated recursive section renderer consuming ComposedSupplementary"
      contains: "PracticalGuidanceBlock"
    - path: "app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx"
      provides: "Chapter page using composeArticleContent instead of getSupplementaryContent"
      contains: "composeArticleContent"
  key_links:
    - from: "app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx"
      to: "lib/encyclopedia/article-composer.ts"
      via: "imports composeArticleContent"
      pattern: "composeArticleContent"
    - from: "components/encyclopedia/ArticleContent.tsx"
      to: "components/encyclopedia/PracticalGuidanceBlock.tsx"
      via: "renders HtgGuidanceBlock data"
      pattern: "PracticalGuidanceBlock"
    - from: "components/encyclopedia/ArticleContent.tsx"
      to: "components/encyclopedia/InlineCaseLawCallout.tsx"
      via: "renders InlineCaseLaw data"
      pattern: "InlineCaseLawCallout"
---

<objective>
Create the rendering components for composed supplementary content and wire the article composer into the encyclopedia chapter page, delivering the complete content composition engine with visual authority hierarchy.

Purpose: The data layer (Plan 01) provides enriched supplementary data. This plan builds the UI to display HTG content as "Practical Guidance" blocks, failure cases as inline callouts, and updates the chapter page to use the parallel-fetching article composer.

Output: PracticalGuidanceBlock + InlineCaseLawCallout components, updated ArticleContent and chapter page
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-content-composition-engine/30-01-SUMMARY.md

Key files to reference:
@components/encyclopedia/ArticleContent.tsx - Current recursive section renderer
@components/encyclopedia/ArticleRenderer.tsx - Client wrapper with TOC and scrollspy
@app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx - Current chapter page with getSupplementaryContent
@lib/encyclopedia/article-composer.ts - Article composer from Plan 01
@types/encyclopedia.ts - ComposedSupplementary, HtgGuidanceBlock, InlineCaseLaw types
@components/authority/SupplementaryContent.tsx - Grey-bordered wrapper for supplementary content
@components/authority/SourceBadge.tsx - Authority-aware source badge component
@components/cop/SupplementaryPanel.tsx - Existing collapsible panel component
@components/cop/SupplementaryDetailCard.tsx - Existing detail card component
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PracticalGuidanceBlock and InlineCaseLawCallout components</name>
  <files>components/encyclopedia/PracticalGuidanceBlock.tsx, components/encyclopedia/InlineCaseLawCallout.tsx</files>
  <action>
**1. Create `components/encyclopedia/PracticalGuidanceBlock.tsx`**

Server Component (no 'use client'). Renders HTG content as an inline "Practical Guidance" block within the article flow.

Visual design:
- Emerald-green left border (border-l-4 border-emerald-400) on white/emerald-50 background
- Top bar: "Practical Guidance" label (emerald-600 text, uppercase, xs font, tracking-wide) + RANZ HTG source badge via SourceBadge component (authority="supplementary")
- Guide name as semi-bold heading (text-sm font-semibold text-slate-900)
- Content text rendered with whitespace-pre-line for line breaks (text-sm text-slate-700 leading-relaxed)
- Content should be collapsed by default if > 300 chars (use a client-side expandable wrapper OR just show full content since progressive disclosure was decided as "collapsed by default" for supplementary panels). Since this is a Server Component, render full content but wrap in the existing SupplementaryContent component pattern. However, SupplementaryContent is 'use client'. Instead, build the styling directly:
  - Use a div with `rounded-lg border-l-4 border-emerald-400 bg-emerald-50/50 p-4 mt-4 mb-2`
  - Top row: flex with "Practical Guidance" label + source badge showing "RANZ HTG"
  - Below: guide name as heading, then content text
- If content is null/empty, show just the guide name with a note "See source document" + sourceDocument reference
- PDF page reference: small text "Source: {sourceDocument}, p.{pdfPage}" at bottom

Props: `{ guidance: HtgGuidanceBlock }` from types/encyclopedia.ts

Import SourceBadge from '@/components/authority'. Note: SourceBadge is 'use client' — that's fine, Server Components can render Client Components.

**2. Create `components/encyclopedia/InlineCaseLawCallout.tsx`**

Server Component (no 'use client'). Renders a failure case as an inline callout annotation.

Visual design:
- Amber left border (border-l-4 border-amber-400) on amber-50/50 background
- Top bar: case type label ("MBIE Determination" or "LBP Complaint" based on caseType) in amber-700, uppercase xs text + outcome badge
- Outcome badge: "Upheld" (red-100/red-700), "Partially Upheld" (amber-100/amber-700), "Dismissed" (green-100/green-700) — small inline badge
- Case ID displayed prominently (font-mono text-sm text-amber-900)
- Summary text (text-sm text-slate-700, line-clamp-3 by default)
- If pdfUrl exists: "View determination" link (text-amber-700 hover:text-amber-900, underline) using Link component pointing to the pdfUrl

Props: `{ caseLaw: InlineCaseLaw }` from types/encyclopedia.ts

Wrapper div: `rounded-lg border-l-4 border-amber-400 bg-amber-50/50 p-4 mt-4 mb-2`

Authority hierarchy visual summary:
- MRM COP text: default prose (slate-700, no accent border) — PRIMARY
- RANZ HTG: emerald accent (border-emerald-400, bg-emerald-50/50) — SUPPLEMENTARY
- Case Law: amber accent (border-amber-400, bg-amber-50/50) — SUPPLEMENTARY
- Existing detail cards: grey accent via SupplementaryContent wrapper — SUPPLEMENTARY
  </action>
  <verify>
`npx tsc --noEmit` passes. Both components render without errors. SourceBadge import resolves correctly. Check that InlineCaseLawCallout handles null summary and null pdfUrl gracefully (conditional rendering).
  </verify>
  <done>
Two new encyclopedia components exist: PracticalGuidanceBlock (emerald accent, RANZ HTG source badge, full text rendering) and InlineCaseLawCallout (amber accent, case type label, outcome badge, PDF link). Both follow the authority hierarchy visual design.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ArticleContent and chapter page to use article composer</name>
  <files>components/encyclopedia/ArticleContent.tsx, app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx</files>
  <action>
**Step 1: Update ArticleContent.tsx**

Change the component to consume `ComposedSupplementary` instead of `SupplementaryData`:

1. Update import: Replace `SupplementaryData` from `@/types/cop` with `ComposedSupplementary` from `@/types/encyclopedia`
2. Update interface: `supplementaryContent?: Record<string, ComposedSupplementary>`
3. Add imports for new components: `PracticalGuidanceBlock` and `InlineCaseLawCallout`

In the supplementary content rendering section (currently lines ~67-104), restructure the rendering order to enforce authority hierarchy:

```
{/* Authority hierarchy rendering order */}

{/* 1. HTG Practical Guidance blocks (emerald, inline content) — render BEFORE collapsible panels */}
{supplements.htgContent?.length > 0 && supplements.htgContent.map(guidance => (
  <PracticalGuidanceBlock key={guidance.id} guidance={guidance} />
))}

{/* 2. Case Law callouts (amber, inline content) */}
{supplements.caseLaw?.length > 0 && supplements.caseLaw.map(caseLaw => (
  <InlineCaseLawCallout key={caseLaw.id} caseLaw={caseLaw} />
))}

{/* 3. Related Installation Details (existing grey collapsible panel) */}
{supplements.details?.length > 0 && (
  <SupplementaryPanel title="Related Installation Details">
    ...existing detail card rendering...
  </SupplementaryPanel>
)}

{/* 4. Related HTG Guides links (existing grey collapsible panel — keep for navigation) */}
{supplements.htgGuides?.length > 0 && (
  <SupplementaryPanel title="Related HTG Guides">
    ...existing HTG link rendering...
  </SupplementaryPanel>
)}
```

The key change: HTG content text (PracticalGuidanceBlock) renders inline and visible by default, while the existing HTG guide links (SupplementaryPanel) remain as collapsible navigation aids. This is NOT duplication — the PracticalGuidanceBlock shows the actual guide text, while the HTG guide links provide navigation to the full standalone guide page.

**Step 2: Update chapter page to use article composer**

In `app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx`:

1. Replace import of `getSupplementaryContent` with `composeArticleContent` from `@/lib/encyclopedia/article-composer`
2. Replace the supplementary content fetch section:

Before:
```typescript
const supplementaryMap = await getSupplementaryContent(chapterNum);
const supplementaryContent: Record<...> = {};
supplementaryMap.forEach((value, key) => {
  supplementaryContent[key] = value;
});
```

After:
```typescript
const composedContent = await composeArticleContent(chapterNum);
```

3. Pass `composedContent` instead of `supplementaryContent` to ArticleRenderer:
```typescript
<ArticleRenderer
  chapterData={chapterData}
  supplementaryContent={composedContent}
  substrateId={resolvedSubstrate}
  substrateName={substrateConfig.shortName}
/>
```

**Step 3: Update ArticleRenderer.tsx props**

Update the `ArticleRendererProps` interface to use `ComposedSupplementary` instead of `SupplementaryData`:
```typescript
import type { ComposedSupplementary } from '@/types/encyclopedia';
// ...
supplementaryContent?: Record<string, ComposedSupplementary>;
```

Remove the `SupplementaryData` import from `@/types/cop` (keep CopChapter and CopSection imports).

This is a prop type change only — ArticleRenderer passes supplementaryContent straight through to ArticleContent, which now handles the new structure.
  </action>
  <verify>
`npm run build` passes with 0 errors. Navigate to `/encyclopedia/cop/8` (Chapter 8: External Moisture Flashings — a chapter with rich supplementary content). Verify:
1. Page renders without errors
2. HTG content appears inline as emerald-bordered "Practical Guidance" blocks (if HTG content exists for sections in chapter 8)
3. Case law callouts appear inline as amber-bordered blocks (if failure cases link through details to chapter 8 sections)
4. Existing detail cards still render in grey collapsible panels
5. Authority hierarchy is visually clear: MRM COP text is default, supplementary content is accent-bordered
  </verify>
  <done>
ArticleContent renders composed supplementary data with authority hierarchy: HTG full text as "Practical Guidance" (emerald), case law as callouts (amber), detail cards in grey panels. Chapter page uses article composer for parallel data fetching. All supplementary content has visible source attribution. Metal roofing content is fully populated via the composed data pipeline.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with 0 errors
2. Chapter page at `/encyclopedia/cop/8` loads and renders composed content
3. PracticalGuidanceBlock shows with emerald accent, "Practical Guidance" label, RANZ HTG source badge
4. InlineCaseLawCallout shows with amber accent, case ID, outcome badge, PDF link
5. Existing detail cards still render in grey collapsible SupplementaryPanel
6. Authority hierarchy visually clear: MRM COP primary (no accent), HTG supplementary (emerald), case law (amber), details (grey)
7. Source attribution visible on all non-authoritative blocks
8. No regressions in existing encyclopedia functionality (TOC, scrollspy, deep-linking)
</verification>

<success_criteria>
- HTG guide content appears within COP articles as clearly-labeled "Practical Guidance" blocks (MERGE-01)
- Supplementary content visually distinct from authoritative COP text with source attribution (MERGE-02)
- Article composer fetches from cop_sections + htg_content + details + failure_cases in parallel (MERGE-03)
- Authority hierarchy enforced: MRM COP primary, MBIE secondary, RANZ HTG supplementary (MERGE-04)
- Metal roofing content fully populated and functional as launch substrate (SUBSTRATE-02)
- Build passes with 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/30-content-composition-engine/30-02-SUMMARY.md`
</output>
