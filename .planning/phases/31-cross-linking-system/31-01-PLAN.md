---
phase: 31-cross-linking-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/encyclopedia/reference-resolver.ts
  - lib/encyclopedia/cross-link-engine.ts
  - types/encyclopedia.ts
autonomous: true

must_haves:
  truths:
    - "ReferenceResolver provides O(1) lookup from any section number to its encyclopedia URL"
    - "CrossLinkEngine detects section references like 'See 8.5.4', 'refer to Section 3.7', 'Section 12.3.2' in plain text"
    - "Link density is controlled: max 5 links per paragraph, first-mention-only per section"
    - "Unresolvable section references (not in the Map) are left as plain text"
  artifacts:
    - path: "lib/encyclopedia/reference-resolver.ts"
      provides: "In-memory Map<sectionNumber, url> with O(1) lookup"
      exports: ["resolveReference", "buildReferenceMap", "ReferenceMap"]
    - path: "lib/encyclopedia/cross-link-engine.ts"
      provides: "Text-to-React-nodes transformer with link budget and first-mention-only"
      exports: ["crossLinkContent"]
    - path: "types/encyclopedia.ts"
      provides: "CrossLinkResult type"
      contains: "CrossLinkSegment"
  key_links:
    - from: "lib/encyclopedia/reference-resolver.ts"
      to: "public/cop/chapter-{N}.json"
      via: "Reads all 19 chapter JSONs to extract section numbers"
      pattern: "chapter-\\d+\\.json"
    - from: "lib/encyclopedia/cross-link-engine.ts"
      to: "lib/encyclopedia/reference-resolver.ts"
      via: "Uses resolveReference for O(1) lookup during text parsing"
      pattern: "resolveReference"
---

<objective>
Build the ReferenceResolver and CrossLinkEngine — the core data layer and text processing engine for COP cross-linking.

Purpose: Enable automatic detection of section references in COP text (e.g., "See 8.5.4", "refer to Section 3.7") and resolve them to clickable encyclopedia URLs, with strict link density controls.

Output: Two library modules — reference-resolver.ts for O(1) section-to-URL mapping, and cross-link-engine.ts for regex-based text parsing with link budget enforcement.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@types/encyclopedia.ts
@types/cop.ts
@lib/encyclopedia/article-composer.ts
@components/encyclopedia/ArticleContent.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReferenceResolver with in-memory Map for O(1) section-to-URL lookup</name>
  <files>
    lib/encyclopedia/reference-resolver.ts
    types/encyclopedia.ts
  </files>
  <action>
Create `lib/encyclopedia/reference-resolver.ts` that builds an in-memory Map from section numbers to encyclopedia URLs.

**ReferenceMap type:** `Map<string, string>` where key = section number (e.g., "8.5.4"), value = URL path (e.g., "/encyclopedia/cop/8#section-8.5.4").

**`buildReferenceMap()` function:**
- Reads all 19 `public/cop/chapter-{N}.json` files using `fs.readFileSync`
- Recursively walks all sections and subsections
- Extracts `section.number` and maps to `/encyclopedia/cop/{chapterNumber}#section-{sectionNumber}`
- Returns the populated Map
- Uses module-level singleton pattern: builds once on first call, returns cached Map on subsequent calls
- **Critical:** This runs server-side only (uses `fs`). Must NOT be imported in client components.

**`resolveReference(sectionNumber: string)` function:**
- Takes a section number string (e.g., "8.5.4", "3.7", "8.5.4B")
- Returns URL path string or `null` if section doesn't exist
- Uses the singleton Map for O(1) lookup
- Also handles chapter-only references (e.g., "8" maps to "/encyclopedia/cop/8")

**Edge cases to handle:**
- Section numbers with letter suffixes (e.g., "8.5.4A", "8.2A", "8.4C") — these are valid section numbers in the COP
- Single-level chapter references (e.g., "6", "9") — map to `/encyclopedia/cop/{N}`
- Sections that don't exist in the Map — return null (caller leaves as plain text)

Add `ReferenceMap` type alias to `types/encyclopedia.ts`.

Expected Map size: ~1,121 entries (~56KB memory). Acceptable for server-side singleton.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify the file exists and exports are correct:
```
node -e "const m = require('./lib/encyclopedia/reference-resolver'); console.log(typeof m.buildReferenceMap, typeof m.resolveReference)"
```
(This won't work directly due to TS/ESM, but the build check covers type correctness.)
  </verify>
  <done>
ReferenceResolver module exists with buildReferenceMap() returning a Map of ~1,121 entries and resolveReference() providing O(1) lookup. Singleton pattern ensures Map is built once.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CrossLinkEngine with regex detection, link budget, and first-mention-only rule</name>
  <files>
    lib/encyclopedia/cross-link-engine.ts
    types/encyclopedia.ts
  </files>
  <action>
Create `lib/encyclopedia/cross-link-engine.ts` that transforms COP plain text content into an array of segments (text or link) for React rendering.

**Add to `types/encyclopedia.ts`:**
```typescript
/** A segment of cross-linked content — either plain text or a hyperlink */
export type CrossLinkSegment =
  | { type: 'text'; content: string }
  | { type: 'link'; content: string; href: string; sectionNumber: string };
```

**`crossLinkContent(text: string, referenceMap: ReferenceMap)` function:**

1. **Regex pattern** — single combined pattern matching all reference formats found in the COP content:
   - `See \d+\.\d+[\d.]*[A-Z]?` (e.g., "See 8.5.4", "See 4.9.4", "see 8.5.4B")
   - `(?:refer to|Refer to)\s+(?:Section\s+)?\d+\.[\d.]*[A-Z]?` (e.g., "refer to Section 3.7")
   - `(?:as specified in|as described in)\s+\d+\.[\d.]*[A-Z]?` (e.g., "as specified in 5.1A")
   - `Section\s+\d+\.[\d.]*[A-Z]?` (e.g., "Section 12.3.2")
   - Bare section number references at start of sentences: `^(\d+\.\d+[\d.]*[A-Z]?)\s+` (e.g., "8.5.4A Chased Apron and 8.5.4C Angle Diverter")

   Combined into one regex with alternation for efficient single-pass matching. Case-insensitive for "see"/"See"/"SEE" etc.

   **Extract the section number** from each match (the numeric part like "8.5.4", "3.7", "8.5.4B").

2. **Resolution:** For each matched reference, call `resolveReference(sectionNumber)`. If null, leave as plain text.

3. **First-mention-only rule:** Track which section numbers have already been linked (Set<string>). Only create a link for the FIRST occurrence of each unique section number within the text. Subsequent mentions of the same section number stay as plain text.

4. **Link budget:** Maximum 5 links per paragraph. Content uses `\n\n` as paragraph delimiter. Split text by `\n\n`, process each paragraph independently with its own link counter (max 5), then rejoin. The first-mention Set persists across paragraphs (so a section linked in paragraph 1 won't be linked again in paragraph 3).

5. **Return type:** `CrossLinkSegment[]` — array of text and link segments. Adjacent text segments should be merged for efficiency.

**Important:** The function is pure (no side effects, no I/O). It takes the ReferenceMap as a parameter so it can be used server-side during rendering.

**Performance:** Single-pass regex matching + Map lookups = O(n) where n = text length. No DOM manipulation.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. The module should export crossLinkContent function.
  </verify>
  <done>
CrossLinkEngine detects all section reference patterns found in COP content, enforces max 5 links per paragraph, applies first-mention-only rule, and returns CrossLinkSegment[] for React rendering. Unresolvable references left as plain text.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. reference-resolver.ts exports buildReferenceMap and resolveReference
3. cross-link-engine.ts exports crossLinkContent
4. types/encyclopedia.ts includes CrossLinkSegment and ReferenceMap types
5. No client-side imports of reference-resolver.ts (it uses fs)
</verification>

<success_criteria>
- ReferenceResolver builds Map from 19 chapter JSONs with O(1) lookup
- CrossLinkEngine detects "See X.Y.Z", "refer to Section X.Y", "Section X.Y.Z", bare "X.Y.Z" patterns
- Link budget enforced: max 5 links per paragraph
- First-mention-only: each section number linked only on first occurrence
- Unresolvable references remain plain text
- All types exported from types/encyclopedia.ts
</success_criteria>

<output>
After completion, create `.planning/phases/31-cross-linking-system/31-01-SUMMARY.md`
</output>
