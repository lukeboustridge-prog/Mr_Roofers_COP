---
phase: 31-cross-linking-system
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - components/encyclopedia/ArticleContent.tsx
  - components/encyclopedia/CrossLinkedText.tsx
  - app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
autonomous: true

must_haves:
  truths:
    - "COP section references in article text render as clickable blue hyperlinks to the correct encyclopedia URL"
    - "Clicking a cross-link navigates to the correct chapter and scrolls to the referenced section"
    - "Link density is visually controlled — no paragraph has more than 5 blue links"
    - "Cross-links between COP articles and Installation Guide details are bidirectional via SupplementaryDetailCard links"
    - "ReferenceMap is built once at the page level and passed down through props"
  artifacts:
    - path: "components/encyclopedia/CrossLinkedText.tsx"
      provides: "Server component rendering CrossLinkSegment[] as React elements with Next.js Link"
      exports: ["CrossLinkedText"]
    - path: "components/encyclopedia/ArticleContent.tsx"
      provides: "Updated to use CrossLinkedText instead of plain text div"
      contains: "CrossLinkedText"
    - path: "app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx"
      provides: "Builds ReferenceMap once and passes via props"
      contains: "buildReferenceMap"
  key_links:
    - from: "components/encyclopedia/CrossLinkedText.tsx"
      to: "lib/encyclopedia/cross-link-engine.ts"
      via: "Calls crossLinkContent to get segments"
      pattern: "crossLinkContent"
    - from: "components/encyclopedia/ArticleContent.tsx"
      to: "components/encyclopedia/CrossLinkedText.tsx"
      via: "Renders CrossLinkedText instead of plain text div"
      pattern: "CrossLinkedText"
    - from: "app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx"
      to: "lib/encyclopedia/reference-resolver.ts"
      via: "Calls buildReferenceMap at page level, passes to ArticleRenderer"
      pattern: "buildReferenceMap"
---

<objective>
Wire the cross-linking engine into the encyclopedia article rendering pipeline so COP section references become clickable hyperlinks.

Purpose: Transform static text references like "See 8.5.4" into interactive navigation links, enabling Wikipedia-style interconnection between COP sections while maintaining controlled link density.

Output: CrossLinkedText component, updated ArticleContent with cross-linking, and page-level ReferenceMap initialization.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/31-cross-linking-system/31-01-SUMMARY.md
@components/encyclopedia/ArticleContent.tsx
@components/encyclopedia/ArticleRenderer.tsx
@app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
@types/encyclopedia.ts
@lib/encyclopedia/reference-resolver.ts
@lib/encyclopedia/cross-link-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CrossLinkedText component and integrate into ArticleContent</name>
  <files>
    components/encyclopedia/CrossLinkedText.tsx
    components/encyclopedia/ArticleContent.tsx
    types/encyclopedia.ts
  </files>
  <action>
**Create `components/encyclopedia/CrossLinkedText.tsx`** — a Server Component (no 'use client') that renders cross-linked COP text:

```typescript
import Link from 'next/link';
import type { CrossLinkSegment } from '@/types/encyclopedia';
import { crossLinkContent } from '@/lib/encyclopedia/cross-link-engine';

interface CrossLinkedTextProps {
  content: string;
  referenceMap: Map<string, string>;
}
```

1. Calls `crossLinkContent(content, referenceMap)` to get `CrossLinkSegment[]`
2. Maps segments to React elements:
   - `type: 'text'` → `<span>` with `whitespace-pre-line` for line break preservation
   - `type: 'link'` → `<Link>` (next/link) with:
     - `href` from segment
     - Styling: `text-primary hover:text-primary/80 underline decoration-primary/30 hover:decoration-primary/60 transition-colors` (subtle blue, not aggressive)
     - `title` attribute: `"Go to Section {sectionNumber}"` for accessibility
     - The matched text as children (preserves original wording like "See 8.5.4" or "Section 3.7")
3. Wraps all segments in a container `<div>` with `whitespace-pre-line text-slate-700 leading-relaxed` (matching existing prose styling from ArticleContent)

**IMPORTANT:** The `referenceMap` prop is a `Map<string, string>`. Since this is a Server Component rendering Server Component children, the Map can be passed directly (no serialization needed). However, ArticleRenderer is a Client Component, so the Map must be serialized to a plain object at the page level and reconstructed. See Task 2 for this wiring.

Actually, looking at the architecture more carefully: ArticleContent is a Server Component (no 'use client'), and it's rendered inside ArticleRenderer which IS a 'use client' component. But Server Components can be children of Client Components when passed as props or rendered by the server.

**The correct approach:** Since `Map` cannot cross the Client/Server boundary as a prop, we need to serialize the ReferenceMap to a `Record<string, string>` at the page level (like we do for supplementaryContent). Then CrossLinkedText accepts `referenceMap: Record<string, string>` and crossLinkContent accepts the same type.

**Update `types/encyclopedia.ts`:** Change `ReferenceMap` type alias to `Record<string, string>` (not `Map`), since it must be serializable for the Client/Server component boundary.

**Update `components/encyclopedia/ArticleContent.tsx`:**
- Add `referenceMap?: Record<string, string>` to ArticleContentProps
- Replace the plain text content rendering block:
  ```tsx
  {/* OLD */}
  <div className="whitespace-pre-line text-slate-700 leading-relaxed">
    {section.content}
  </div>

  {/* NEW */}
  {referenceMap ? (
    <CrossLinkedText content={section.content} referenceMap={referenceMap} />
  ) : (
    <div className="whitespace-pre-line text-slate-700 leading-relaxed">
      {section.content}
    </div>
  )}
  ```
- Pass `referenceMap` through recursive subsection rendering
- This is a graceful fallback: if no referenceMap provided, renders plain text (backward compatible for non-encyclopedia usage)
  </action>
  <verify>
Run `npm run build` — no TypeScript errors. Verify CrossLinkedText.tsx exists and ArticleContent.tsx imports it.
  </verify>
  <done>
CrossLinkedText component renders cross-linked text with Next.js Link elements. ArticleContent conditionally uses it when referenceMap is provided, with plain text fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ReferenceMap through page → ArticleRenderer → ArticleContent pipeline</name>
  <files>
    app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx
    components/encyclopedia/ArticleRenderer.tsx
  </files>
  <action>
**Update `app/(dashboard)/encyclopedia/cop/[chapter]/page.tsx`:**
1. Import `buildReferenceMap` from `@/lib/encyclopedia/reference-resolver`
2. Call `buildReferenceMap()` in the page component (it returns a Map — convert to Record for serialization):
   ```typescript
   const referenceMap = buildReferenceMap();
   // Convert Map to Record for client/server serialization
   const referenceRecord: Record<string, string> = Object.fromEntries(referenceMap);
   ```
3. Pass `referenceMap={referenceRecord}` as a new prop to `<ArticleRenderer>`

**Update `components/encyclopedia/ArticleRenderer.tsx`:**
1. Add `referenceMap?: Record<string, string>` to `ArticleRendererProps`
2. Destructure in component: `{ chapterData, supplementaryContent, substrateName, referenceMap }`
3. Pass `referenceMap={referenceMap}` to each `<ArticleContent>` instance in the article content section

**Bidirectional linking (XLINK-02):**
The COP-to-detail direction is already handled by SupplementaryDetailCard which links to `/detail/{id}`. The detail-to-COP direction is handled by the existing "View in COP" banner on detail pages (from Phase 28). Cross-links from COP text to other COP sections are what this phase adds. The bidirectional Installation Guide links are scoped for Phase 34 per the roadmap. For this phase, XLINK-02 is satisfied by the existing SupplementaryDetailCard (COP → detail) and the "View in COP" banner (detail → COP section).

**No changes to ArticleTOC or other components** — cross-linking only affects the content text rendering path.
  </action>
  <verify>
1. `npm run build` passes with no TypeScript errors
2. Visit `/encyclopedia/cop/8` in dev server — section references like "See 8.5.4" should render as blue clickable links
3. Click a cross-link — should navigate to the correct chapter/section (e.g., clicking "See 4.9.4" navigates to `/encyclopedia/cop/4#section-4.9.4`)
4. Count links in text-heavy sections — no paragraph should have more than 5 blue links
5. Same section number referenced multiple times — only first occurrence is linked
  </verify>
  <done>
ReferenceMap built once at page level and passed through ArticleRenderer to ArticleContent to CrossLinkedText. Section references in COP text render as clickable hyperlinks. Link density controlled. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript errors
2. Encyclopedia chapter pages render section references as clickable links
3. Cross-links navigate correctly (e.g., "See 8.5.4" → /encyclopedia/cop/8#section-8.5.4)
4. Cross-chapter links work (e.g., in Chapter 8, "See 4.9.4" → /encyclopedia/cop/4#section-4.9.4)
5. Max 5 links per paragraph visually confirmed
6. First-mention-only: repeated references to same section not linked after first
7. Unresolvable references (typos, invalid numbers) remain as plain text
8. Existing supplementary panels (details, HTG, case law) unaffected
9. Non-encyclopedia pages (/cop/) unaffected (no referenceMap passed)
</verification>

<success_criteria>
- CrossLinkedText component renders segments as Link or span elements
- ArticleContent uses CrossLinkedText when referenceMap available, plain text otherwise
- ReferenceMap built once at page level, serialized as Record, passed through props
- Visual cross-links appear in encyclopedia article text
- All existing encyclopedia features (TOC, scrollspy, supplementary panels) still work
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/31-cross-linking-system/31-02-SUMMARY.md`
</output>
