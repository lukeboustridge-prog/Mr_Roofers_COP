---
phase: 19-data-pipeline-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/populate-detail-images.ts
  - scripts/populate-warnings.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "251 MRM detail records have their images array populated from the extraction manifest (detail_codes mapping + details.json fallback)"
    - "201 detail-mapped images from images_manifest.json are correctly associated with their detail records via detail_codes"
    - "574 section-only images (no detail_codes in manifest) are NOT written to any detail's images array"
    - "138 enhanced warnings from warnings_enhanced.json are inserted into warning_conditions table with correct detailId, severity, conditionType, conditionValue"
    - "Scripts are idempotent - running them again produces the same result without duplicates"
  artifacts:
    - path: "scripts/populate-detail-images.ts"
      provides: "Targeted image population script for detail records"
      exports: ["populateDetailImages"]
    - path: "scripts/populate-warnings.ts"
      provides: "Targeted warning population script from enhanced warnings JSON"
      exports: ["populateWarnings"]
  key_links:
    - from: "scripts/populate-detail-images.ts"
      to: "mrm_extract/images_manifest.json"
      via: "reads detail_codes array from manifest entries"
      pattern: "detail_codes"
    - from: "scripts/populate-detail-images.ts"
      to: "mrm_extract/r2_image_urls.json"
      via: "resolves filenames to full R2 URLs"
      pattern: "r2_image_urls"
    - from: "scripts/populate-warnings.ts"
      to: "mrm_extract/warnings_enhanced.json"
      via: "reads detailCode, conditionType, conditionValue, warningText, severity"
      pattern: "warnings_enhanced"
    - from: "scripts/populate-detail-images.ts"
      to: "lib/db/schema.ts"
      via: "updates details.images jsonb column"
      pattern: "details.*images"
    - from: "scripts/populate-warnings.ts"
      to: "lib/db/schema.ts"
      via: "inserts into warningConditions table"
      pattern: "warningConditions"
---

<objective>
Create and run two targeted database population scripts: one for mapping MRM extraction images to detail records, and one for populating enhanced warnings into the warning_conditions table.

Purpose: Phase 19's core data pipeline — all downstream phases (20-23) and UI features depend on images and warnings being in the database. The existing `import-mrm.ts` does a destructive full re-import; we need targeted scripts that update specific columns without wiping other data.

Output: Two npm scripts that populate images and warnings from extraction artifacts, run against the production database.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@mrm_extract/images_manifest.json
@mrm_extract/r2_image_urls.json
@mrm_extract/warnings_enhanced.json
@mrm_extract/details.json
@lib/db/schema.ts
@lib/db/import-mrm.ts
@scripts/backfill-detail-images.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create targeted image population script and run it</name>
  <files>scripts/populate-detail-images.ts, package.json</files>
  <action>
Create `scripts/populate-detail-images.ts` that populates the `images` jsonb column on detail records using two data sources:

**Data flow:**
1. Load `mrm_extract/images_manifest.json` (775 entries with filename, detail_codes[], section, dimensions)
2. Load `mrm_extract/r2_image_urls.json` (filename -> full R2 URL mapping)
3. Load `mrm_extract/details.json` (251 details with images[] filenames as fallback)

**Image-to-detail mapping logic (critical — IMG-03 compliance):**
- Build a Map<string, string[]> of detailCode -> image filenames from `images_manifest.json` by iterating all entries and checking `detail_codes` array
- Only images with non-empty `detail_codes` arrays get mapped to details (201 images have detail_codes)
- Images where `detail_codes` is empty stay section-only — do NOT write them to any detail's images array
- As a FALLBACK for details not covered by manifest mapping: use `details.json` images[] field (these are the filenames the extraction originally associated with each detail)
- Merge both sources: manifest detail_codes take priority, details.json fills gaps

**Detail ID generation:**
- MRM detail IDs follow the pattern: `lrm-{code.toLowerCase()}` (e.g., D01 -> lrm-d01, F07 -> lrm-f07)
- This matches the existing `generateDetailId` pattern in `import-mrm.ts` line 133-135

**Image URL resolution:**
- Each filename maps to a full R2 URL via `r2_image_urls.json`
- If a filename is NOT in the R2 manifest, skip it (image not uploaded yet)
- Store full R2 URLs in the images array (e.g., `https://pub-5f4c0432c70b4389a92d23c5a0047e17.r2.dev/images/mrm/filename.png`)
- Also set `thumbnailUrl` to the first image URL if not already set

**Database update pattern:**
- Use Drizzle ORM with neon serverless driver (same pattern as `backfill-detail-images.ts`)
- Load dotenv from `.env.local`
- For each detail with images: `db.update(details).set({ images: imageUrls, thumbnailUrl }).where(eq(details.id, detailId))`
- Process all 251 details, log counts of: updated (had images), skipped (no images), total images linked

**Idempotency:**
- Script overwrites images array each run (not append) — safe to re-run
- Use `UPDATE ... SET` not `INSERT` — details already exist in database

**Add npm script to package.json:**
```json
"db:populate-images": "npx tsx scripts/populate-detail-images.ts"
```

After creating the script, run it: `npm run db:populate-images`
  </action>
  <verify>
Run `npm run db:populate-images` — should complete without errors, logging:
- Total details processed
- Number with images from manifest mapping (should be ~201 unique details from manifest detail_codes)
- Number with images from details.json fallback
- Total images linked
- No images assigned to details that lack detail_codes in the manifest (IMG-03)
  </verify>
  <done>
Detail records in the database have their images array populated with full R2 URLs. 201 detail-mapped images from manifest are correctly associated. Section-only images are NOT in any detail's images array. Script is idempotent.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create targeted warnings population script and run it</name>
  <files>scripts/populate-warnings.ts, package.json</files>
  <action>
Create `scripts/populate-warnings.ts` that populates the `warning_conditions` table from `mrm_extract/warnings_enhanced.json`.

**Data source:** `warnings_enhanced.json` — 138 entries, each with:
```json
{
  "detailCode": "D01",
  "conditionType": "other",        // "other" | "wind_zone" | "corrosion_zone" | "pitch"
  "conditionValue": "all",         // "all" | "VH,EH" | "D,E" | varies
  "warningText": "...",
  "severity": "info"               // "info" | "warning"
}
```

**Script logic:**
1. Load `warnings_enhanced.json`
2. Clear existing warning_conditions (idempotent — use `db.delete(warningConditions)` to remove all, then re-insert fresh)
3. For each warning entry:
   - Generate detailId: `lrm-{detailCode.toLowerCase()}`
   - Generate warning ID: `w-enh-{detailCode.toLowerCase()}-{index}`
   - Map fields directly: conditionType, conditionValue, warningText, severity
   - Set nzbcRef to null (not present in enhanced warnings)
4. Batch insert (50 per batch, same as import-mrm.ts pattern)
5. Log total inserted, unique detail codes covered

**Database pattern:**
- Same neon + drizzle pattern as other scripts
- Import `warningConditions` from `lib/db/schema`
- Use dotenv `.env.local`

**Important:** This script ONLY touches the `warning_conditions` table. It does NOT touch details, steps, or any other table. The delete-then-insert approach is safe because warnings are derived entirely from the JSON file.

**Add npm script to package.json:**
```json
"db:populate-warnings": "npx tsx scripts/populate-warnings.ts"
```

After creating the script, run it: `npm run db:populate-warnings`
  </action>
  <verify>
Run `npm run db:populate-warnings` — should complete without errors, logging:
- 138 warnings inserted
- Covering ~121 unique detail codes
- 4 condition types (other, wind_zone, corrosion_zone, pitch)
- 2 severity levels (info, warning)
  </verify>
  <done>
138 enhanced warnings from warnings_enhanced.json are in the warning_conditions table with correct detailId references, severity, conditionType, and conditionValue. Script is idempotent (safe to re-run).
  </done>
</task>

</tasks>

<verification>
1. Run `npm run db:populate-images` — completes successfully with expected counts
2. Run `npm run db:populate-warnings` — completes successfully with 138 warnings
3. Both scripts are idempotent — running them again produces same result
4. Spot-check: Query detail `lrm-d01` — should have images array with R2 URLs
5. Spot-check: Query warning_conditions for `lrm-d01` — should have at least 1 warning
6. Verify no section-only images leaked into detail records (grep for images without detail_codes in manifest, confirm they're not in any detail's images array)
</verification>

<success_criteria>
- All 251 MRM details have appropriate images arrays (populated or null if no images)
- 201 detail-mapped images from manifest are correctly associated
- 138 warnings inserted with correct detail references
- Section-only images remain section-only (IMG-03 compliance)
- Both scripts can be re-run safely
</success_criteria>

<output>
After completion, create `.planning/phases/19-data-pipeline-foundation/19-01-SUMMARY.md`
</output>
