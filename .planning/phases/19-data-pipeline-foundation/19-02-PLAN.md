---
phase: 19-data-pipeline-foundation
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - components/details/DetailViewer.tsx
  - components/details/ImageGallery.tsx
autonomous: false

must_haves:
  truths:
    - "Detail image gallery displays MRM technical diagrams on detail pages that have images populated"
    - "Warnings display on detail pages with correct severity styling — info (blue), warning (amber)"
    - "Warnings filter based on user context preferences (wind zone, corrosion zone) — inactive warnings are dimmed"
    - "Images tab only appears when detail has images (existing hasImages logic works with populated data)"
    - "Warnings tab only appears when detail has warnings (existing conditional tab logic works)"
    - "ImageGallery correctly resolves R2 URLs from the images array (full URLs stored, not filenames)"
  artifacts:
    - path: "components/details/DetailViewer.tsx"
      provides: "Detail page with Images tab and Warnings tab rendering populated data"
      contains: "ImageGallery"
    - path: "components/details/ImageGallery.tsx"
      provides: "Gallery component rendering R2 image URLs with lightbox"
      contains: "getPublicUrl"
  key_links:
    - from: "components/details/ImageGallery.tsx"
      to: "lib/storage.ts"
      via: "getPublicUrl resolves image keys to R2 URLs"
      pattern: "getPublicUrl"
    - from: "components/details/DetailViewer.tsx"
      to: "components/warnings/DynamicWarning.tsx"
      via: "renders each warning with severity styling"
      pattern: "DynamicWarning"
---

<objective>
Verify and fix the UI display pipeline for populated images and warnings on detail pages. The data is now in the database (Plan 01); this plan ensures the frontend correctly renders it.

Purpose: Meet IMG-02 (image gallery displays MRM diagrams) and WARN-02/WARN-03 (warnings display with severity styling and filter by preferences).

Output: Working detail pages showing image galleries and severity-styled warnings with preference filtering.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-data-pipeline-foundation/19-01-SUMMARY.md

@components/details/DetailViewer.tsx
@components/details/ImageGallery.tsx
@components/warnings/DynamicWarning.tsx
@lib/storage.ts
@lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ImageGallery URL handling for full R2 URLs</name>
  <files>components/details/ImageGallery.tsx</files>
  <action>
The existing `ImageGallery.tsx` calls `getPublicUrl(imageKey)` which prepends `R2_PUBLIC_URL/` to the key. However, Plan 01 stores FULL R2 URLs in the images array (e.g., `https://pub-5f4c0432c70b4389a92d23c5a0047e17.r2.dev/images/mrm/filename.png`), not R2 keys.

Check if the images stored in the database are full URLs or relative keys:
- If `import-mrm.ts` stores full URLs (line 269: `detail.images.map(img => R2_PUBLIC_URL/images/mrm/${img})`), then `getPublicUrl(imageKey)` would DOUBLE the URL prefix
- If `backfill-detail-images.ts` stores full URLs (line 64: `validImages.map(img => r2Manifest[img])` where r2Manifest values are full URLs), same problem

**Fix:** Update `ImageGallery.tsx` to detect whether the image string is already a full URL or a relative key:
- If the string starts with `http` — use it directly (it's already a full URL)
- If not — call `getPublicUrl(imageKey)` to construct the URL

This makes the component work with BOTH formats for backwards compatibility.

Update in the Image `src` prop:
```tsx
src={imageKey.startsWith('http') ? imageKey : getPublicUrl(imageKey)}
```

Also update `ImageLightbox.tsx` the same way if it uses `getPublicUrl`.

**Also update the `alt` text:** Change from `${detailCode} technical detail ${index + 1}` to `${detailCode} technical diagram ${index + 1}` for accuracy (these are MRM technical diagrams, not generic details).

**Also verify warnings rendering with populated data:**
- Check that `DetailViewer.tsx` already imports and renders `DynamicWarning` for each warning in the Warnings tab
- Confirm that `DynamicWarning.tsx` receives `severity`, `conditionType`, `conditionValue`, and `warningText` from the warning_conditions data populated by Plan 01
- If the existing wiring is correct (DynamicWarning renders with severity styling), no code changes needed — just confirm it works
- If DynamicWarning is missing any props or the Warnings tab doesn't pass the right data shape, fix the wiring so warnings render with correct severity colors (info=blue, warning=amber) and condition badges
  </action>
  <verify>
Start the dev server (`npm run dev`). Navigate to a detail page that has images AND warnings (e.g., D01 or D06). Confirm:
1. Images tab appears
2. Image thumbnails load correctly (no broken images, no doubled URL prefix)
3. Clicking a thumbnail opens the lightbox
4. Alt text reads "D01 technical diagram 1"
5. Warnings tab appears with warning count badge
6. Each warning displays with correct severity styling (info=blue, warning=amber)
7. Condition badges display (e.g., "Wind Zone: VH,EH")
  </verify>
  <done>
ImageGallery handles both full R2 URLs and relative keys. Images display correctly on detail pages. DynamicWarning renders populated warnings with correct severity styling and condition badges.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify image gallery and warnings display on live detail pages</name>
  <files>components/details/DetailViewer.tsx, components/details/ImageGallery.tsx, components/warnings/DynamicWarning.tsx</files>
  <what-built>
Plan 01 populated the database with images and warnings from MRM extraction artifacts. Task 1 above fixed the ImageGallery URL handling. The full pipeline is now:
- Database: details.images has R2 URLs, warning_conditions has 138 enhanced warnings
- API: getDetailById returns images, warnings, and failures
- UI: DetailViewer shows Images tab (when images exist) and Warnings tab (when warnings exist)
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to a detail page with images AND warnings (e.g., /planner/long-run-metal/lrm-drainage/lrm-d06 — D06 should have valley images + wind zone warning)
3. Verify **Images tab**:
   - Tab appears with image count badge
   - Thumbnails display MRM technical diagrams (not broken images)
   - Click a thumbnail — lightbox opens with full-size image
   - Navigation works in lightbox (next/previous if multiple images)
4. Verify **Warnings tab**:
   - Tab appears with warning count badge (amber)
   - Each warning displays with correct severity color:
     - Info warnings: blue background, blue icon
     - Warning warnings: amber background, amber icon
   - Condition badges show (e.g., "Wind Zone: VH,EH")
   - If your preferences don't match the warning condition, it shows dimmed with "(Not applicable to your settings)"
5. Try another detail (e.g., /planner/long-run-metal/lrm-drainage/lrm-d01 — D01 should have info warning about valley capacity)
6. Verify a detail WITHOUT images (if any exist) — confirm Images tab does NOT appear
  </how-to-verify>
  <resume-signal>Type "approved" if images and warnings display correctly, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. ImageGallery renders full R2 URLs without doubling the URL prefix
2. Images tab appears only on details with populated images array
3. Warnings tab appears only on details with warnings in warning_conditions table
4. Warning severity colors match design system: info=blue, warning=amber, critical=red
5. Warning filtering works with user preferences (wind_zone, corrosion_zone)
6. No UI regressions on detail pages without images or warnings
</verification>

<success_criteria>
- MRM technical diagrams display in image gallery on detail pages (IMG-02)
- Warnings display with correct severity styling (WARN-02)
- Warnings filter by user context preferences (WARN-03)
- No broken images or URL issues
- Human verification confirms working end-to-end display
</success_criteria>

<output>
After completion, create `.planning/phases/19-data-pipeline-foundation/19-02-SUMMARY.md`
</output>
