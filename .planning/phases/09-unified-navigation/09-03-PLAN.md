---
phase: 09-unified-navigation
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - app/(dashboard)/topics/[topicId]/page.tsx
  - app/(dashboard)/topics/[topicId]/topic-client.tsx
  - lib/db/queries/topics.ts
  - components/navigation/Breadcrumbs.tsx
autonomous: true

must_haves:
  truths:
    - "User can filter topic details by source using tabs (All / MRM COP / RANZ Guide)"
    - "User can filter topic details by capability using checkboxes"
    - "User sees Coming Soon placeholder when topic has no details for selected filters"
    - "Filter state persists in URL for shareability and back button support"
  artifacts:
    - path: "app/(dashboard)/topics/[topicId]/topic-client.tsx"
      provides: "Fully integrated topic client with filters"
      min_lines: 100
    - path: "lib/db/queries/topics.ts"
      provides: "Enhanced query with capability flags"
      contains: "hasSteps"
  key_links:
    - from: "app/(dashboard)/topics/[topicId]/topic-client.tsx"
      to: "components/navigation/SourceFilterTabs"
      via: "Filter tabs integration"
      pattern: "SourceFilterTabs"
    - from: "app/(dashboard)/topics/[topicId]/topic-client.tsx"
      to: "components/navigation/CapabilityFilters"
      via: "Capability filters integration"
      pattern: "CapabilityFilters"
---

<objective>
Integrate filter components into topic pages for complete unified navigation.

Purpose: Enable users to filter topic listings by source and capabilities with full URL state persistence, completing the NAV-02, NAV-03, and NAV-05 requirements.

Output: Fully functional topic pages with source tabs, capability filters, and proper empty states.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-unified-navigation/09-RESEARCH.md

# Components from previous plans in this phase
@components/navigation/SourceFilterTabs.tsx
@components/navigation/CapabilityFilters.tsx
@components/navigation/ComingSoonPlaceholder.tsx

# Pages to enhance
@app/(dashboard)/topics/[topicId]/page.tsx
@app/(dashboard)/topics/[topicId]/topic-client.tsx

# Query to enhance
@lib/db/queries/topics.ts

# Breadcrumbs to update for topics
@components/navigation/Breadcrumbs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Query and Integrate Filters into Topic Page</name>
  <files>
lib/db/queries/topics.ts
app/(dashboard)/topics/[topicId]/page.tsx
app/(dashboard)/topics/[topicId]/topic-client.tsx
  </files>
  <action>
**Enhance getDetailsByTopic Query:**

Update the `TopicDetail` interface and query to include capability flags needed for filtering:

```typescript
export interface TopicDetail {
  // existing fields...
  hasSteps: boolean;      // true if detail has steps
  hasWarnings: boolean;   // true if detail has warning conditions
  hasCaseLaw: boolean;    // true if detail has linked failure cases
}
```

Modify the query to include these counts/flags. For initial implementation, use LEFT JOINs to get counts and convert to boolean:

```sql
LEFT JOIN detail_steps ds ON d.id = ds.detail_id
LEFT JOIN warning_conditions wc ON d.id = wc.detail_id
LEFT JOIN detail_failure_links dfl ON d.id = dfl.detail_id
```

Then in select: `hasSteps: sql<boolean>\`COUNT(DISTINCT ds.id) > 0\``

**Add source counts for tabs:**

To get per-source counts, run a SEPARATE aggregation query BEFORE the main query:

```typescript
// 1. Get source counts using GROUP BY
const sourceCounts = await db
  .select({
    sourceId: details.sourceId,
    count: sql<number>`COUNT(*)::int`.as('count')
  })
  .from(details)
  .innerJoin(detailTopicLinks, eq(details.id, detailTopicLinks.detailId))
  .where(eq(detailTopicLinks.topicId, topicId))
  .groupBy(details.sourceId);

// 2. Transform to object
const countMap = sourceCounts.reduce((acc, { sourceId, count }) => {
  acc[sourceId] = count;
  return acc;
}, {} as Record<string, number>);

const mrmCount = countMap['mrm-cop'] || 0;
const ranzCount = countMap['ranz-guide'] || 0;
```

Update return type:

```typescript
export interface TopicDetailsResult {
  data: TopicDetail[];
  total: number;
  mrmCount: number;      // Count of details from MRM COP source
  ranzCount: number;     // Count of details from RANZ Guide source
  limit: number;
  offset: number;
}
```

**Update Server Component (page.tsx):**

1. Extract source and capabilities from searchParams
2. Pass counts to client for tab badges
3. Pass capabilities as prop for client-side filtering

**Update Client Component (topic-client.tsx):**

1. Import SourceFilterTabs, CapabilityFilters, ComingSoonPlaceholder from @/components/navigation
2. Wrap detail list in SourceFilterTabs:
   ```tsx
   <SourceFilterTabs allCount={allCount} mrmCount={mrmCount} ranzCount={ranzCount}>
     <CapabilityFilters className="my-4" />
     {/* detail list */}
   </SourceFilterTabs>
   ```

3. Apply client-side capability filtering using useMemo:
   - Read capabilities from searchParams
   - Filter details based on selected capabilities (ALL selected must match)
   - If no capabilities selected, show all details

4. Handle empty states:
   - If topic has NO details at all: show ComingSoonPlaceholder
   - If filters result in 0 matches: show "No details match your filters" with clear button
   - Use different messaging for each case

5. Show filter summary: "Showing {n} of {total} details" when filters active

Follow Pattern 4 (hydration safety) from 09-RESEARCH.md - apply capability filters client-side only after mount to avoid hydration mismatch.
  </action>
  <verify>
Run `npm run build` - no errors.
Navigate to /topics/{topicId}:
- Tab counts show correctly (All: X, MRM COP: Y, RANZ Guide: Z)
- Clicking tabs filters the list and updates URL
- Checking "Has 3D Model" checkbox filters the list
- Verify URL updates to ?capabilities=3d
- Verify list shows only details with modelUrl !== null
- Check multiple capability filters combine correctly (AND logic)
- URL changes persist on page refresh
- Browser back button restores previous filter state
  </verify>
  <done>
Topic page has fully integrated source tabs and capability filters with URL state persistence. Source counts calculated via GROUP BY aggregation. Capability filters tested for 3D model filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Breadcrumbs for Topics Navigation</name>
  <files>components/navigation/Breadcrumbs.tsx</files>
  <action>
Update the Breadcrumbs component to properly handle topics routes.

In the `formatSegmentLabel` function, add topics-related route labels:

```typescript
const routeLabels: Record<string, string> = {
  // existing labels...
  'topics': 'Topics',
};
```

Also update `generateBreadcrumbsFromPath` to handle topic IDs nicely:
- If segment is a topic ID (after 'topics'), try to format it nicely
- Topic IDs are typically kebab-case like 'flashings', 'ridges-hips', etc.

The existing logic should mostly work, but verify that:
1. /topics shows: Home > Topics
2. /topics/flashings shows: Home > Topics > Flashings
3. Topic names are properly title-cased

If topic names need to be fetched for breadcrumbs (to show proper names), that can be handled in the page component by passing explicit items prop. For now, use the URL-based approach which will show formatted topic IDs.

Note: The existing Breadcrumbs component already supports explicit `items` prop for custom breadcrumbs. The topic page.tsx can optionally pass explicit items with the topic's actual name from the database.
  </action>
  <verify>
Navigate to /topics - breadcrumbs show "Home > Topics"
Navigate to /topics/flashings - breadcrumbs show "Home > Topics > Flashings"
No console errors or hydration warnings.
  </verify>
  <done>
Breadcrumbs correctly display topic navigation hierarchy with proper labels.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. Topic page shows source filter tabs with correct counts
3. Tab changes update URL and filter list
4. Capability checkboxes update URL and filter list
5. Multiple filters combine correctly (source + capabilities)
6. Empty state shows when no details match filters
7. ComingSoonPlaceholder shows when topic has no content
8. URL state persists on refresh and back button
9. Breadcrumbs show correct hierarchy for topic pages
</verification>

<success_criteria>
- NAV-02: User can filter by source using tabs (All / MRM COP / RANZ Guide)
- NAV-03: User can filter by capability (3D, Steps, Warnings, Case Law)
- NAV-05: Coming Soon placeholder shows for empty topics
- Filter state persists in URL for shareability
- Browser navigation (back/forward) preserves filter state
</success_criteria>

<output>
After completion, create `.planning/phases/09-unified-navigation/09-03-SUMMARY.md`
</output>
