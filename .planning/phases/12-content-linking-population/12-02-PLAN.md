---
phase: 12-content-linking-population
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - app/(admin)/admin/links/page.tsx
  - app/(admin)/admin/links/suggestions/page.tsx
  - components/admin/LinkSuggestionCard.tsx
  - components/admin/LinkPreview.tsx
  - app/(admin)/admin/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view all existing links in a table"
    - "Admin can delete links from the table"
    - "Admin can review pending suggestions with approve/reject"
    - "Admin can see visual preview of what link will look like"
    - "Admin can approve all exact matches in bulk"
  artifacts:
    - path: "app/(admin)/admin/links/page.tsx"
      provides: "Link management list page"
      min_lines: 80
    - path: "app/(admin)/admin/links/suggestions/page.tsx"
      provides: "Suggestions review page"
      min_lines: 100
    - path: "components/admin/LinkSuggestionCard.tsx"
      provides: "Suggestion card component"
      min_lines: 50
    - path: "components/admin/LinkPreview.tsx"
      provides: "Link preview component"
      min_lines: 30
  key_links:
    - from: "app/(admin)/admin/links/page.tsx"
      to: "/api/admin/links"
      via: "fetch for delete"
      pattern: "fetch.*api/admin/links"
    - from: "app/(admin)/admin/links/suggestions/page.tsx"
      to: "/api/admin/links/suggestions"
      via: "fetch for suggestions"
      pattern: "fetch.*api/admin/links/suggestions"
    - from: "components/admin/LinkSuggestionCard.tsx"
      to: "/api/admin/links"
      via: "POST on approve"
      pattern: "fetch.*POST"
---

<objective>
Create the admin UI for managing MRM-RANZ content links, including link listing, suggestion review, and bulk approval.

Purpose: Enable admins to review system-suggested links, approve/reject them, and manage existing links without writing SQL.

Output:
- Admin links page showing all existing links with delete action
- Suggestions review page with approve/reject workflow
- LinkSuggestionCard and LinkPreview components
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-content-linking-population/12-RESEARCH.md
@.planning/phases/12-content-linking-population/12-01-SUMMARY.md

# Existing admin patterns
@app/(admin)/admin/details/page.tsx
@components/admin/DataTable.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin links list page</name>
  <files>
    - app/(admin)/admin/links/page.tsx
    - app/(admin)/admin/page.tsx
  </files>
  <action>
1. Create `app/(admin)/admin/links/page.tsx`:
   - Follow pattern from admin/details/page.tsx
   - Server component with `export const dynamic = 'force-dynamic'`
   - Fetch links via API or direct db query (getAllLinks)
   - Use DataTable with columns:
     - Primary: code + name (link to detail)
     - Supplementary: code + name (link to detail)
     - Link Type: Badge (installation_guide, technical_supplement, alternative)
     - Confidence: Badge with color (exact=green, partial=amber, related=grey)
     - Created: formatted date
   - Actions dropdown with:
     - View primary detail (opens detail page)
     - View supplementary detail
     - Delete (with confirmation)
   - Header with:
     - Title: "Content Links"
     - Subtitle: "Manage MRM to RANZ content links (X total)"
     - Button: "Review Suggestions" -> /admin/links/suggestions
   - Search by code or name (optional, skip if complex)
   - Delete action calls DELETE /api/admin/links/[id] via fetch

2. Update `app/(admin)/admin/page.tsx`:
   - Add "Content Links" card to admin dashboard
   - Link to /admin/links
   - Icon: Link2 from lucide-react
   - Description: "Manage MRM-RANZ cross-source links"

Server-side implementation:
```typescript
async function getLinksData() {
  // Use getAllLinks from lib/db/queries/detail-links.ts
  return await getAllLinks();
}
```

Client-side delete:
```typescript
async function handleDelete(linkId: string) {
  if (!confirm('Delete this link?')) return;
  await fetch(`/api/admin/links/${linkId}`, { method: 'DELETE' });
  router.refresh();
}
```
  </action>
  <verify>
1. Navigate to /admin/links shows link table
2. Links display primary and supplementary detail info
3. Delete button removes link from table
4. Admin dashboard has "Content Links" card
  </verify>
  <done>
- Admin links page displays all existing links
- DataTable shows primary/supplementary details, type, confidence
- Delete action works with confirmation
- Admin dashboard links to Content Links page
  </done>
</task>

<task type="auto">
  <name>Task 2: Create suggestions review page and components</name>
  <files>
    - app/(admin)/admin/links/suggestions/page.tsx
    - components/admin/LinkSuggestionCard.tsx
    - components/admin/LinkPreview.tsx
  </files>
  <action>
1. Create `components/admin/LinkPreview.tsx`:
   ```typescript
   interface LinkPreviewProps {
     primary: { code: string; name: string; sourceId: string };
     supplementary: { code: string; name: string; sourceId: string; modelUrl?: string | null };
   }
   ```
   - Display side-by-side preview of linked content
   - Show source badges (MRM/RANZ)
   - Show 3D indicator if supplementary has modelUrl
   - Arrow icon connecting primary -> supplementary
   - Compact card style for fitting in list

2. Create `components/admin/LinkSuggestionCard.tsx`:
   ```typescript
   interface LinkSuggestion {
     mrmDetailId: string;
     mrmCode: string;
     mrmName: string;
     ranzDetailId: string;
     ranzCode: string;
     ranzName: string;
     ranzModelUrl?: string | null;
     confidence: 'exact' | 'partial' | 'related';
     score: number;
   }

   interface LinkSuggestionCardProps {
     suggestion: LinkSuggestion;
     onApprove: (suggestion: LinkSuggestion) => Promise<void>;
     onReject: (suggestion: LinkSuggestion) => void;
     isApproving?: boolean;
   }
   ```
   - Card showing MRM code -> RANZ code with confidence badge
   - LinkPreview embedded in card
   - Similarity score display (e.g., "87% match")
   - "Approve" button (primary) -> calls onApprove
   - "Reject" button (ghost/outline) -> calls onReject (removes from UI, no persistence)
   - Loading state when approving

3. Create `app/(admin)/admin/links/suggestions/page.tsx`:
   - Client component (needs interactivity for approve/reject)
   - Fetch suggestions from /api/admin/links/suggestions on mount
   - Show loading skeleton during fetch
   - Display suggestions grouped by confidence (exact first, then partial, then related)
   - Each group has header: "Exact Matches (N)", "Partial Matches (N)", "Related (N)"
   - "Approve All Exact" button at top (only if exact matches exist)
   - Approve action:
     - POST to /api/admin/links with suggestion data
     - Remove approved suggestion from list
     - Show success toast
   - Reject action:
     - Remove from list (no persistence needed)
   - Empty state: "No pending suggestions. All MRM-RANZ links are up to date."
   - Back link to /admin/links

Bulk approve implementation:
```typescript
async function handleApproveAllExact() {
  if (!confirm(`Approve all ${exactCount} exact matches?`)) return;
  setApproving(true);
  for (const suggestion of exactSuggestions) {
    await approveSuggestion(suggestion);
  }
  setApproving(false);
}
```
  </action>
  <verify>
1. Navigate to /admin/links/suggestions shows suggestions list
2. Suggestions are grouped by confidence level
3. Clicking "Approve" creates link and removes card from list
4. Clicking "Reject" removes card from list
5. "Approve All Exact" button approves all exact matches
6. LinkPreview shows source badges and 3D indicator
  </verify>
  <done>
- Suggestions page loads and displays suggestions by confidence
- LinkSuggestionCard shows preview with approve/reject
- LinkPreview shows source badges and capability indicators
- Approve creates link via API
- Bulk approve for exact matches works
- Reject removes from UI without persisting
  </done>
</task>

</tasks>

<verification>
1. Admin navigation: /admin -> Click "Content Links" -> Shows links table
2. Links table: Displays existing test links from Phase 10
3. Delete: Click delete on a link -> Confirms -> Link removed
4. Suggestions: Click "Review Suggestions" -> Shows suggestions page
5. Approve flow: Click Approve on a suggestion -> Creates link -> Card removed
6. Bulk approve: Click "Approve All Exact" -> All exact matches approved
7. Back to links: Links table shows newly approved links
</verification>

<success_criteria>
- [ ] /admin/links page displays all links with DataTable
- [ ] Delete action removes links with confirmation
- [ ] /admin/links/suggestions shows suggestions grouped by confidence
- [ ] LinkSuggestionCard has approve/reject buttons
- [ ] LinkPreview shows source badges and 3D indicator
- [ ] Approve action creates link via API
- [ ] "Approve All Exact" bulk action works
- [ ] Admin dashboard has Content Links card
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-linking-population/12-02-SUMMARY.md`
</output>
