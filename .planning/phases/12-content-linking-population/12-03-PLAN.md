---
phase: 12-content-linking-population
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - tests/content-scenarios.spec.ts
autonomous: true

must_haves:
  truths:
    - "MRM-only detail shows warnings but no borrowed 3D model"
    - "RANZ-only detail shows 3D model but no warnings"
    - "Linked MRM detail shows borrowed 3D from RANZ with attribution"
    - "E2E tests verify all four content scenarios"
  artifacts:
    - path: "tests/content-scenarios.spec.ts"
      provides: "E2E tests for content linking scenarios"
      min_lines: 80
  key_links:
    - from: "tests/content-scenarios.spec.ts"
      to: "detail pages"
      via: "page.goto"
      pattern: "page\\.goto.*detail|planner"
---

<objective>
Create comprehensive E2E tests that verify all four content linking scenarios work correctly across the application.

Purpose: Ensure the content linking system properly handles MRM-only, RANZ-only, linked, and standalone detail scenarios without regression.

Output:
- content-scenarios.spec.ts with tests for all 4 scenarios
- Documentation of test detail IDs used
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-content-linking-population/12-RESEARCH.md

# Existing test patterns
@tests/navigation.spec.ts
@tests/3d-viewer.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify test detail IDs for each scenario</name>
  <files>
    - tests/content-scenarios.spec.ts
  </files>
  <action>
Before writing tests, query the database to identify real detail IDs for each scenario:

1. MRM-only detail (has warnings, no model, no links):
   ```sql
   SELECT d.id, d.code, d.name
   FROM details d
   WHERE d.source_id = 'mrm-cop'
     AND d.model_url IS NULL
     AND NOT EXISTS (
       SELECT 1 FROM detail_links dl
       WHERE dl.primary_detail_id = d.id OR dl.supplementary_detail_id = d.id
     )
     AND EXISTS (
       SELECT 1 FROM warning_conditions wc WHERE wc.detail_id = d.id
     )
   LIMIT 1;
   ```

2. RANZ-only detail (has model, no warnings):
   ```sql
   SELECT d.id, d.code, d.name
   FROM details d
   WHERE d.source_id = 'ranz-guide'
     AND d.model_url IS NOT NULL
     AND NOT EXISTS (
       SELECT 1 FROM detail_links dl
       WHERE dl.primary_detail_id = d.id OR dl.supplementary_detail_id = d.id
     )
   LIMIT 1;
   ```

3. Linked MRM detail (MRM linked to RANZ with model):
   ```sql
   SELECT d.id, d.code, d.name, dl.supplementary_detail_id
   FROM details d
   JOIN detail_links dl ON dl.primary_detail_id = d.id
   JOIN details rd ON rd.id = dl.supplementary_detail_id
   WHERE d.source_id = 'mrm-cop'
     AND rd.model_url IS NOT NULL
   LIMIT 1;
   ```

4. Standalone detail (no model, no warnings, no links):
   ```sql
   SELECT d.id, d.code, d.name
   FROM details d
   WHERE d.model_url IS NULL
     AND NOT EXISTS (
       SELECT 1 FROM warning_conditions wc WHERE wc.detail_id = d.id
     )
     AND NOT EXISTS (
       SELECT 1 FROM detail_links dl
       WHERE dl.primary_detail_id = d.id OR dl.supplementary_detail_id = d.id
     )
   LIMIT 1;
   ```

Run these queries via `npx tsx` script or direct db access.
Create the test file with IDs documented in a comment at the top.

Note: If certain scenarios don't have real data, the test should skip with `test.skip()` and a clear message.
  </action>
  <verify>
- tests/content-scenarios.spec.ts created with test detail IDs documented in header comment
- Run `head -30 tests/content-scenarios.spec.ts` to verify IDs are documented
  </verify>
  <done>
- tests/content-scenarios.spec.ts created with header comment documenting 4 detail IDs
- Each ID corresponds to one of the four content scenarios
- File exists as starting point for Task 2
  </done>
</task>

<task type="auto">
  <name>Task 2: Create content-scenarios.spec.ts E2E tests</name>
  <files>
    - tests/content-scenarios.spec.ts
  </files>
  <action>
Create `tests/content-scenarios.spec.ts` following patterns from navigation.spec.ts:

```typescript
import { test, expect } from '@playwright/test';

/**
 * Content Linking Scenarios E2E Tests
 *
 * Tests the four content scenarios documented in Phase 12:
 * 1. MRM-only: Has warnings, no 3D model, no linked content
 * 2. RANZ-only: Has 3D model, no warnings
 * 3. Linked: MRM primary with borrowed RANZ 3D/steps
 * 4. Standalone: No model, no warnings, no links
 *
 * Test Detail IDs:
 * - MRM-only: [ID from Task 1]
 * - RANZ-only: [ID from Task 1]
 * - Linked: [ID from Task 1]
 * - Standalone: [ID from Task 1]
 */

test.describe('Content Linking Scenarios', () => {
  test.describe('MRM-only Detail', () => {
    test('shows warnings section', async ({ page }) => {
      // Navigate to MRM detail with warnings but no model
      await page.goto('/planner/[substrate]/[category]/[mrm-only-id]');

      // Wait for detail page to load
      await expect(page.getByRole('heading')).toBeVisible({ timeout: 10000 });

      // Should show warnings tab/section
      const warningsTab = page.getByRole('tab', { name: /warnings/i });
      if (await warningsTab.isVisible()) {
        await warningsTab.click();
        await expect(page.getByText(/warning|caution/i)).toBeVisible();
      }
    });

    test('does not show 3D model viewer', async ({ page }) => {
      await page.goto('/planner/[substrate]/[category]/[mrm-only-id]');
      await expect(page.getByRole('heading')).toBeVisible({ timeout: 10000 });

      // 3D viewer should not be visible or should show placeholder
      const model3D = page.locator('[data-testid="model-3d-viewer"]');
      const noModelMessage = page.getByText(/no.*model.*available|3d model not available/i);

      // Either no 3D viewer, or it shows "no model" message
      const has3DViewer = await model3D.isVisible().catch(() => false);
      if (!has3DViewer) {
        // 3D tab may be hidden entirely
        const threeDTab = page.getByRole('tab', { name: /3d|model/i });
        await expect(threeDTab).not.toBeVisible();
      } else {
        await expect(noModelMessage).toBeVisible();
      }
    });
  });

  test.describe('RANZ-only Detail', () => {
    test('shows 3D model viewer', async ({ page }) => {
      await page.goto('/planner/[substrate]/[category]/[ranz-only-id]');
      await expect(page.getByRole('heading')).toBeVisible({ timeout: 10000 });

      // Should have 3D viewer visible
      // May be in a tab or directly visible
      const threeDTab = page.getByRole('tab', { name: /3d|model/i });
      if (await threeDTab.isVisible()) {
        await threeDTab.click();
      }

      // Look for canvas (Three.js) or 3D viewer container
      const modelViewer = page.locator('canvas, [data-testid="model-3d-viewer"]');
      await expect(modelViewer.first()).toBeVisible({ timeout: 10000 });
    });

    test('does not show warnings section', async ({ page }) => {
      await page.goto('/planner/[substrate]/[category]/[ranz-only-id]');
      await expect(page.getByRole('heading')).toBeVisible({ timeout: 10000 });

      // Warnings tab should not be visible (no warnings for RANZ)
      const warningsTab = page.getByRole('tab', { name: /warnings/i });
      await expect(warningsTab).not.toBeVisible();
    });
  });

  test.describe('Linked Detail (MRM with borrowed RANZ content)', () => {
    test('shows combined view: MRM specs + borrowed RANZ 3D model', async ({ page }) => {
      // LINK-03: Verify "both linked (combined view)" - MRM specs + RANZ 3D compose into unified view
      await page.goto('/planner/[substrate]/[category]/[linked-mrm-id]');
      await expect(page.getByRole('heading')).toBeVisible({ timeout: 10000 });

      // 1. Verify MRM source is shown (this is an MRM detail page)
      const mrmBadge = page.locator('[data-testid="source-badge"]').filter({ hasText: /mrm|cop/i });
      await expect(mrmBadge.first()).toBeVisible();

      // 2. Should have 3D viewer visible (borrowed from RANZ)
      const threeDTab = page.getByRole('tab', { name: /3d|model/i });
      if (await threeDTab.isVisible()) {
        await threeDTab.click();
      }

      // 3D viewer should be visible
      const modelViewer = page.locator('canvas, [data-testid="model-3d-viewer"]');
      await expect(modelViewer.first()).toBeVisible({ timeout: 10000 });

      // 3. Should show source attribution (RANZ provided this model)
      const attribution = page.getByText(/provided by|from ranz|source.*ranz/i);
      await expect(attribution).toBeVisible();

      // 4. Verify combined view: Check both MRM content section AND borrowed RANZ 3D in same page
      // This verifies LINK-03 requirement for "combined view"
      const pageText = await page.textContent('body');
      expect(pageText).toMatch(/specifications|description/i); // MRM specs present
    });

    test('shows Related Content tab with linked detail', async ({ page }) => {
      await page.goto('/planner/[substrate]/[category]/[linked-mrm-id]');
      await expect(page.getByRole('heading')).toBeVisible({ timeout: 10000 });

      // Should have Related tab
      const relatedTab = page.getByRole('tab', { name: /related/i });
      await expect(relatedTab).toBeVisible();
      await relatedTab.click();

      // Should show linked RANZ content
      await expect(page.getByText(/ranz|supplementary/i)).toBeVisible();
    });
  });

  test.describe('Standalone Detail (no model, no warnings, no links)', () => {
    test('shows placeholder for missing content', async ({ page }) => {
      await page.goto('/planner/[substrate]/[category]/[standalone-id]');
      await expect(page.getByRole('heading')).toBeVisible({ timeout: 10000 });

      // Tabs for warnings, 3D, and related should be hidden
      // (only shown when content exists)
      const warningsTab = page.getByRole('tab', { name: /warnings/i });
      const threeDTab = page.getByRole('tab', { name: /3d|model/i });
      const relatedTab = page.getByRole('tab', { name: /related/i });

      // Check tabs are not visible (content doesn't exist)
      await expect(warningsTab).not.toBeVisible();
      await expect(threeDTab).not.toBeVisible();
      await expect(relatedTab).not.toBeVisible();
    });
  });
});
```

Replace `[substrate]`, `[category]`, and `[id]` placeholders with actual values from Task 1.

If a scenario cannot be tested due to missing data, use `test.skip()`:
```typescript
test.skip('shows warnings section', async ({ page }) => {
  // Skipped: No MRM-only detail with warnings found in test data
});
```
  </action>
  <verify>
1. Run tests: `npx playwright test tests/content-scenarios.spec.ts`
2. All tests pass or skip with documented reason
3. No flaky tests (run 3 times to confirm)
  </verify>
  <done>
- content-scenarios.spec.ts created with tests for all 4 scenarios
- Tests use real detail IDs from the database
- Tests pass or skip with clear documentation
- Tests follow existing Playwright patterns
  </done>
</task>

</tasks>

<verification>
1. Run all content scenario tests:
   ```bash
   npx playwright test tests/content-scenarios.spec.ts --reporter=list
   ```

2. Verify test output:
   - MRM-only: warnings visible, no 3D
   - RANZ-only: 3D visible, no warnings
   - Linked: borrowed 3D with attribution, Related tab
   - Standalone: minimal tabs (only available content)

3. Run multiple times to check for flakiness:
   ```bash
   npx playwright test tests/content-scenarios.spec.ts --repeat-each=3
   ```
</verification>

<success_criteria>
- [ ] Test file created at tests/content-scenarios.spec.ts
- [ ] Tests cover all four content scenarios
- [ ] Tests use real detail IDs (or skip with documentation)
- [ ] All tests pass on `npm run test:e2e`
- [ ] No flaky tests on repeated runs
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-linking-population/12-03-SUMMARY.md`
</output>
