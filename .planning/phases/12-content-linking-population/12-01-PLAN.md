---
phase: 12-content-linking-population
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/suggest-detail-links.ts
  - app/api/admin/links/route.ts
  - app/api/admin/links/[id]/route.ts
  - app/api/admin/links/suggestions/route.ts
  - lib/db/queries/detail-links.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Admin sees suggested MRM-RANZ links with confidence ratings (exact/partial/related)"
    - "Admin can create and delete links via API endpoints"
    - "Suggestions correctly identify matches by code similarity"
    - "All links enforce MRM as primary, RANZ as supplementary"
  artifacts:
    - path: "scripts/suggest-detail-links.ts"
      provides: "Auto-suggestion CLI script"
      contains: "string-similarity"
    - path: "app/api/admin/links/route.ts"
      provides: "Link list and create endpoints"
      exports: ["GET", "POST"]
    - path: "app/api/admin/links/[id]/route.ts"
      provides: "Link detail and delete endpoints"
      exports: ["GET", "DELETE"]
    - path: "app/api/admin/links/suggestions/route.ts"
      provides: "Suggestions generation endpoint"
      exports: ["GET"]
  key_links:
    - from: "scripts/suggest-detail-links.ts"
      to: "lib/db"
      via: "drizzle queries"
      pattern: "db\\.select"
    - from: "app/api/admin/links/route.ts"
      to: "lib/db/queries/detail-links.ts"
      via: "createDetailLink"
      pattern: "createDetailLink"
---

<objective>
Create the auto-suggestion script and admin link API routes for MRM-RANZ content linking.

Purpose: Provide the backend infrastructure for link management and automated suggestion generation based on code similarity matching.

Output:
- CLI script for generating link suggestions
- REST API for link CRUD operations
- API endpoint for on-demand suggestion generation
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-content-linking-population/12-RESEARCH.md

# Existing infrastructure
@lib/db/queries/detail-links.ts
@scripts/seed-test-links.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install string-similarity and create auto-suggestion script</name>
  <files>
    - package.json
    - scripts/suggest-detail-links.ts
  </files>
  <action>
1. Install string-similarity package:
   ```bash
   npm install string-similarity @types/string-similarity
   ```

2. Create `scripts/suggest-detail-links.ts` with these features:
   - Import string-similarity and db from lib/db
   - Query all MRM details (sourceId = 'mrm-cop') with id, code, name
   - Query all RANZ details (sourceId = 'ranz-guide') with id, code, name, modelUrl
   - For each MRM-RANZ pair, compute similarity using compareTwoStrings on codes
   - Classify matches:
     - exact: codes match exactly (case-insensitive)
     - partial: similarity >= 0.7
     - related: similarity >= 0.5
   - Skip pairs with similarity < 0.5
   - Output suggestions to console in JSON format
   - Include: mrmDetailId, mrmCode, mrmName, ranzDetailId, ranzCode, ranzName, confidence, score
   - Add --dry-run flag to preview without changes
   - Add --apply flag to insert approved links directly

3. Follow existing script pattern from seed-test-links.ts:
   - Use `npx tsx scripts/suggest-detail-links.ts` to run
   - Console output with progress
   - Graceful exit with error handling

Key implementation note: Match by CODE not name. Names vary significantly between sources.
  </action>
  <verify>
1. `npm ls string-similarity` shows package installed
2. `npx tsx scripts/suggest-detail-links.ts --dry-run` runs without error and outputs suggestions JSON
3. Suggestions include exact, partial, and related confidence levels
  </verify>
  <done>
- string-similarity package installed
- Script generates suggestions comparing MRM and RANZ codes
- Output includes confidence classification (exact/partial/related)
- Script supports --dry-run and --apply flags
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin link CRUD API routes</name>
  <files>
    - app/api/admin/links/route.ts
    - app/api/admin/links/[id]/route.ts
    - app/api/admin/links/suggestions/route.ts
    - lib/db/queries/detail-links.ts
  </files>
  <action>
1. Extend `lib/db/queries/detail-links.ts` with:
   ```typescript
   // Get all links with detail info
   export async function getAllLinks(): Promise<Array<{
     id: string;
     primaryDetailId: string;
     primaryCode: string;
     primaryName: string;
     supplementaryDetailId: string;
     supplementaryCode: string;
     supplementaryName: string;
     linkType: LinkType;
     matchConfidence: MatchConfidence | null;
     createdAt: Date;
   }>>

   // Update a link
   export async function updateDetailLink(
     linkId: string,
     data: { linkType?: LinkType; matchConfidence?: MatchConfidence; notes?: string }
   ): Promise<DetailLink | null>
   ```

2. Create `app/api/admin/links/route.ts`:
   - GET: Return all links via getAllLinks(), ordered by createdAt desc
   - POST: Create link via createDetailLink(), validate with zod:
     ```typescript
     const schema = z.object({
       primaryDetailId: z.string().min(1),
       supplementaryDetailId: z.string().min(1),
       linkType: z.enum(['installation_guide', 'technical_supplement', 'alternative']),
       matchConfidence: z.enum(['exact', 'partial', 'related']).optional(),
       notes: z.string().optional(),
     });
     ```
   - Add `export const dynamic = 'force-dynamic'` for Clerk auth

3. Create `app/api/admin/links/[id]/route.ts`:
   - GET: Return single link by id
   - DELETE: Delete link via deleteDetailLink()
   - PATCH: Update link via updateDetailLink()
   - Add `export const dynamic = 'force-dynamic'`

4. Create `app/api/admin/links/suggestions/route.ts`:
   - GET: Generate suggestions on-demand (same logic as CLI script)
   - Query params: ?minConfidence=exact|partial|related (default: partial)
   - Returns array of LinkSuggestion objects
   - Exclude pairs that already have links (check detail_links table)
   - Add `export const dynamic = 'force-dynamic'`
  </action>
  <verify>
1. `curl http://localhost:3000/api/admin/links` returns JSON array
2. POST to /api/admin/links with valid body creates link, returns 201
3. DELETE to /api/admin/links/[id] removes link
4. GET /api/admin/links/suggestions returns suggestion array
  </verify>
  <done>
- GET /api/admin/links lists all links with detail info
- POST /api/admin/links creates validated link
- GET /api/admin/links/[id] returns single link
- DELETE /api/admin/links/[id] removes link
- PATCH /api/admin/links/[id] updates link
- GET /api/admin/links/suggestions returns code-matched suggestions
  </done>
</task>

</tasks>

<verification>
1. Run suggestion script: `npx tsx scripts/suggest-detail-links.ts --dry-run`
   - Should output suggestions with MRM-RANZ code pairs
   - Should include confidence levels (exact, partial, related)

2. Test API endpoints:
   ```bash
   # List links
   curl http://localhost:3000/api/admin/links

   # Create link
   curl -X POST http://localhost:3000/api/admin/links \
     -H "Content-Type: application/json" \
     -d '{"primaryDetailId":"test-mrm","supplementaryDetailId":"test-ranz","linkType":"installation_guide"}'

   # Get suggestions
   curl http://localhost:3000/api/admin/links/suggestions
   ```
</verification>

<success_criteria>
- [ ] string-similarity package installed
- [ ] suggest-detail-links.ts script runs and generates suggestions
- [ ] Suggestions include confidence classification
- [ ] API routes support full CRUD for links
- [ ] Suggestions API excludes existing links
- [ ] All API routes have force-dynamic for Clerk auth
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-linking-population/12-01-SUMMARY.md`
</output>
