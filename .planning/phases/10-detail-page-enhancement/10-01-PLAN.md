---
phase: 10-detail-page-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/details/ImageGallery.tsx
  - components/details/ImageLightbox.tsx
  - components/details/RelatedContentTab.tsx
autonomous: true

must_haves:
  truths:
    - "User can click MRM thumbnail to open full-size image in lightbox"
    - "User can close lightbox via close button or backdrop click"
    - "User sees linked RANZ guides with source badges in Related tab content"
    - "User sees linked MRM specs from RANZ detail perspective"
  artifacts:
    - path: "components/details/ImageGallery.tsx"
      provides: "Grid of clickable image thumbnails"
      exports: ["ImageGallery"]
    - path: "components/details/ImageLightbox.tsx"
      provides: "Full-screen image viewer dialog"
      exports: ["ImageLightbox"]
    - path: "components/details/RelatedContentTab.tsx"
      provides: "Cross-source related content display"
      exports: ["RelatedContentTab"]
  key_links:
    - from: "components/details/ImageGallery.tsx"
      to: "components/details/ImageLightbox.tsx"
      via: "Dialog open state"
      pattern: "useState.*selectedImage"
    - from: "components/details/RelatedContentTab.tsx"
      to: "@/components/authority"
      via: "SourceBadge import"
      pattern: "import.*SourceBadge.*from.*authority"
---

<objective>
Create ImageGallery (with lightbox) and RelatedContentTab components for Phase 10 detail page enhancement.

Purpose: These are the UI building blocks for DETAIL-02 (image gallery) and DETAIL-03 (related content tab). Both are independent components that DetailViewer will integrate in Plan 02.

Output: Two new component files ready for DetailViewer integration.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-detail-page-enhancement/10-RESEARCH.md

# Phase 7 provides linked detail types
@lib/db/queries/detail-links.ts

# Phase 8 provides authority styling
@components/authority/index.ts

# Existing UI components
@lib/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ImageGallery and ImageLightbox components</name>
  <files>
    components/details/ImageGallery.tsx
    components/details/ImageLightbox.tsx
  </files>
  <action>
Create ImageGallery component that displays MRM technical images in a grid:

1. Create `components/details/ImageLightbox.tsx`:
   - Accept `images: string[]` (R2 keys), `selectedIndex: number`, `open: boolean`, `onOpenChange: (open: boolean) => void`
   - Use shadcn/ui Dialog for modal
   - Display full-size image using Next.js Image with `object-contain`
   - Include visible close button (X) in top-right for mobile accessibility
   - Use `sizes="90vw"` for full-screen image
   - Show image counter (e.g., "2 of 5") below image
   - Add left/right arrow buttons to navigate between images (keyboard accessible)
   - Handle keyboard: Escape to close, Left/Right arrows to navigate

2. Create `components/details/ImageGallery.tsx`:
   - Accept `images: string[]` (R2 keys), `detailCode: string` (for alt text)
   - Return null early if `!images || images.length === 0` (not `images.length &&` to avoid rendering "0")
   - Display grid: `grid-cols-2 md:grid-cols-3 gap-4`
   - Each thumbnail: button with `relative aspect-video rounded-lg overflow-hidden border hover:border-primary`
   - Use Next.js Image with `fill`, `sizes="(max-width: 768px) 50vw, 33vw"`, `className="object-cover"`
   - Track `selectedIndex` in state, open lightbox on click
   - Import `getPublicUrl` from `@/lib/storage` to convert R2 keys to URLs
   - Add "use client" directive

Both components should be client components.
  </action>
  <verify>
Run TypeScript compilation:
```bash
npx tsc --noEmit
```
Verify files exist and export correctly:
```bash
grep -l "export.*ImageGallery\|export.*ImageLightbox" components/details/*.tsx
```
  </verify>
  <done>
ImageGallery renders clickable thumbnail grid, ImageLightbox opens full-size images with navigation, close button works on mobile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RelatedContentTab component</name>
  <files>
    components/details/RelatedContentTab.tsx
  </files>
  <action>
Create RelatedContentTab component for displaying cross-source linked content:

1. Create `components/details/RelatedContentTab.tsx`:
   - Import `LinkedDetail` type from `@/lib/db/queries/detail-links`
   - Accept props: `supplements: LinkedDetail[]` (RANZ guides linked to this MRM), `supplementsTo: LinkedDetail[]` (MRM specs this RANZ guide supports)
   - Return null if both arrays empty (use `(supplements?.length ?? 0) + (supplementsTo?.length ?? 0) === 0`)

2. Structure the component with two sections:

   **Section 1: Installation Guides & Supplements** (when `supplements.length > 0`)
   - Heading: "Installation Guides & Supplements"
   - For each linked item, render a Card with:
     - SourceBadge showing source (typically RANZ) with `authority="supplementary"`
     - Detail name as h4
     - Truncated description (if exists)
     - Badge showing "3D Model Available" if `modelUrl` exists (use Cube icon from lucide)
     - Link button "View Guide" pointing to `/detail/${linked.id}` with ArrowRight icon

   **Section 2: Related Specifications** (when `supplementsTo.length > 0`)
   - Heading: "Related Specifications"
   - For each linked item, render a Card with border-primary/20:
     - SourceBadge showing source (typically MRM) with `authority="authoritative"`
     - Detail name as h4
     - Truncated description (if exists)
     - Link button "View Spec" pointing to `/detail/${linked.id}`

3. Import from:
   - `@/components/authority` for SourceBadge
   - `@/components/ui/card` for Card, CardContent
   - `@/components/ui/button` for Button
   - `@/components/ui/badge` for Badge
   - `lucide-react` for Cube, ArrowRight icons
   - `next/link` for navigation

4. Use "use client" directive
  </action>
  <verify>
Run TypeScript compilation:
```bash
npx tsc --noEmit
```
Verify component exports:
```bash
grep "export.*RelatedContentTab" components/details/RelatedContentTab.tsx
```
  </verify>
  <done>
RelatedContentTab displays linked RANZ guides (supplements) and linked MRM specs (supplementsTo) with proper source attribution badges and navigation links.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. All three component files exist in components/details/
3. Components export named exports (not default)
4. No runtime errors when imported
</verification>

<success_criteria>
- ImageGallery handles empty/null images array gracefully
- ImageLightbox has visible close button for mobile
- RelatedContentTab uses SourceBadge with correct authority levels
- All components are client components ("use client")
- TypeScript compilation successful
</success_criteria>

<output>
After completion, create `.planning/phases/10-detail-page-enhancement/10-01-SUMMARY.md`
</output>
