---
phase: 10-detail-page-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - components/details/DetailViewer.tsx
autonomous: true

must_haves:
  truths:
    - "User viewing MRM detail with linked RANZ guide sees RANZ 3D model with attribution"
    - "User viewing MRM detail with linked RANZ guide sees RANZ installation steps with attribution"
    - "User sees Images tab only when detail has images array with content"
    - "User sees Installation tab only when steps exist (from detail or linked guide)"
    - "User sees Related tab only when linked content exists"
    - "Attribution note shows when content is borrowed from linked source"
  artifacts:
    - path: "components/details/DetailViewer.tsx"
      provides: "Enhanced detail viewer with linked content integration and conditional tabs"
      exports: ["DetailViewer", "DetailViewerSkeleton"]
  key_links:
    - from: "components/details/DetailViewer.tsx"
      to: "components/details/ImageGallery.tsx"
      via: "import and render in Images tab"
      pattern: "import.*ImageGallery"
    - from: "components/details/DetailViewer.tsx"
      to: "components/details/RelatedContentTab.tsx"
      via: "import and render in Related tab"
      pattern: "import.*RelatedContentTab"
    - from: "components/details/DetailViewer.tsx"
      to: "@/components/authority"
      via: "SourceAttribution for borrowed content"
      pattern: "SourceAttribution.*supplementary"
---

<objective>
Enhance DetailViewer to integrate linked content from RANZ guides (3D model, steps) into MRM detail pages with proper attribution, add Images tab with gallery, add Related tab, and implement conditional tab rendering.

Purpose: This is the core integration work for Phase 10. DETAIL-01 (linked 3D/steps), DETAIL-02 (image gallery), DETAIL-03 (related tab), and DETAIL-04 (dynamic sections) are all delivered through this enhancement.

Output: Enhanced DetailViewer component with full cross-source content composition.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-detail-page-enhancement/10-RESEARCH.md

# From Plan 01
@components/details/ImageGallery.tsx
@components/details/RelatedContentTab.tsx

# Existing DetailViewer to enhance
@components/details/DetailViewer.tsx

# Types for linked content
@lib/db/queries/detail-links.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update DetailViewer props and types for linked content</name>
  <files>
    components/details/DetailViewer.tsx
  </files>
  <action>
Update the DetailViewer component to accept linked content data:

1. **Update the interface** - Extend `DetailWithRelations` interface to include linked content:
   ```typescript
   // Add to interface
   images?: string[] | null;  // R2 keys for MRM technical images
   supplements?: Array<{
     id: string;
     code: string;
     name: string;
     description: string | null;
     thumbnailUrl: string | null;
     modelUrl: string | null;
     sourceId: string | null;
     sourceName: string | null;
     linkType: string;
     matchConfidence: string | null;
     steps?: Array<{
       id: string;
       stepNumber: number;
       instruction: string;
       imageUrl?: string | null;
       cautionNote?: string | null;
     }>;
   }>;
   supplementsTo?: Array<{
     id: string;
     code: string;
     name: string;
     description: string | null;
     thumbnailUrl: string | null;
     modelUrl: string | null;
     sourceId: string | null;
     sourceName: string | null;
     linkType: string;
     matchConfidence: string | null;
   }>;
   ```

2. **Add imports** at the top of the file:
   ```typescript
   import { ImageGallery } from './ImageGallery';
   import { RelatedContentTab } from './RelatedContentTab';
   import { Link2, ImageIcon } from 'lucide-react';  // Add Link2, ImageIcon
   ```

3. **Add derived display values** after the authority check (around line 128):
   ```typescript
   // Find first linked RANZ guide with 3D model (for DETAIL-01)
   const linkedGuideWithModel = detail.supplements?.find(s => s.modelUrl !== null);

   // Determine what 3D model to display (prefer detail's own, fallback to linked)
   const display3DModelUrl = detail.modelUrl || linkedGuideWithModel?.modelUrl || null;
   const is3DModelBorrowed = !detail.modelUrl && !!linkedGuideWithModel?.modelUrl;

   // Find first linked RANZ guide with steps (for DETAIL-01)
   const linkedGuideWithSteps = detail.supplements?.find(s => (s.steps?.length ?? 0) > 0);

   // Determine what steps to display (prefer detail's own, fallback to linked)
   const displaySteps = (detail.steps?.length ?? 0) > 0
     ? detail.steps
     : linkedGuideWithSteps?.steps || [];
   const areStepsBorrowed = (detail.steps?.length ?? 0) === 0 && (linkedGuideWithSteps?.steps?.length ?? 0) > 0;

   // Check if detail has images for gallery
   const hasImages = (detail.images?.length ?? 0) > 0;

   // Check if detail has linked content for Related tab
   const hasLinkedContent = (detail.supplements?.length ?? 0) > 0 || (detail.supplementsTo?.length ?? 0) > 0;
   ```

This task only updates types and derived values. Tab changes are in Task 2.
  </action>
  <verify>
TypeScript compilation passes:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
DetailViewer has extended types for linked content and derived display values for 3D model and steps.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement conditional tabs and linked content display</name>
  <files>
    components/details/DetailViewer.tsx
  </files>
  <action>
Refactor the Tabs section to use conditional rendering and add new tabs:

1. **Update 3D Model section** (around line 416-425) to use derived model URL and show attribution:
   ```typescript
   {/* 3D Model Viewer - Show if model exists (own or borrowed) */}
   {display3DModelUrl && (
     <div className="space-y-2">
       {is3DModelBorrowed && linkedGuideWithModel && (
         <SourceAttribution
           shortName={linkedGuideWithModel.sourceName || 'RANZ'}
           name="RANZ Installation Guide"
           authority="supplementary"
           note={`3D model from linked guide: ${linkedGuideWithModel.name}`}
         />
       )}
       <Model3DViewer
         modelUrl={display3DModelUrl}
         detailCode={detail.code}
         thumbnailUrl={detail.thumbnailUrl}
         activeStep={hasStepSync ? activeStep : undefined}
         stageMetadata={stageMetadata}
         onStepChange={hasStepSync ? handleStepChange : undefined}
       />
     </div>
   )}
   ```

2. **Replace static tabs with conditional tab config** (before the Tabs component):
   ```typescript
   // Build tab configuration based on available content
   interface TabConfig {
     id: string;
     label: string;
     icon: React.ComponentType<{ className?: string }>;
     badge?: number;
     badgeVariant?: 'default' | 'secondary' | 'warning';
     show: boolean;
   }

   const tabConfig: TabConfig[] = [
     {
       id: 'overview',
       label: 'Overview',
       icon: FileText,
       show: true,  // Always show
     },
     {
       id: 'images',
       label: 'Images',
       icon: ImageIcon,
       badge: detail.images?.length,
       show: hasImages,
     },
     {
       id: 'installation',
       label: 'Installation',
       icon: Wrench,
       badge: displaySteps.length > 0 ? displaySteps.length : undefined,
       show: displaySteps.length > 0,
     },
     {
       id: 'warnings',
       label: 'Warnings',
       icon: AlertTriangle,
       badge: detail.warnings?.length,
       badgeVariant: 'warning',
       show: (detail.warnings?.length ?? 0) > 0,
     },
     {
       id: 'related',
       label: 'Related',
       icon: Link2,
       badge: (detail.supplements?.length ?? 0) + (detail.supplementsTo?.length ?? 0),
       show: hasLinkedContent,
     },
     {
       id: 'references',
       label: 'References',
       icon: BookOpen,
       show: true,  // Always show (has source attribution)
     },
   ].filter(tab => tab.show);

   // Ensure activeTab is valid after filtering
   const validActiveTab = tabConfig.find(t => t.id === activeTab)?.id || tabConfig[0]?.id || 'overview';
   ```

3. **Update TabsList to use config** (replace static TabsTrigger elements):
   ```typescript
   <Tabs value={validActiveTab} onValueChange={setActiveTab} className="w-full">
     <TabsList className="w-full justify-start h-auto flex-wrap gap-1 bg-transparent p-0 border-b rounded-none">
       {tabConfig.map(tab => (
         <TabsTrigger
           key={tab.id}
           value={tab.id}
           className="data-[state=active]:border-b-2 data-[state=active]:border-primary rounded-none bg-transparent px-4 py-2"
         >
           <tab.icon className="h-4 w-4 mr-2" />
           {tab.label}
           {tab.badge !== undefined && tab.badge > 0 && (
             <Badge
               variant="secondary"
               className={cn(
                 "ml-2 text-xs",
                 tab.badgeVariant === 'warning' && "bg-amber-100 text-amber-700"
               )}
             >
               {tab.badge}
             </Badge>
           )}
         </TabsTrigger>
       ))}
     </TabsList>
   ```

4. **Add Images TabsContent** (after overview, before installation):
   ```typescript
   {/* Images Tab */}
   {hasImages && (
     <TabsContent value="images" className="mt-6">
       <ImageGallery
         images={detail.images || []}
         detailCode={detail.code}
       />
     </TabsContent>
   )}
   ```

5. **Update Installation TabsContent** to show attribution when borrowed:
   ```typescript
   {/* Installation Tab */}
   {displaySteps.length > 0 && (
     <TabsContent value="installation" className="mt-6">
       {areStepsBorrowed && linkedGuideWithSteps && (
         <div className="mb-4">
           <SourceAttribution
             shortName={linkedGuideWithSteps.sourceName || 'RANZ'}
             name="RANZ Installation Guide"
             authority="supplementary"
             note={`Installation steps from linked guide: ${linkedGuideWithSteps.name}`}
           />
         </div>
       )}
       <ContentWrapper>
         <StepByStep
           steps={displaySteps.map(step => ({
             id: step.id,
             stepNumber: step.stepNumber,
             instruction: step.instruction,
             imageUrl: step.imageUrl,
             cautionNote: step.cautionNote,
           }))}
           activeStep={hasStepSync ? activeStep : undefined}
           onStepChange={hasStepSync ? handleStepChange : undefined}
         />
       </ContentWrapper>
     </TabsContent>
   )}
   ```

6. **Add Related TabsContent** (before references):
   ```typescript
   {/* Related Content Tab */}
   {hasLinkedContent && (
     <TabsContent value="related" className="mt-6">
       <RelatedContentTab
         supplements={detail.supplements || []}
         supplementsTo={detail.supplementsTo || []}
       />
     </TabsContent>
   )}
   ```

7. **Update Warnings TabsContent** to only render if warnings exist (conditional):
   ```typescript
   {/* Warnings Tab */}
   {(detail.warnings?.length ?? 0) > 0 && (
     <TabsContent value="warnings" className="mt-6 space-y-4">
       {/* existing warnings content */}
     </TabsContent>
   )}
   ```

Make sure to close the Tabs component properly after all TabsContent elements.
  </action>
  <verify>
TypeScript compilation passes:
```bash
npx tsc --noEmit
```
No duplicate tab IDs:
```bash
grep -c "value=\"overview\"" components/details/DetailViewer.tsx
# Should return 2 (TabsTrigger and TabsContent)
```
  </verify>
  <done>
DetailViewer renders tabs conditionally based on content availability, shows borrowed 3D models and steps with attribution, includes Images and Related tabs.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. DetailViewer imports ImageGallery and RelatedContentTab
3. Conditional tabs filter correctly (no empty tabs)
4. SourceAttribution shows when content is borrowed
5. Tab state remains valid when tabs are filtered
</verification>

<success_criteria>
- MRM detail with linked RANZ guide shows RANZ 3D model with "from linked guide" attribution
- MRM detail with linked RANZ guide shows RANZ steps with attribution
- Images tab appears only when detail.images has content
- Related tab appears only when linked content exists
- Tab badges show correct counts
- No empty tab bodies rendered
</success_criteria>

<output>
After completion, create `.planning/phases/10-detail-page-enhancement/10-02-SUMMARY.md`
</output>
