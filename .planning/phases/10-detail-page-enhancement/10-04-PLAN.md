---
phase: 10-detail-page-enhancement
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/schema.ts
  - lib/db/migrations/0003_add_images_column.sql
  - lib/db/migrations/meta/_journal.json
  - lib/db/queries/detail-links.ts
  - scripts/seed-test-links.ts
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "details table has images column (nullable text array)"
    - "getDetailWithLinks returns images field"
    - "detail_links table has at least 3 test links (MRM to RANZ)"
    - "Images tab renders when detail has images"
    - "Related tab shows linked content with attribution"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "images field on details table"
      contains: "images:"
    - path: "lib/db/migrations/0003_add_images_column.sql"
      provides: "Migration adding images column"
      contains: "ALTER TABLE"
    - path: "lib/db/queries/detail-links.ts"
      provides: "images field in getDetailWithLinks query"
      contains: "images: details.images"
    - path: "scripts/seed-test-links.ts"
      provides: "Script to populate test detail_links"
      min_lines: 30
  key_links:
    - from: "lib/db/schema.ts"
      to: "lib/db/queries/detail-links.ts"
      via: "images column selected in query"
      pattern: "details\\.images"
    - from: "scripts/seed-test-links.ts"
      to: "detail_links table"
      via: "INSERT statements"
      pattern: "detail_links"
---

<objective>
Close verification gaps for Phase 10: Detail Page Enhancement

Purpose: Two blockers prevent verifying DETAIL-01, DETAIL-02, and DETAIL-03:
1. The `images` column does not exist in the details table schema
2. The `detail_links` table is empty (no test data)

Output: Database schema updated with images column, migration applied, test links populated, verification possible
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-detail-page-enhancement/10-VERIFICATION.md
@lib/db/schema.ts
@lib/db/queries/detail-links.ts
@lib/db/migrations/0002_topics_and_links.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add images column to details table schema and create migration</name>
  <files>lib/db/schema.ts, lib/db/migrations/0003_add_images_column.sql</files>
  <action>
1. In `lib/db/schema.ts`, add images field to the details table:
   - Add after `thumbnailUrl`:
     ```typescript
     images: jsonb('images').$type<string[]>(),  // R2 keys for technical images
     ```
   - Use jsonb type with string array type annotation (consistent with other array fields)

2. Create migration file `lib/db/migrations/0003_add_images_column.sql`:
   ```sql
   -- Phase 10 Gap Closure: Add images column to details table
   -- Required for DETAIL-02: MRM technical images in gallery

   ALTER TABLE "details" ADD COLUMN IF NOT EXISTS "images" jsonb;

   -- Add comment for documentation
   COMMENT ON COLUMN "details"."images" IS 'Array of R2 keys for MRM technical images';
   ```

3. Update `lib/db/migrations/meta/_journal.json` to include the new migration entry:
   - Add entry with idx: 3, when: current timestamp, tag: "0003_add_images_column"

Note: Use jsonb (not text[]) for consistency with existing array fields (substrateTags, detailTags, etc.)
  </action>
  <verify>
- `npx tsc --noEmit` passes (no type errors)
- Migration file exists at lib/db/migrations/0003_add_images_column.sql
- Schema includes images field in details table
  </verify>
  <done>details table has images column defined in schema with migration ready to apply</done>
</task>

<task type="auto">
  <name>Task 2: Update getDetailWithLinks to select images field</name>
  <files>lib/db/queries/detail-links.ts</files>
  <action>
In `lib/db/queries/detail-links.ts`, update the getDetailWithLinks function:

1. Add images to the DetailWithLinks interface (after thumbnailUrl):
   ```typescript
   images: string[] | null;
   ```

2. Add images to the base detail select clause (line ~72, after thumbnailUrl):
   ```typescript
   images: details.images,
   ```

This enables the Images tab to render when detail.images has content.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- getDetailWithLinks returns images field in result
  </verify>
  <done>getDetailWithLinks query includes images field, enabling Images tab rendering</done>
</task>

<task type="auto">
  <name>Task 3: Create and run test data seeding script</name>
  <files>scripts/seed-test-links.ts</files>
  <action>
Create `scripts/seed-test-links.ts` to populate detail_links with test data:

```typescript
/**
 * Seed test detail_links for Phase 10 verification
 * Creates MRM -> RANZ links to test borrowed content display
 *
 * Run: npx tsx scripts/seed-test-links.ts
 */

import { db } from '@/lib/db';
import { details, detailLinks } from '@/lib/db/schema';
import { eq, and, isNotNull } from 'drizzle-orm';
import { nanoid } from 'nanoid';

async function seedTestLinks() {
  console.log('Seeding test detail_links...\n');

  // Find MRM details (sourceId = 'mrm-cop') that could link to RANZ
  const mrmDetails = await db
    .select({ id: details.id, code: details.code, name: details.name })
    .from(details)
    .where(eq(details.sourceId, 'mrm-cop'))
    .limit(10);

  console.log(`Found ${mrmDetails.length} MRM details`);

  // Find RANZ details (sourceId = 'ranz-guide') with 3D models or steps
  const ranzDetails = await db
    .select({ id: details.id, code: details.code, name: details.name, modelUrl: details.modelUrl })
    .from(details)
    .where(and(
      eq(details.sourceId, 'ranz-guide'),
      isNotNull(details.modelUrl)
    ))
    .limit(10);

  console.log(`Found ${ranzDetails.length} RANZ details with 3D models\n`);

  if (mrmDetails.length === 0 || ranzDetails.length === 0) {
    console.log('Not enough details to create test links');
    console.log('MRM details:', mrmDetails.length);
    console.log('RANZ details:', ranzDetails.length);
    return;
  }

  // Create test links (MRM primary -> RANZ supplementary)
  const linksToCreate = [
    // Link 1: First MRM detail to first RANZ detail (installation_guide)
    {
      id: nanoid(),
      primaryDetailId: mrmDetails[0].id,
      supplementaryDetailId: ranzDetails[0].id,
      linkType: 'installation_guide',
      matchConfidence: 'partial',
      notes: 'Test link for Phase 10 verification',
    },
    // Link 2: Second MRM to second RANZ (if available)
    ...(mrmDetails.length > 1 && ranzDetails.length > 1 ? [{
      id: nanoid(),
      primaryDetailId: mrmDetails[1].id,
      supplementaryDetailId: ranzDetails[1].id,
      linkType: 'technical_supplement',
      matchConfidence: 'related',
      notes: 'Test link for Phase 10 verification',
    }] : []),
    // Link 3: Third MRM to third RANZ (if available)
    ...(mrmDetails.length > 2 && ranzDetails.length > 2 ? [{
      id: nanoid(),
      primaryDetailId: mrmDetails[2].id,
      supplementaryDetailId: ranzDetails[2].id,
      linkType: 'installation_guide',
      matchConfidence: 'exact',
      notes: 'Test link for Phase 10 verification',
    }] : []),
  ];

  console.log(`Creating ${linksToCreate.length} test links...\n`);

  for (const link of linksToCreate) {
    try {
      await db.insert(detailLinks).values(link).onConflictDoNothing();
      const mrm = mrmDetails.find(d => d.id === link.primaryDetailId);
      const ranz = ranzDetails.find(d => d.id === link.supplementaryDetailId);
      console.log(`Created: ${mrm?.code} (MRM) -> ${ranz?.code} (RANZ) [${link.linkType}]`);
    } catch (error) {
      console.error(`Failed to create link:`, error);
    }
  }

  console.log('\nTest links seeded successfully!');
  console.log('\nTo verify:');
  console.log('1. Visit an MRM detail page (e.g., /planner/profiled-metal/flashings/<detail-id>)');
  console.log('2. Check for "Related" tab showing linked RANZ content');
  console.log('3. Verify borrowed 3D model displays with attribution (if MRM has no model)');
}

seedTestLinks()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error('Seeding failed:', error);
    process.exit(1);
  });
```

After creating the script, run:
1. `npx drizzle-kit push` to apply the images column migration
2. `npx tsx scripts/seed-test-links.ts` to populate test links
  </action>
  <verify>
- Script exists at scripts/seed-test-links.ts
- `npx drizzle-kit push` succeeds (images column added to database)
- `npx tsx scripts/seed-test-links.ts` outputs created links
- At least 2-3 links created in detail_links table
  </verify>
  <done>detail_links table populated with 2-3 test MRM-RANZ links for verification</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Database schema updated with images column, query updated to return images, and test detail_links populated
  </what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`

2. Navigate to an MRM detail that was linked (check script output for detail codes)
   - Example URL pattern: http://localhost:3000/planner/profiled-metal/flashings/{detail-id}
   - The script output will show which MRM codes were linked

3. Verify DETAIL-01 (Borrowed Content):
   - Check if "Related" tab appears at bottom of detail page
   - Click Related tab - should show linked RANZ guide
   - If MRM detail has no 3D model but RANZ link does, verify borrowed model displays with attribution

4. Verify DETAIL-02 (Images Tab):
   - Note: Images tab will only appear if detail has images data
   - This gap closure adds the schema/query support; actual image data population is Phase 12 scope
   - Verify no errors occur (hasImages check should work correctly)

5. Verify DETAIL-03 (Related Content Tab):
   - Related tab should show "This detail is enhanced by:" section
   - Linked RANZ guides should display with:
     - Thumbnail (if available)
     - Code and name
     - Source badge (grey for supplementary)
     - Capability badges (3D icon if has model)
   - Click on linked detail should navigate to it

Expected results:
- Related tab renders with linked content
- Source attribution displays correctly
- No console errors
- Navigation between linked details works
  </how-to-verify>
  <resume-signal>Type "approved" to confirm gaps are closed, or describe any remaining issues</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run build` - Production build succeeds
3. Database has images column on details table
4. detail_links table has 2-3 test records
5. MRM detail pages show Related tab with linked RANZ content
</verification>

<success_criteria>
- [ ] images column exists in details table schema
- [ ] Migration 0003 created and applied
- [ ] getDetailWithLinks returns images field
- [ ] detail_links has test data (2-3 MRM->RANZ links)
- [ ] Related tab renders on linked MRM detail pages
- [ ] Human verification confirms gaps closed
</success_criteria>

<output>
After completion, create `.planning/phases/10-detail-page-enhancement/10-04-SUMMARY.md`
</output>
