---
phase: 10-detail-page-enhancement
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
  - lib/db/queries/detail-links.ts
autonomous: false

must_haves:
  truths:
    - "User viewing MRM detail page sees linked RANZ guide's 3D model when linked"
    - "User viewing MRM detail page sees linked RANZ guide's installation steps when linked"
    - "User can navigate to Related tab and click through to linked content"
    - "User sees Images tab with gallery when MRM detail has images"
  artifacts:
    - path: "app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx"
      provides: "Detail page using getDetailWithLinks for full content"
    - path: "lib/db/queries/detail-links.ts"
      provides: "Extended query returning linked detail steps"
      exports: ["getDetailWithLinks"]
  key_links:
    - from: "app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx"
      to: "lib/db/queries/detail-links.ts"
      via: "getDetailWithLinks import and call"
      pattern: "await getDetailWithLinks"
    - from: "app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx"
      to: "components/details/DetailViewer.tsx"
      via: "Pass linked content as props"
      pattern: "supplements.*supplementsTo"
---

<objective>
Wire up detail page to use getDetailWithLinks query and pass linked content to DetailViewer, then verify the complete integration visually.

Purpose: This completes the Phase 10 integration by connecting the enhanced DetailViewer to actual linked data from the database. This enables all four DETAIL requirements to function end-to-end.

Output: Working detail page that displays linked content with proper attribution.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-detail-page-enhancement/10-RESEARCH.md

# From Plan 02
@components/details/DetailViewer.tsx

# Query to enhance
@lib/db/queries/detail-links.ts

# Page to modify
@app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance getDetailWithLinks to include linked detail steps</name>
  <files>
    lib/db/queries/detail-links.ts
  </files>
  <action>
Enhance the getDetailWithLinks function to also fetch steps for linked details:

1. **Update the LinkedDetail interface** to include optional steps:
   ```typescript
   export interface LinkedDetail {
     id: string;
     code: string;
     name: string;
     description: string | null;
     thumbnailUrl: string | null;
     modelUrl: string | null;
     sourceId: string | null;
     sourceName: string | null;
     linkType: LinkType;
     matchConfidence: MatchConfidence | null;
     steps?: Array<{
       id: string;
       stepNumber: number;
       instruction: string;
       imageUrl: string | null;
       cautionNote: string | null;
     }>;
   }
   ```

2. **Import detailSteps** from schema:
   ```typescript
   import { detailLinks, details, contentSources, detailSteps } from '@/lib/db/schema';
   ```

3. **After fetching supplements**, fetch steps for each supplement that might have them:
   ```typescript
   // After the supplements query, fetch steps for linked details
   const supplementsWithSteps = await Promise.all(
     supplements.map(async (linked) => {
       // Only fetch steps if this linked detail might have them (RANZ guides)
       const steps = await db
         .select({
           id: detailSteps.id,
           stepNumber: detailSteps.stepNumber,
           instruction: detailSteps.instruction,
           imageUrl: detailSteps.imageUrl,
           cautionNote: detailSteps.cautionNote,
         })
         .from(detailSteps)
         .where(eq(detailSteps.detailId, linked.id))
         .orderBy(detailSteps.stepNumber);

       return {
         ...linked,
         steps: steps.length > 0 ? steps : undefined,
       };
     })
   );
   ```

4. **Update the return statement** to use supplementsWithSteps:
   ```typescript
   return {
     ...detail,
     supplements: supplementsWithSteps as LinkedDetail[],
     supplementsTo: supplementsTo as LinkedDetail[],
   };
   ```

5. **Also add images field** to the base detail query if not already present:
   Check if images column exists in the select. If not, add:
   ```typescript
   images: details.images,
   ```
  </action>
  <verify>
TypeScript compilation passes:
```bash
npx tsc --noEmit
```
Verify images field is selected:
```bash
grep "images:" lib/db/queries/detail-links.ts
```
  </verify>
  <done>
getDetailWithLinks returns supplements with their steps populated, enabling borrowed steps display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update detail page to use getDetailWithLinks</name>
  <files>
    app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
  </files>
  <action>
Update the detail page to fetch linked content and pass it to DetailViewer:

1. **Read the current page file** to understand its structure.

2. **Import getDetailWithLinks**:
   ```typescript
   import { getDetailWithLinks } from '@/lib/db/queries/detail-links';
   ```

3. **Replace or augment the existing detail fetch** to use getDetailWithLinks:
   - Find where the detail is currently fetched (likely using db.select or a simpler query)
   - Replace with: `const detailWithLinks = await getDetailWithLinks(detailId);`
   - Handle null case: if (!detailWithLinks) return notFound();

4. **Fetch additional data** that getDetailWithLinks doesn't include (warnings, failures, steps for the main detail, substrate, category):
   - The existing page likely fetches these. Keep those queries.
   - Merge the results:
   ```typescript
   const fullDetail = {
     ...detailWithLinks,
     substrate: existingSubstrate,
     category: existingCategory,
     source: existingSource,
     steps: existingSteps,
     warnings: existingWarnings,
     failures: existingFailures,
     // supplements and supplementsTo come from getDetailWithLinks
   };
   ```

5. **Pass supplements and supplementsTo to DetailViewer**:
   - The enhanced DetailViewer expects these in the detail prop
   - Ensure they're included in the object passed to DetailViewer

6. **If the page doesn't have a detail API route** and queries directly:
   - Keep the existing queries for substrate, category, source, steps, warnings, failures
   - Just add getDetailWithLinks for the linked content
   - Merge appropriately

The goal is minimal changes: add linked content fetch, pass to DetailViewer.
  </action>
  <verify>
Development server runs without errors:
```bash
cd "C:\Users\LukeBoustridge\Projects\RANZ\Master Roofers Code of Practice" && npm run build 2>&1 | head -50
```
Or if build is slow, just TypeScript check:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
Detail page fetches linked content via getDetailWithLinks and passes supplements/supplementsTo to DetailViewer.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 10 integration: Detail pages now display linked content with attribution:
- MRM details show linked RANZ 3D models (with attribution)
- MRM details show linked RANZ installation steps (with attribution)
- Images tab displays MRM technical images in gallery
- Related tab shows cross-source linked content
- Tabs appear/hide based on content availability
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to an MRM detail that has a linked RANZ guide (if any links exist)
3. Verify:
   - 3D model section shows attribution if model is from linked guide
   - Installation tab shows attribution if steps are borrowed
   - Related tab appears and shows linked content with correct source badges
4. Navigate to an MRM detail with images (detail.images populated)
5. Verify:
   - Images tab appears
   - Clicking thumbnail opens lightbox
   - Lightbox has close button and navigation arrows
6. Navigate to a detail with NO linked content:
   - Verify Related tab does NOT appear
7. Navigate to a detail with NO images:
   - Verify Images tab does NOT appear
8. Check responsive behavior on mobile viewport

If no linked details exist yet, verify:
- Related tab does not appear (correct behavior)
- Images tab appears/hides correctly based on images array
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. npm run build succeeds (or dev server starts)
3. Detail pages render without errors
4. Linked content displays with attribution
5. Conditional tabs work correctly
</verification>

<success_criteria>
- MRM detail with linked RANZ guide shows borrowed 3D model with attribution note
- MRM detail with linked RANZ guide shows borrowed steps with attribution note
- Images tab works: grid -> lightbox -> close
- Related tab shows linked content with source badges
- Empty tabs don't render (no "0" or empty bodies)
- Navigation between linked details works
</success_criteria>

<output>
After completion, create `.planning/phases/10-detail-page-enhancement/10-03-SUMMARY.md`
</output>
