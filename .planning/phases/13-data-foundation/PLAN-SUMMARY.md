# Phase 13: Data Foundation - Plan Summary

**Created:** 2026-02-08
**Plans:** 2
**Complexity:** High (Plan 01), Medium (Plan 02)

## Overview

Phase 13 transforms the 624-page MRM Code of Practice PDF into a queryable database structure with lightweight JSON delivery. The extracted data already exists in `mrm_extract/` (sections_hierarchy.json with 1,122 sections, 775 images, metadata). This phase creates the hybrid data model: PostgreSQL stores hierarchy/structure, static JSON files serve per-chapter content.

## Execution Order

**Must run sequentially:**
1. Plan 13-01 (database schema + imports) creates tables and populates hierarchy
2. Plan 13-02 (chapter JSON split + linking) requires populated tables from 13-01

**Estimated time:** 3-4 hours total (mostly running import scripts)

## Plan 13-01: Database Schema and COP Hierarchy Import

**Delivers:**
- 5 new Drizzle tables: `cop_sections`, `cop_section_images`, `cop_section_details`, `htg_content`, `cop_section_htg`
- 1,122 COP sections imported with correct hierarchy
- 772 section-image mappings imported
- HTG tables created as empty structures (populated in Phase 17)

**Key files created:**
- `lib/db/schema.ts` (modified - 5 new table definitions)
- `lib/db/migrations/0005_cop_tables.sql` (generated by Drizzle Kit)
- `lib/db/import-cop-hierarchy.ts` (import script)
- `lib/db/import-cop-images.ts` (import script)

**Scripts added to package.json:**
- `db:import-cop-hierarchy`
- `db:import-cop-images`

**Verification checklist:**
- [ ] Migration applied successfully (5 tables created, 8 indexes)
- [ ] `cop_sections` contains 800-1,122 records, 19 distinct chapters
- [ ] `cop_section_images` contains 772 records
- [ ] `htg_content` and `cop_section_htg` are empty (0 records)
- [ ] `cop_section_details` is empty (populated in 13-02)
- [ ] Section hierarchy visible in Drizzle Studio (parent_id relationships)

## Plan 13-02: Chapter JSON Split and Section-Detail Linking

**Delivers:**
- 19 per-chapter JSON files in `/public/cop/` (e.g., `chapter-1.json`, `chapter-8.json`)
- Embedded R2 image URLs in chapter JSON (no additional API calls)
- Section-detail links in `cop_section_details` table (best-effort, may be 0 if no explicit references)

**Key files created:**
- `lib/db/split-chapter-json.ts` (split script)
- `lib/db/link-cop-section-details.ts` (linking script)
- `public/cop/chapter-1.json` through `public/cop/chapter-19.json` (19 files)

**Scripts added to package.json:**
- `db:split-chapter-json`
- `db:link-cop-section-details`

**Verification checklist:**
- [ ] 19 JSON files exist in `public/cop/`
- [ ] Largest file (Chapter 19) ~619 KB uncompressed
- [ ] JSON is minified (no pretty-printing)
- [ ] Images array present in chapters with diagrams (e.g., Chapter 8)
- [ ] `cop_section_details` populated (0 to ~200 records, depends on content)
- [ ] Total size of `/public/cop/` ~4-5 MB

## Requirements Addressed

| Requirement | Plan | Status |
|-------------|------|--------|
| COPR-01: All 19 MRM COP chapters in database | 13-01 | ✓ 1,122 sections imported |
| COPR-02: 775 diagrams mapped to sections | 13-01 | ✓ 772 mapped (3 unmapped frontmatter) |
| COPR-04: Per-chapter JSON < 100KB compressed | 13-02 | ✓ Most chapters, Ch 19 edge case |

## Data Validation

### Section counts by chapter (expected):
- Chapter 1 (Introduction): ~12 sections
- Chapter 2 (Glossary): ~87 sections
- Chapter 8 (Flashings): ~92 sections
- Chapter 19 (Revision History): ~143 sections (largest)
- **Total: 800-1,122 sections**

### Image distribution:
- 772 images with section mapping
- 3 images without section (cover/frontmatter, intentionally skipped)
- **Total: 775 images**

### File sizes (uncompressed):
- Smallest: Chapter 6 ~12 KB
- Average: ~209 KB
- Largest: Chapter 19 ~619 KB
- **Total: ~4-5 MB**

## Known Issues

### Chapter 19 size warning
Chapter 19 (Revision History) is 619KB uncompressed, likely ~186KB compressed with Brotli. This exceeds the 100KB compressed target by ~86KB.

**Impact:** Mobile 4G load time may exceed 3s TTI target
**Mitigation options (defer to future):**
- Paginate revision history (split by year/version)
- Extract to separate route (`/cop/revision-history`)
- Lazy-load older revisions

**Decision:** Document as known issue, test in Phase 14 (Basic Reader). Only address if performance testing shows actual impact.

### Section-detail links may be zero
The automated linking script searches for explicit detail code references (e.g., "F07", "P12") in COP text. If COP uses narrative descriptions instead, zero links may be found.

**Impact:** No automated cross-linking between COP sections and existing details
**Mitigation:** Manual curation via admin UI (Phase 16+)
**Decision:** Acceptable for MVP. Table structure exists, populate later if needed.

## Technical Decisions

### Text-based IDs
Using semantic IDs like `cop-8.5.4A` instead of auto-increment integers:
- **Pro:** Readable URLs, natural foreign keys, matches section numbering
- **Con:** Slightly larger storage (text vs int)
- **Decision:** Chosen to match existing schema patterns

### Hybrid storage model
Structure in PostgreSQL, content in static JSON:
- **Pro:** Avoids TOAST (>2KB) performance cliff, enables CDN caching, reduces DB load
- **Con:** Content updates require regenerating JSON files
- **Decision:** Chosen per research recommendations

### Minified JSON
Output minified (no pretty-printing) for production:
- **Pro:** Smaller file sizes (~10-15% reduction)
- **Con:** Harder to debug/inspect
- **Decision:** Minified for production, can pretty-print during dev if needed

## Next Steps

**Phase 14 (Basic Reader):**
- Create `/cop` home page (19-chapter card grid)
- Create `/cop/[sectionNumber]` dynamic route
- Render chapter JSON with inline images
- Add breadcrumbs and section navigation

**Phase 15 (Navigation Chrome):**
- Desktop chapter-section tree sidebar
- Mobile chapter drawer
- Update main sidebar (COP Reader promoted to primary)

**Phase 17 (HTG Content Pipeline):**
- Extract HTG guide content from PDFs
- Populate `htg_content` and `cop_section_htg` tables
- Add HTG panels to supplementary accordion

## Quick Command Reference

```bash
# Phase 13-01: Database schema + imports
npm run db:generate              # Generate migration from schema
npm run db:push                  # Apply migration to database
npm run db:import-cop-hierarchy  # Import 1,122 sections (~2-3 min)
npm run db:import-cop-images     # Import 772 images (~20 sec)

# Phase 13-02: Chapter JSON + linking
npm run db:split-chapter-json         # Split into 19 files (~5 sec)
npm run db:link-cop-section-details   # Link sections to details (~10 sec)

# Verification
npm run db:studio                # Open Drizzle Studio
ls public/cop/*.json | wc -l     # Count chapter files (should be 19)
du -sh public/cop/               # Check total size (~4-5 MB)
```

## Files Modified/Created

### Modified:
- `lib/db/schema.ts` (5 new table definitions)
- `package.json` (4 new scripts)

### Created:
- `lib/db/migrations/0005_cop_tables.sql` (generated)
- `lib/db/import-cop-hierarchy.ts`
- `lib/db/import-cop-images.ts`
- `lib/db/split-chapter-json.ts`
- `lib/db/link-cop-section-details.ts`
- `public/cop/chapter-{1-19}.json` (19 files)

### Unchanged (input data):
- `mrm_extract/sections_hierarchy.json`
- `mrm_extract/images_manifest.json`
- `mrm_extract/r2_image_urls.json`
- `mrm_extract/metadata.json`

---

**Success criteria:** All verification checklists pass, 19 chapter files exist, database queries return expected counts, no errors during import scripts.
