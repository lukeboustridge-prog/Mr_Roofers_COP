---
phase: 11-search-enhancement
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - components/search/GroupedSearchResults.tsx
  - components/search/SearchResultCard.tsx
  - app/(dashboard)/search/page.tsx
autonomous: true

must_haves:
  truths:
    - "Search results display in grouped format with MRM section first"
    - "Visual separator exists between MRM and RANZ sections"
    - "Consent mode toggle appears in search UI and hides RANZ content when enabled"
    - "Section number search (e.g., '4.3.2') navigates to COP section"
  artifacts:
    - path: "components/search/GroupedSearchResults.tsx"
      provides: "Grouped search results with MRM first, RANZ second"
      exports: ["GroupedSearchResults"]
    - path: "components/search/SearchResultCard.tsx"
      provides: "Individual search result card with source badge"
      exports: ["SearchResultCard"]
    - path: "app/(dashboard)/search/page.tsx"
      provides: "Search page with grouped results and consent mode"
      contains: "GroupedSearchResults"
  key_links:
    - from: "app/(dashboard)/search/page.tsx"
      to: "components/search/GroupedSearchResults.tsx"
      via: "import GroupedSearchResults"
      pattern: "import.*GroupedSearchResults"
    - from: "app/(dashboard)/search/page.tsx"
      to: "components/search/ConsentModeToggle.tsx"
      via: "import ConsentModeToggle"
      pattern: "import.*ConsentModeToggle"
    - from: "components/search/GroupedSearchResults.tsx"
      to: "components/authority/SourceBadge.tsx"
      via: "import SourceBadge"
      pattern: "import.*SourceBadge"
---

<objective>
Create grouped search results display with MRM/RANZ sections, integrate consent mode toggle, and add section number navigation.

Purpose: Present search results in authority-grouped format (MRM first, then RANZ) with clear visual separation, enable consent mode filtering from UI, and allow direct navigation to COP sections via section number search (SEARCH-02, SEARCH-03, SEARCH-04 requirements).

Output: GroupedSearchResults component, enhanced search page with consent mode toggle, section number redirect handling.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-search-enhancement/11-RESEARCH.md
@.planning/phases/11-search-enhancement/11-01-SUMMARY.md
@.planning/phases/11-search-enhancement/11-02-SUMMARY.md

@app/(dashboard)/search/page.tsx
@components/authority/SourceBadge.tsx
@components/search/ConsentModeToggle.tsx
@lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SearchResultCard component</name>
  <files>
    components/search/SearchResultCard.tsx
  </files>
  <action>
Create `components/search/SearchResultCard.tsx` - a refactored search result card with source badge:

```typescript
'use client';

import Link from 'next/link';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { SourceBadge } from '@/components/authority/SourceBadge';
import { FileText, AlertTriangle, Zap } from 'lucide-react';
import { cn } from '@/lib/utils';
import { getAuthorityLevel, CONTENT_SOURCES } from '@/lib/constants';

interface SearchResultCardProps {
  result: {
    id: string;
    code: string;
    name: string;
    description: string | null;
    substrateId: string | null;
    categoryId: string | null;
    sourceId: string | null;
    type: 'detail' | 'failure';
    warningCount?: number;
    failureCount?: number;
    isExactMatch?: boolean;
    relevanceScore?: number;
  };
  substrateName?: string;
}

/**
 * Individual search result card with source badge and authority styling.
 * Used within GroupedSearchResults for consistent result display.
 */
export function SearchResultCard({ result, substrateName }: SearchResultCardProps) {
  const authority = getAuthorityLevel(result.sourceId);
  const source = CONTENT_SOURCES.find(s => s.id === result.sourceId);

  const getResultLink = () => {
    if (result.type === 'failure') {
      return `/failures/${result.id}`;
    }
    return `/planner/${result.substrateId}/${result.categoryId}/${result.id}`;
  };

  return (
    <Link
      href={getResultLink()}
      aria-label={`${result.type === 'failure' ? 'Failure case' : 'Detail'}: ${result.code} - ${result.name}`}
    >
      <Card
        className={cn(
          'cursor-pointer transition-all hover:shadow-md active:scale-[0.99] touch-manipulation focus-within:ring-2 focus-within:ring-primary',
          result.type === 'failure'
            ? 'hover:border-red-300'
            : authority === 'authoritative'
            ? 'hover:border-primary/50 border-l-4 border-l-primary'
            : 'hover:border-slate-300 border-l-4 border-l-slate-200'
        )}
      >
        <CardContent className="flex items-center justify-between p-4 min-h-[80px]">
          <div className="flex items-center gap-4 min-w-0">
            <div
              className={cn(
                'flex h-12 w-12 items-center justify-center rounded-lg flex-shrink-0',
                result.type === 'failure'
                  ? 'bg-red-100'
                  : authority === 'authoritative'
                  ? 'bg-primary/10'
                  : 'bg-slate-100'
              )}
            >
              {result.type === 'failure' ? (
                <AlertTriangle className="h-6 w-6 text-red-600" aria-hidden="true" />
              ) : result.isExactMatch ? (
                <Zap className="h-6 w-6 text-primary" aria-hidden="true" />
              ) : (
                <FileText
                  className={cn(
                    'h-6 w-6',
                    authority === 'authoritative' ? 'text-primary' : 'text-slate-600'
                  )}
                  aria-hidden="true"
                />
              )}
            </div>
            <div className="min-w-0">
              <div className="flex items-center gap-2 flex-wrap">
                <Badge
                  variant="outline"
                  className={cn(
                    'font-mono',
                    result.type === 'failure'
                      ? 'border-red-300 text-red-700'
                      : authority === 'authoritative'
                      ? 'border-primary/50 text-primary'
                      : ''
                  )}
                >
                  {result.code}
                </Badge>
                {result.type === 'failure' ? (
                  <Badge className="bg-red-100 text-red-700 text-xs">
                    Case Law
                  </Badge>
                ) : source && (
                  <SourceBadge
                    shortName={source.shortName}
                    name={source.name}
                    authority={authority}
                    size="sm"
                  />
                )}
                <span className="font-medium text-slate-900 truncate">
                  {result.name}
                </span>
              </div>
              <p className="text-sm text-slate-500 truncate">
                {result.type === 'failure'
                  ? result.description?.slice(0, 80) + (result.description && result.description.length > 80 ? '...' : '')
                  : substrateName}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2 flex-shrink-0">
            {(result.warningCount ?? 0) > 0 && (
              <Badge className="bg-amber-100 text-amber-700">
                <AlertTriangle className="mr-1 h-3 w-3" aria-hidden="true" />
                <span aria-label={`${result.warningCount} warnings`}>
                  {result.warningCount}
                </span>
              </Badge>
            )}
            {(result.failureCount ?? 0) > 0 && (
              <Badge className="bg-red-100 text-red-700">
                <span aria-label={`${result.failureCount} failure cases`}>
                  {result.failureCount}
                </span>
              </Badge>
            )}
          </div>
        </CardContent>
      </Card>
    </Link>
  );
}
```

This component:
- Uses authority-aware border styling (blue left border for MRM, grey for RANZ)
- Shows SourceBadge with authority variant
- Displays exact match indicator with Zap icon
- Maintains existing warning/failure count badges
- Works standalone or within GroupedSearchResults
  </action>
  <verify>
Run TypeScript compilation:
```bash
npx tsc --noEmit components/search/SearchResultCard.tsx
```
Should compile without errors.
  </verify>
  <done>
SearchResultCard component created with source badge and authority-aware styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GroupedSearchResults component</name>
  <files>
    components/search/GroupedSearchResults.tsx
  </files>
  <action>
Create `components/search/GroupedSearchResults.tsx`:

```typescript
'use client';

import { SourceBadge } from '@/components/authority/SourceBadge';
import { SearchResultCard } from './SearchResultCard';
import { BookOpen, Library } from 'lucide-react';
import { cn } from '@/lib/utils';
import { SUBSTRATES } from '@/lib/constants';

interface SearchResult {
  id: string;
  code: string;
  name: string;
  description: string | null;
  substrateId: string | null;
  categoryId: string | null;
  sourceId: string | null;
  type: 'detail' | 'failure';
  warningCount?: number;
  failureCount?: number;
  isExactMatch?: boolean;
  relevanceScore?: number;
}

interface GroupedSearchResultsProps {
  results: SearchResult[];
  consentMode: boolean;
  className?: string;
}

interface SectionHeaderProps {
  title: string;
  count: number;
  icon: React.ReactNode;
  iconColor: string;
  badgeVariant: 'authoritative' | 'supplementary';
  badgeText: string;
}

function SectionHeader({ title, count, icon, iconColor, badgeVariant, badgeText }: SectionHeaderProps) {
  return (
    <div className="flex items-center justify-between mb-4">
      <div className="flex items-center gap-3">
        <div className={cn('h-8 w-8 rounded-lg flex items-center justify-center',
          badgeVariant === 'authoritative' ? 'bg-primary/10' : 'bg-slate-100'
        )}>
          {icon}
        </div>
        <div>
          <h2 className="text-lg font-semibold text-slate-900">{title}</h2>
          <p className="text-sm text-slate-500">
            {count} result{count !== 1 ? 's' : ''}
          </p>
        </div>
      </div>
      <SourceBadge shortName={badgeText} authority={badgeVariant} size="md" />
    </div>
  );
}

/**
 * Groups search results by source with visual separation.
 * MRM COP results appear first (authoritative), followed by RANZ Guide (supplementary).
 * When consent mode is enabled, only MRM results are shown.
 */
export function GroupedSearchResults({ results, consentMode, className }: GroupedSearchResultsProps) {
  // Group results by source
  const mrmResults = results.filter(r => r.sourceId === 'mrm-cop');
  const ranzResults = results.filter(r => r.sourceId === 'ranz-guide');
  const otherResults = results.filter(r => r.sourceId !== 'mrm-cop' && r.sourceId !== 'ranz-guide');

  const getSubstrateName = (id: string | null) => {
    if (!id) return 'Unknown';
    return SUBSTRATES.find(s => s.id === id)?.name || id;
  };

  // If consent mode, only show MRM
  if (consentMode) {
    if (mrmResults.length === 0) {
      return (
        <div className={cn('text-center py-8', className)}>
          <BookOpen className="h-12 w-12 mx-auto text-slate-300 mb-4" />
          <p className="text-slate-500">No authoritative MRM COP content found for this search.</p>
          <p className="text-sm text-slate-400 mt-2">
            Try disabling Building Code Citation Mode to see supplementary content.
          </p>
        </div>
      );
    }

    return (
      <div className={className}>
        <SectionHeader
          title="MRM Code of Practice"
          count={mrmResults.length}
          icon={<BookOpen className="h-5 w-5 text-primary" />}
          iconColor="text-primary"
          badgeVariant="authoritative"
          badgeText="MRM COP"
        />
        <div className="space-y-3" role="list" aria-label="MRM COP search results">
          {mrmResults.map(result => (
            <SearchResultCard
              key={result.id}
              result={result}
              substrateName={getSubstrateName(result.substrateId)}
            />
          ))}
        </div>
      </div>
    );
  }

  // Show both sections with visual separation
  const hasMrmResults = mrmResults.length > 0;
  const hasRanzResults = ranzResults.length > 0;
  const hasOtherResults = otherResults.length > 0;

  if (!hasMrmResults && !hasRanzResults && !hasOtherResults) {
    return null;
  }

  return (
    <div className={cn('space-y-8', className)}>
      {/* MRM COP Section (Authoritative) */}
      {hasMrmResults && (
        <section aria-labelledby="mrm-section-heading">
          <SectionHeader
            title="MRM Code of Practice"
            count={mrmResults.length}
            icon={<BookOpen className="h-5 w-5 text-primary" />}
            iconColor="text-primary"
            badgeVariant="authoritative"
            badgeText="Authoritative"
          />
          <div className="space-y-3" role="list" aria-label="MRM COP search results">
            {mrmResults.map(result => (
              <SearchResultCard
                key={result.id}
                result={result}
                substrateName={getSubstrateName(result.substrateId)}
              />
            ))}
          </div>
        </section>
      )}

      {/* Visual Separator */}
      {hasMrmResults && hasRanzResults && (
        <div className="relative">
          <div className="absolute inset-0 flex items-center" aria-hidden="true">
            <div className="w-full border-t border-slate-200" />
          </div>
          <div className="relative flex justify-center">
            <span className="bg-white px-3 text-sm text-slate-500">
              Supplementary Content
            </span>
          </div>
        </div>
      )}

      {/* RANZ Guide Section (Supplementary) */}
      {hasRanzResults && (
        <section aria-labelledby="ranz-section-heading">
          <SectionHeader
            title="RANZ Roofing Guide"
            count={ranzResults.length}
            icon={<Library className="h-5 w-5 text-slate-500" />}
            iconColor="text-slate-500"
            badgeVariant="supplementary"
            badgeText="Supplementary"
          />
          <div className="space-y-3" role="list" aria-label="RANZ Guide search results">
            {ranzResults.map(result => (
              <SearchResultCard
                key={result.id}
                result={result}
                substrateName={getSubstrateName(result.substrateId)}
              />
            ))}
          </div>
        </section>
      )}

      {/* Other sources (failures, etc.) */}
      {hasOtherResults && (
        <section>
          <div className="text-sm text-slate-500 mb-3">Other Results</div>
          <div className="space-y-3" role="list" aria-label="Other search results">
            {otherResults.map(result => (
              <SearchResultCard
                key={result.id}
                result={result}
                substrateName={getSubstrateName(result.substrateId)}
              />
            ))}
          </div>
        </section>
      )}
    </div>
  );
}
```

This component:
- Groups results by sourceId (MRM first, RANZ second, others last)
- Shows visual separator ("Supplementary Content" divider) between sections
- Renders section headers with source badges and counts
- In consent mode, shows only MRM results or empty state message
- Uses SearchResultCard for individual results
- Maintains accessibility with aria-labels and landmarks
  </action>
  <verify>
Run TypeScript compilation:
```bash
npx tsc --noEmit components/search/GroupedSearchResults.tsx
```
Should compile without errors.
  </verify>
  <done>
GroupedSearchResults component created with MRM/RANZ sections, visual separator, and consent mode support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate components into search page</name>
  <files>
    app/(dashboard)/search/page.tsx
  </files>
  <action>
Update `app/(dashboard)/search/page.tsx` to use new components and handle section navigation:

Key changes:
1. Import GroupedSearchResults, ConsentModeToggle, and SearchResultCard
2. Add consentMode to performSearch API call
3. Handle section redirect responses from API
4. Replace existing results rendering with GroupedSearchResults
5. Add ConsentModeToggle in filters section
6. Read consentMode from URL searchParams

Update the search result interface to include sourceId:
```typescript
interface SearchResult {
  id: string;
  code: string;
  name: string;
  description: string | null;
  substrateId: string | null;
  categoryId: string | null;
  sourceId: string | null; // NEW
  type: 'detail' | 'failure';
  warningCount: number;
  failureCount: number;
  isExactMatch?: boolean;
  relevanceScore?: number; // NEW
}
```

In performSearch function, add consentMode to API call:
```typescript
const consentMode = searchParams.get('consentMode') === 'true';
// In fetch params:
if (consentMode) {
  params.append('consentMode', 'true');
}
```

Handle section redirect response:
```typescript
const data = await response.json();
// Check for section redirect
if (data.redirect) {
  router.push(data.redirect);
  return;
}
```

Add ConsentModeToggle below search input, before filter panel:
```tsx
{/* Consent Mode Toggle */}
<div className="flex items-center justify-between flex-wrap gap-4">
  <ConsentModeToggle />
  <Button variant={showFilters ? 'secondary' : 'outline'} ... />
</div>
```

Replace results rendering section to use GroupedSearchResults:
```tsx
{results.length > 0 ? (
  <GroupedSearchResults
    results={results}
    consentMode={searchParams.get('consentMode') === 'true'}
  />
) : (
  // Empty state
)}
```

Remove existing inline result mapping since GroupedSearchResults handles display.
  </action>
  <verify>
1. Run dev server: `npm run dev`
2. Visit /search
3. Search for "valley" - results should be grouped (MRM first, then RANZ)
4. Enable consent mode toggle - only MRM results should show
5. Search for "4.3.2" - should navigate to /search?q=4.3.2&source=mrm-cop (section search)
6. Toggle consent mode off - RANZ results should reappear
  </verify>
  <done>
Search page displays grouped results with MRM first, consent mode toggle functional, section number navigation working.
  </done>
</task>

</tasks>

<verification>
1. GroupedSearchResults component exists and groups results by source
2. SearchResultCard shows source badge with authority styling
3. Visual separator appears between MRM and RANZ sections
4. ConsentModeToggle appears on search page and persists to URL
5. When consent mode enabled, only MRM results display
6. Section number search (e.g., "4.3.2") navigates to section-filtered search
7. TypeScript compiles without errors
8. All components accessible (aria-labels, landmarks)
</verification>

<success_criteria>
- Search results grouped with MRM section first, RANZ section second
- Clear visual separator between authority levels
- ConsentModeToggle visible and functional on search page
- Consent mode hides RANZ results when enabled
- Section number queries trigger navigation redirect
- All new components export correctly
- TypeScript compiles without errors
- Mobile touch targets maintain 48px minimum
</success_criteria>

<output>
After completion, create `.planning/phases/11-search-enhancement/11-03-SUMMARY.md`
</output>
