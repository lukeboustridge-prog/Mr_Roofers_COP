---
phase: 22-htg-detail-level-mapping
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - components/details/HtgDetailPanel.tsx
  - components/details/DetailViewer.tsx
  - app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
  - app/(dashboard)/fixer/[detailId]/page.tsx
autonomous: true
must_haves:
  truths:
    - "Detail pages with HTG mappings show HTG content inline as a collapsible panel or dedicated tab"
    - "HTG content on detail pages includes a link back to the full HTG guide for broader context"
    - "Roofer viewing a detail page sees relevant HTG installation guidance if available"
  artifacts:
    - path: "components/details/HtgDetailPanel.tsx"
      provides: "Collapsible HTG content panel for detail pages"
      exports: ["HtgDetailPanel"]
    - path: "components/details/DetailViewer.tsx"
      provides: "Updated DetailViewer with HTG tab"
      contains: "htgContent"
  key_links:
    - from: "app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx"
      to: "lib/db/queries/htg-detail.ts"
      via: "getHtgForDetail query call"
      pattern: "getHtgForDetail"
    - from: "components/details/DetailViewer.tsx"
      to: "components/details/HtgDetailPanel.tsx"
      via: "HtgDetailPanel import and rendering in HTG tab"
      pattern: "HtgDetailPanel"
    - from: "app/(dashboard)/fixer/[detailId]/page.tsx"
      to: "lib/db/queries/htg-detail.ts"
      via: "getHtgForDetail query call"
      pattern: "getHtgForDetail"
---

<objective>
Display HTG content on detail pages. Create an HtgDetailPanel component for rendering HTG guide excerpts, add an "HTG Guide" tab to DetailViewer when HTG mappings exist, and wire the getHtgForDetail query into both planner and fixer detail pages.

Purpose: Makes relevant RANZ How-To Guide installation guidance visible on individual detail pages, not just in the COP Reader. A roofer viewing a flashing detail (F07) will see applicable HTG pages inline.

Output: HtgDetailPanel component, updated DetailViewer with HTG tab, wired detail pages.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-htg-detail-level-mapping/22-01-SUMMARY.md
@components/details/DetailViewer.tsx
@components/cop/SupplementaryPanel.tsx
@lib/db/queries/htg-detail.ts
@app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
@app/(dashboard)/fixer/[detailId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HtgDetailPanel component and add HTG tab to DetailViewer</name>
  <files>
    components/details/HtgDetailPanel.tsx
    components/details/DetailViewer.tsx
  </files>
  <action>
1. **Create `components/details/HtgDetailPanel.tsx`** — a client component that renders HTG content for a detail page.

```tsx
'use client';

import { useState } from 'react';
import { BookOpen, ChevronDown, FileText, ArrowUpRight } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import { cn } from '@/lib/utils';

export interface HtgDetailItem {
  htgId: string;
  guideName: string;
  sourceDocument: string;
  content: string | null;
  pdfPage: number | null;
  relevance: string | null;
  matchType: string | null;
}

interface HtgDetailPanelProps {
  items: HtgDetailItem[];
}
```

The component should:
- Accept `items: HtgDetailItem[]` prop
- Group items by `sourceDocument` (flashings, penetrations, cladding)
- Display a readable guide title for each sourceDocument: { flashings: 'RANZ Metal Roof Flashings Guide', penetrations: 'RANZ Metal Roof Penetrations Guide', cladding: 'RANZ Metal Wall Cladding Guide' }
- For each group, show a collapsible section with:
  - Guide title as header with BookOpen icon
  - Badge showing the number of relevant pages
  - Each page as a card showing: page number, first ~200 chars of content (truncated at sentence boundary), and relevance badge ('Primary' green or 'Supplementary' grey)
- Each page card has a "View in COP Reader" link button with ArrowUpRight icon. The link should navigate to the COP Reader chapter where this HTG guide is shown: `/cop/8` for flashings, `/cop/9` for penetrations, `/cop/6` for cladding (HTG-03 requirement: link back to full HTG guide for broader context)
- Pages with relevance='primary' should be displayed first within each group
- If there are many pages (>5 per group), show first 3 and a "Show N more" expand button
- Style the collapsible sections open by default (unlike SupplementaryPanel which starts closed) because this is the primary content the user navigated to this tab for

2. **Update `components/details/DetailViewer.tsx`** to add HTG support:

a. Add imports:
```tsx
import { HtgDetailPanel } from './HtgDetailPanel';
import type { HtgDetailItem } from './HtgDetailPanel';
```

b. Add `htgContent` to `DetailViewerProps`:
```tsx
interface DetailViewerProps {
  detail: DetailWithRelations;
  stageMetadata?: DetailStageMetadata | null;
  copExcerpts?: CopExcerptData[];
  htgContent?: HtgDetailItem[];  // <-- add this
  isLoading?: boolean;
  showBreadcrumb?: boolean;
}
```

c. Destructure `htgContent` from props in the component function signature.

d. Add a computed boolean:
```tsx
const hasHtgContent = (htgContent?.length ?? 0) > 0;
```

e. Add an "HTG Guide" tab trigger in the TabsList (after the "Installation" tab trigger but before the "Warnings" tab trigger):
```tsx
{hasHtgContent && (
  <TabsTrigger
    value="htg"
    className="data-[state=active]:border-b-2 data-[state=active]:border-primary rounded-none bg-transparent px-4 py-2"
  >
    <BookOpen className="h-4 w-4 mr-2" />
    HTG Guide
    <Badge variant="secondary" className="ml-2 text-xs">
      {htgContent!.length}
    </Badge>
  </TabsTrigger>
)}
```

f. Add the HTG TabsContent (after the Installation TabsContent but before Warnings TabsContent):
```tsx
{hasHtgContent && htgContent && (
  <TabsContent value="htg" className="mt-6">
    <HtgDetailPanel items={htgContent} />
  </TabsContent>
)}
```

g. Add `BookOpen` to the lucide-react imports if not already there (it IS already imported — verify and don't duplicate).

**Important:** Do NOT change the existing tab ordering logic or other tab behavior. Only ADD the new HTG tab and its content panel. The BookOpen icon is already imported in DetailViewer.tsx — do not add a duplicate import.
  </action>
  <verify>
Verify: (1) `components/details/HtgDetailPanel.tsx` exists and exports `HtgDetailPanel`. (2) `components/details/DetailViewer.tsx` imports `HtgDetailPanel` and renders an "HTG Guide" tab conditionally. (3) TypeScript compilation: `npx tsc --noEmit components/details/HtgDetailPanel.tsx components/details/DetailViewer.tsx` succeeds (or run full project type check). (4) The HTG tab only appears when `htgContent` prop has items.
  </verify>
  <done>
HtgDetailPanel component created with collapsible guide sections, page cards with content excerpts, COP Reader deep-links, and relevance badges. DetailViewer updated with conditional "HTG Guide" tab that renders HtgDetailPanel when htgContent prop is provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire getHtgForDetail into planner and fixer detail pages</name>
  <files>
    app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
    app/(dashboard)/fixer/[detailId]/page.tsx
  </files>
  <action>
1. **Update planner detail page** (`app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx`):

a. Add import at top:
```tsx
import { getHtgForDetail } from '@/lib/db/queries/htg-detail';
```

b. Add `getHtgForDetail(detailId)` to the initial parallel Promise.all:
```tsx
const [detail, detailWithLinks, htgContent] = await Promise.all([
  getDetailById(detailId),
  getDetailWithLinks(detailId),
  getHtgForDetail(detailId),
]);
```

c. Pass `htgContent` prop to `<DetailViewer>`:
```tsx
<DetailViewer
  detail={detailWithRelations}
  stageMetadata={stageMetadata}
  copExcerpts={copExcerpts}
  htgContent={htgContent}
  showBreadcrumb={false}
/>
```

2. **Update fixer detail page** (`app/(dashboard)/fixer/[detailId]/page.tsx`):

a. Add import at top:
```tsx
import { getHtgForDetail } from '@/lib/db/queries/htg-detail';
```

b. Add `getHtgForDetail(detailId)` to the initial parallel Promise.all:
```tsx
const [detail, detailWithLinks, htgContent] = await Promise.all([
  getDetailById(detailId),
  getDetailWithLinks(detailId),
  getHtgForDetail(detailId),
]);
```

c. Pass `htgContent` prop to `<DetailViewer>`:
```tsx
<DetailViewer
  detail={detailWithRelations}
  stageMetadata={stageMetadata}
  copExcerpts={copExcerpts}
  htgContent={htgContent}
  showBreadcrumb={false}
/>
```

**Important notes:**
- The `getHtgForDetail` call is added to the EXISTING Promise.all (not a separate await) to keep data loading parallel.
- The prop name is `htgContent` matching the interface added to DetailViewer in Task 1.
- No other changes to these files — just add the import, the query call, and the prop.
  </action>
  <verify>
Verify: (1) Both detail pages import `getHtgForDetail`. (2) Both detail pages include `getHtgForDetail(detailId)` in their Promise.all. (3) Both pass `htgContent` prop to `<DetailViewer>`. (4) TypeScript compilation passes for both pages. (5) Run `npm run build` (or `npx next build`) to verify no build errors — if build takes too long, just verify with `npx tsc --noEmit` instead.
  </verify>
  <done>
Both planner and fixer detail pages query getHtgForDetail in parallel with existing data loads and pass htgContent to DetailViewer. Detail pages with HTG mappings now display an "HTG Guide" tab with relevant installation guidance from RANZ How-To Guides.
  </done>
</task>

</tasks>

<verification>
1. Navigate to a flashing detail page (e.g., F07) — "HTG Guide" tab should appear with flashings guide content
2. Navigate to a penetrations detail page (e.g., P10) — "HTG Guide" tab should appear with penetrations guide content
3. Navigate to a drainage detail page (e.g., D01) — "HTG Guide" tab should NOT appear (no HTG mapping for drainage)
4. HTG page cards show "View in COP Reader" link that navigates to the correct COP chapter
5. HTG content on detail pages shows content excerpts with relevance badges
6. Tab only appears when HTG mappings exist for the detail
</verification>

<success_criteria>
- Detail pages with HTG mappings display an "HTG Guide" tab (HTG-02)
- HTG tab content includes COP Reader deep-links for broader context (HTG-03)
- Roofer viewing any flashing, penetration, or junction detail sees relevant HTG guidance (HTG-01 + HTG-02)
- No regression to existing tabs (Overview, Images, Installation, Warnings, Related, References)
</success_criteria>

<output>
After completion, create `.planning/phases/22-htg-detail-level-mapping/22-02-SUMMARY.md`
</output>
