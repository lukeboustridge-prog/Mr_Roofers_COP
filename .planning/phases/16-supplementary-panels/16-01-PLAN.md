---
phase: 16-supplementary-panels
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/ui/collapsible.tsx
  - types/cop.ts
  - components/cop/SupplementaryPanel.tsx
  - components/cop/SupplementaryDetailCard.tsx
  - lib/db/queries/supplementary.ts
  - app/(dashboard)/cop/[chapterNumber]/page.tsx
  - components/cop/ChapterContent.tsx
  - components/cop/SectionRenderer.tsx
autonomous: true

must_haves:
  truths:
    - "When a COP section has linked supplementary content, a collapsible panel appears within that section collapsed by default"
    - "User can expand a supplementary panel to see linked detail cards with name, description, source badge, and 3D model indicator"
    - "Supplementary panels are visually distinct from authoritative MRM content (grey border, Supplementary label)"
    - "Sections with no linked supplementary content show no panel (graceful empty state)"
    - "Page loads without errors even when cop_section_details and cop_section_htg tables are empty"
  artifacts:
    - path: "components/ui/collapsible.tsx"
      provides: "shadcn/ui Collapsible primitive (Radix)"
    - path: "types/cop.ts"
      provides: "SupplementaryData and SupplementaryDetail interfaces"
      contains: "SupplementaryData"
    - path: "components/cop/SupplementaryPanel.tsx"
      provides: "Collapsible panel wrapper with grey border and Supplementary label"
      contains: "SupplementaryPanel"
    - path: "components/cop/SupplementaryDetailCard.tsx"
      provides: "Detail card rendering inside supplementary panels"
      contains: "SupplementaryDetailCard"
    - path: "lib/db/queries/supplementary.ts"
      provides: "getSupplementaryContent query function"
      exports: ["getSupplementaryContent"]
    - path: "app/(dashboard)/cop/[chapterNumber]/page.tsx"
      provides: "Server-side supplementary data fetching passed to ChapterContent"
    - path: "components/cop/ChapterContent.tsx"
      provides: "Passes supplementary data Map to SectionRenderer"
    - path: "components/cop/SectionRenderer.tsx"
      provides: "Renders SupplementaryPanel after section content when data exists"
  key_links:
    - from: "app/(dashboard)/cop/[chapterNumber]/page.tsx"
      to: "lib/db/queries/supplementary.ts"
      via: "getSupplementaryContent(chapterNum)"
      pattern: "getSupplementaryContent"
    - from: "app/(dashboard)/cop/[chapterNumber]/page.tsx"
      to: "components/cop/ChapterContent.tsx"
      via: "supplementaryContent prop"
      pattern: "supplementaryContent="
    - from: "components/cop/ChapterContent.tsx"
      to: "components/cop/SectionRenderer.tsx"
      via: "supplementaryContent prop passthrough"
      pattern: "supplementaryContent="
    - from: "components/cop/SectionRenderer.tsx"
      to: "components/cop/SupplementaryPanel.tsx"
      via: "conditional render when supplements exist"
      pattern: "SupplementaryPanel"
---

<objective>
Add inline collapsible supplementary panels to COP section content. When a COP section has linked details (installation guides, 3D models) or HTG guides in the database, a collapsed grey-bordered panel appears below the section content. Users expand panels to see detail cards with source badges and 3D model indicators.

Purpose: Surfaces supplementary RANZ content (3D models, HTG guides, failure cases) directly within the COP reading flow, visually distinct from authoritative MRM content.
Output: SupplementaryPanel component, database query for linked content, full data pipeline from Server Component page through ChapterContent to SectionRenderer.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-supplementary-panels/16-RESEARCH.md

Key source files:
@components/cop/SectionRenderer.tsx
@components/cop/ChapterContent.tsx
@app/(dashboard)/cop/[chapterNumber]/page.tsx
@types/cop.ts
@lib/db/schema.ts
@lib/db/index.ts
@components/authority/SupplementaryContent.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Collapsible and create panel components</name>
  <files>
    components/ui/collapsible.tsx
    types/cop.ts
    components/cop/SupplementaryPanel.tsx
    components/cop/SupplementaryDetailCard.tsx
  </files>
  <action>
1. Install the shadcn/ui Collapsible component:
   ```
   npx shadcn@latest add collapsible
   ```
   This creates `components/ui/collapsible.tsx` with Radix Collapsible primitives.

2. Add supplementary data types to `types/cop.ts` (append, do not modify existing types):
   ```typescript
   // Supplementary content linked to COP sections via cop_section_details / cop_section_htg
   export interface SupplementaryDetail {
     id: string;
     code: string;
     name: string;
     description: string | null;
     modelUrl: string | null;
     thumbnailUrl: string | null;
     sourceName: string;           // e.g. 'MRM' or 'RANZ'
     relationshipType: string;     // 'referenced', 'illustrates', 'alternative'
   }

   export interface SupplementaryHtg {
     id: string;
     guideName: string;
     sourceDocument: string;
     relevance: string | null;
   }

   export interface SupplementaryData {
     details: SupplementaryDetail[];
     htgGuides: SupplementaryHtg[];
   }
   ```

3. Create `components/cop/SupplementaryPanel.tsx`:
   - Uses shadcn/ui Collapsible (NOT Accordion -- independent panel state)
   - Wraps content in the existing `SupplementaryContent` component from `@/components/authority` for the grey border (`border-l-4 border-slate-300 bg-slate-50`)
   - Shows "Supplementary" label + panel title in the trigger
   - ChevronDown icon that rotates 180deg when open
   - `defaultOpen={false}` (collapsed by default per SUPP-01)
   - Uses `useState` for open state (this component runs inside ChapterContent's client boundary)
   - Import icons from `lucide-react`: `ChevronDown`, `Info`

   Component signature:
   ```typescript
   interface SupplementaryPanelProps {
     title: string;
     children: React.ReactNode;
   }
   ```

   The trigger should use `flex w-full items-center justify-between gap-2 py-3 px-4 hover:bg-slate-100/50 transition-colors rounded-t-lg cursor-pointer`. Override the SupplementaryContent padding to `p-0` so the trigger handles its own padding, and CollapsibleContent uses `px-4 pb-4`.

4. Create `components/cop/SupplementaryDetailCard.tsx`:
   - Renders a linked detail as a compact card
   - Shows: detail code as small badge, detail name as title, description (2-line clamp), 3D model indicator badge if `modelUrl` exists
   - Links to `/detail/{id}` for full detail page
   - Uses existing components: `Badge` from `@/components/ui/badge`, `SourceBadge` from `@/components/authority` (with `authority="supplementary"` and `size="sm"`)
   - Import `Box`, `ArrowRight` from `lucide-react`
   - Follow the card pattern from `components/details/RelatedContentTab.tsx` but simplified (no Card wrapper, just a bordered div with hover state)

   Component signature:
   ```typescript
   interface SupplementaryDetailCardProps {
     detail: SupplementaryDetail;  // from types/cop.ts
   }
   ```
  </action>
  <verify>
    - `components/ui/collapsible.tsx` exists (shadcn install succeeded)
    - `npx tsc --noEmit` passes (types compile)
    - SupplementaryPanel and SupplementaryDetailCard export their components
  </verify>
  <done>
    - Collapsible UI primitive installed
    - SupplementaryData types defined in types/cop.ts
    - SupplementaryPanel renders collapsible grey-bordered panel with "Supplementary" label
    - SupplementaryDetailCard renders detail info with source badge and 3D model indicator
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire supplementary data from database through to SectionRenderer</name>
  <files>
    lib/db/queries/supplementary.ts
    app/(dashboard)/cop/[chapterNumber]/page.tsx
    components/cop/ChapterContent.tsx
    components/cop/SectionRenderer.tsx
  </files>
  <action>
1. Create `lib/db/queries/supplementary.ts`:
   - Export `getSupplementaryContent(chapterNumber: number): Promise<Map<string, SupplementaryData>>`
   - Query `cop_section_details` joined with `details` and `contentSources`, filtered by `copSections.chapterNumber`
   - Query `cop_section_htg` joined with `htgContent`, filtered by `copSections.chapterNumber`
   - Group results into a Map keyed by section ID (e.g., `"cop-8.5.4"`)
   - Use Drizzle ORM joins (import `db` from `@/lib/db`, schema tables from `@/lib/db/schema`, `eq` and `inArray` from `drizzle-orm`)
   - The query must join through `copSections` to filter by `chapterNumber`:
     ```
     copSectionDetails -> copSections (on sectionId = copSections.id, where chapterNumber = N)
     copSectionDetails -> details (on detailId = details.id)
     details -> contentSources (on sourceId = contentSources.id) for sourceName
     ```
   - Return empty Map when no rows found (graceful empty state)
   - This is a server-only module (runs in page.tsx Server Component)

2. Modify `app/(dashboard)/cop/[chapterNumber]/page.tsx`:
   - Import `getSupplementaryContent` from `@/lib/db/queries/supplementary`
   - After loading `chapterData` from JSON (line 52), call `const supplementaryContent = await getSupplementaryContent(chapterNum);`
   - Pass `supplementaryContent` to `ChapterContent`:
     ```tsx
     <ChapterContent chapterData={chapterData} supplementaryContent={supplementaryContent} />
     ```
   - IMPORTANT: The Map must be serialized for the client boundary. Convert to a plain object before passing:
     ```typescript
     const supplementaryMap = await getSupplementaryContent(chapterNum);
     const supplementaryJson = Object.fromEntries(supplementaryMap);
     ```
     Then pass `supplementaryContent={supplementaryJson}` as `Record<string, SupplementaryData>`.

3. Modify `components/cop/ChapterContent.tsx`:
   - Add to ChapterContentProps:
     ```typescript
     supplementaryContent?: Record<string, SupplementaryData>;
     ```
   - Import `SupplementaryData` from `@/types/cop`
   - Pass `supplementaryContent` to each `SectionRenderer`:
     ```tsx
     <SectionRenderer
       key={section.number}
       section={section}
       chapterNumber={chapterData.chapterNumber}
       supplementaryContent={supplementaryContent}
     />
     ```

4. Modify `components/cop/SectionRenderer.tsx`:
   - Add to SectionRendererProps:
     ```typescript
     supplementaryContent?: Record<string, SupplementaryData>;
     ```
   - Import `SupplementaryData` from `@/types/cop`
   - Import `SupplementaryPanel` from `./SupplementaryPanel`
   - Import `SupplementaryDetailCard` from `./SupplementaryDetailCard`
   - After content and images rendering, before subsections rendering, add supplementary panel logic:
     ```typescript
     const sectionId = `cop-${section.number}`;
     const supplements = supplementaryContent?.[sectionId];
     ```
   - Render detail panel if `supplements?.details?.length > 0`:
     ```tsx
     <SupplementaryPanel title="Related Installation Details">
       <div className="space-y-3">
         {supplements.details.map(detail => (
           <SupplementaryDetailCard key={detail.id} detail={detail} />
         ))}
       </div>
     </SupplementaryPanel>
     ```
   - Render HTG panel if `supplements?.htgGuides?.length > 0`:
     ```tsx
     <SupplementaryPanel title="Related HTG Guides">
       <div className="space-y-2">
         {supplements.htgGuides.map(htg => (
           <div key={htg.id} className="text-sm text-slate-600">
             <span className="font-medium">{htg.guideName}</span>
             <span className="text-slate-400 ml-2">({htg.sourceDocument})</span>
           </div>
         ))}
       </div>
     </SupplementaryPanel>
     ```
   - Pass `supplementaryContent` through to recursive subsection renders:
     ```tsx
     <SectionRenderer
       key={subsection.number}
       section={subsection}
       chapterNumber={chapterNumber}
       supplementaryContent={supplementaryContent}
     />
     ```
  </action>
  <verify>
    - `npx tsc --noEmit` passes (full type check across modified files)
    - `npm run build` succeeds (no server/client boundary errors)
    - Visit `/cop/8` in browser -- page loads without errors (supplementary data is empty, no panels shown)
    - Check browser console for no runtime errors
  </verify>
  <done>
    - Database query fetches all supplementary content for a chapter in 2 queries (details + HTG), no N+1
    - Server Component page.tsx queries supplementary data and passes serialized Map to client
    - ChapterContent passes supplementary data through to SectionRenderer
    - SectionRenderer conditionally renders SupplementaryPanel when linked data exists for that section
    - Empty tables produce empty Map, no panels rendered, no errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- all types compile cleanly
2. `npm run build` -- no build errors, server/client boundary respected
3. Visit `/cop/8` (or any chapter) -- page renders without errors, no supplementary panels visible (tables are empty)
4. Inspect SectionRenderer output -- no empty panel containers or broken UI when supplementary data is absent
5. Check database query count: should be exactly 2 queries per chapter page (one for details, one for HTG) even when tables are empty
</verification>

<success_criteria>
- SUPP-01: Collapsible panel infrastructure exists and renders when data is present (collapsed by default)
- SUPP-02: Panels use SupplementaryContent wrapper (grey border-l-4 border-slate-300 bg-slate-50) with "Supplementary" label
- Zero visual regression on existing COP reader pages (no panels appear when tables are empty)
- Full data pipeline: page.tsx -> ChapterContent -> SectionRenderer -> SupplementaryPanel works end-to-end
- TypeScript compiles, build succeeds, no console errors at runtime
</success_criteria>

<output>
After completion, create `.planning/phases/16-supplementary-panels/16-01-SUMMARY.md`
</output>
