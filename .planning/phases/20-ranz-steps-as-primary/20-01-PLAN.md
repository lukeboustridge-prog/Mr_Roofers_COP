---
phase: 20-ranz-steps-as-primary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - "lib/stage-metadata.ts"
  - "app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx"
  - "app/(dashboard)/fixer/[detailId]/page.tsx"
  - "components/details/DetailViewer.tsx"
autonomous: true
must_haves:
  truths:
    - "MRM detail page with RANZ link shows RANZ installation steps as primary step content (not in supplementary panel)"
    - "MRM section-ref steps (e.g. '5.1', '4.7 Gutter Capacity Calculator') are hidden when RANZ steps are primary"
    - "3D viewer stage navigation works on MRM detail pages that borrow RANZ 3D models and steps"
    - "RANZ step labels display as numbered installation steps with instruction text"
  artifacts:
    - path: "lib/stage-metadata.ts"
      provides: "Stage metadata resolution through linked RANZ guides"
      contains: "getStageMetadataForLinkedGuide"
    - path: "components/details/DetailViewer.tsx"
      provides: "RANZ step promotion logic and MRM step suppression"
      contains: "isRanzStepsPrimary"
  key_links:
    - from: "app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx"
      to: "lib/stage-metadata.ts"
      via: "getStageMetadataForLinkedGuide resolves RANZ metadata for MRM details"
      pattern: "getStageMetadataForLinkedGuide"
    - from: "components/details/DetailViewer.tsx"
      to: "detail.supplements"
      via: "Checks linked RANZ guide steps to determine primary step source"
      pattern: "isRanzStepsPrimary"
---

<objective>
Promote RANZ installation steps from supplementary borrowed content to primary step display on all 61 MRM-matched detail pages, and enable 3D step synchronization through linked guides.

Purpose: MRM details currently show section-reference "steps" (e.g. "5.1", "5.1A Ridge-Hip Junction") which are NOT actionable installation instructions. RANZ guides have real procedures (840 labelled steps). This plan makes RANZ steps the primary content and resolves 3D sync metadata through detail links.

Output: DetailViewer displays RANZ steps as primary on MRM pages with RANZ links; stage metadata resolves through linked guides for 3D sync.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@lib/stage-metadata.ts
@lib/db/queries/detail-links.ts
@components/details/DetailViewer.tsx
@components/details/StepByStep.tsx
@components/details/Model3DViewer.tsx
@app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
@app/(dashboard)/fixer/[detailId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add linked-guide stage metadata resolution and promote RANZ steps as primary</name>
  <files>
    lib/stage-metadata.ts
    app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx
    app/(dashboard)/fixer/[detailId]/page.tsx
    components/details/DetailViewer.tsx
  </files>
  <action>
**Part A: Stage metadata resolution through linked guides (lib/stage-metadata.ts)**

Add a new function `getStageMetadataForLinkedGuide(detailId: string, supplements?: Array<{ id: string; modelUrl: string | null }>): DetailStageMetadata | null` that:

1. First tries `getStageMetadata(detailId)` — returns if found (RANZ detail viewing own page)
2. If null AND supplements array provided, iterates through supplements to find the first linked guide that has stage metadata: `getStageMetadata(supplement.id)`. Returns that metadata if found.
3. Returns null if nothing found.

This function is synchronous (stage_metadata.json is file-read cached). The supplements parameter comes from `getDetailWithLinks()` which is already fetched in the page components.

**Part B: Page-level stage metadata resolution (both page.tsx files)**

In `app/(dashboard)/planner/[substrate]/[category]/[detailId]/page.tsx`:
- Import the new `getStageMetadataForLinkedGuide` function
- Change line 36 from `const stageMetadata = getStageMetadata(detail.id);` to:
  ```
  const stageMetadata = getStageMetadataForLinkedGuide(
    detail.id,
    detailWithLinks?.supplements?.map(s => ({ id: s.id, modelUrl: s.modelUrl }))
  );
  ```
- This enables 3D step sync on MRM pages that borrow RANZ 3D models

Apply the exact same change in `app/(dashboard)/fixer/[detailId]/page.tsx` (same pattern at line 36).

**Part C: RANZ step promotion in DetailViewer (components/details/DetailViewer.tsx)**

The current logic at lines 190-197 already borrows RANZ steps when MRM has no own steps:
```ts
const displaySteps = (detail.steps?.length ?? 0) > 0
  ? detail.steps
  : linkedGuideWithSteps?.steps || [];
const areStepsBorrowed = (detail.steps?.length ?? 0) === 0 && (linkedGuideWithSteps?.steps?.length ?? 0) > 0;
```

But MRM details DO have their own steps (section-ref steps like "5.1"). So the current logic shows MRM section-ref steps as primary and RANZ steps never appear as primary.

**Change the priority logic to:**

1. Add a helper function `isSectionRefStep(instruction: string): boolean` that detects MRM section-reference steps. These are steps where the instruction is just a section number like "5.1", "5.1A", "1", "4.7 Gutter Capacity Calculator", "ROOF DRAINAGE", etc. Heuristic: instruction matches `/^\d+(\.\d+)*[A-Z]?(\s|$)/` OR instruction.length < 40 AND does NOT contain common installation verbs (fit, fix, install, apply, cut, measure, position, secure, seal, fold, bend, mark, drill, fasten, attach, place, remove, trim, overlap, align).

2. Determine if RANZ steps should be primary:
```ts
// Check if detail's own steps are MRM section-refs (not real installation instructions)
const ownStepsAreSectionRefs = (detail.steps?.length ?? 0) > 0 &&
  detail.steps!.every(s => isSectionRefStep(s.instruction));

// RANZ steps are primary when: detail has linked RANZ guide with steps AND
// either detail has no own steps OR own steps are section-refs
const isRanzStepsPrimary = (linkedGuideWithSteps?.steps?.length ?? 0) > 0 &&
  ((detail.steps?.length ?? 0) === 0 || ownStepsAreSectionRefs);

// Determine display steps
const displaySteps = isRanzStepsPrimary
  ? linkedGuideWithSteps?.steps || []
  : (detail.steps?.length ?? 0) > 0
    ? detail.steps
    : linkedGuideWithSteps?.steps || [];

const areStepsBorrowed = isRanzStepsPrimary;
```

3. The `areStepsBorrowed` flag already controls the "Installation steps provided by linked installation guide" attribution banner (lines 638-648). This is correct — we want to show attribution even when RANZ steps are primary.

4. The `steps` mapping at line 308 already transforms display steps for StepByStep. No change needed there.

5. MRM section-ref steps are simply not shown — they're replaced by RANZ steps. Phase 21 will handle MRM-only details (no RANZ link) separately with COP excerpt fallback.

**Important: Do NOT change the tab visibility logic.** The Installation tab already shows conditionally based on `steps.length > 0`. Since we're replacing the step source (not removing steps), the tab will still appear.

**Important: The 3D step sync behavior is preserved** because:
- `stageMetadata` is now resolved through linked guides (Part B)
- `hasStepSync` check at line 161 will correctly detect stages from the linked RANZ guide
- `activeStep` state and `handleStepChange` callbacks work identically
- The Model3DViewer already uses the borrowed model URL (`display3DModelUrl` at line 187)
  </action>
  <verify>
1. `npx tsc --noEmit` passes — no TypeScript errors
2. `npm run build` succeeds — no build errors
3. Read `lib/stage-metadata.ts` and confirm `getStageMetadataForLinkedGuide` exists
4. Read `components/details/DetailViewer.tsx` and confirm `isSectionRefStep` helper and `isRanzStepsPrimary` logic exist
5. Read both page.tsx files and confirm they use `getStageMetadataForLinkedGuide`
  </verify>
  <done>
- MRM detail pages with RANZ links show RANZ installation steps as primary content (not section-refs)
- Stage metadata resolves through linked RANZ guides for 3D sync on MRM pages
- MRM section-ref steps are suppressed when RANZ steps are available
- TypeScript compiles and Next.js builds successfully
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` — no errors
2. Build check: `npm run build` — succeeds
3. Code review: `isSectionRefStep` correctly identifies MRM section-ref patterns
4. Code review: `getStageMetadataForLinkedGuide` falls through to linked guide metadata
5. Code review: Both planner and fixer page routes use the new resolution function
</verification>

<success_criteria>
- RANZ installation steps display as primary step content on MRM detail pages with RANZ links
- MRM section-reference steps (e.g. "5.1", "5.1A") are hidden when RANZ steps are primary
- 3D viewer stage navigation synchronizes correctly when viewing MRM details with linked RANZ 3D models
- RANZ step labels with instruction text display as numbered installation steps
- No regression: RANZ-native detail pages continue working as before
- No regression: MRM-only details (no RANZ link) continue showing their own steps
</success_criteria>

<output>
After completion, create `.planning/phases/20-ranz-steps-as-primary/20-01-SUMMARY.md`
</output>
