---
phase: 23-3d-viewer-verification-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/verify-v3d-colors.ts
  - components/details/Model3DViewer.tsx
autonomous: true

must_haves:
  truths:
    - "V3D color extraction parses S8S_v3d_material_data from all 61 GLB models without errors"
    - "Every GLB model has at least one material with V3D color data extracted"
    - "Stage transitions (ghost at 0.25 opacity / highlight at 1.0) apply correctly with V3D-colored materials"
    - "Models with transparent V3D materials (opacity < 1.0) ghost correctly without z-fighting"
  artifacts:
    - path: "scripts/verify-v3d-colors.ts"
      provides: "Automated V3D color extraction verification across all 61 GLBs"
    - path: "components/details/Model3DViewer.tsx"
      provides: "Polished 3D viewer with robust V3D color extraction and ghost/highlight"
  key_links:
    - from: "scripts/verify-v3d-colors.ts"
      to: "public/models/*.glb"
      via: "Node.js GLTF parser reads each GLB and validates S8S_v3d_material_data"
      pattern: "S8S_v3d_material_data"
    - from: "components/details/Model3DViewer.tsx"
      to: "ranz_extract/stage_metadata.json"
      via: "Stage actions drive cumulative layer visibility and ghost/highlight"
      pattern: "parseLayerAction.*reveal"
---

<objective>
Verify V3D color extraction works across all 61 GLB models and harden ghost/highlight stage transitions.

Purpose: The V3D color extraction (`extractV3DColors` + `applyV3DColor`) was implemented earlier today but only tested on a few models. This plan creates an automated verification script that parses all 61 GLBs to confirm every model has valid V3D material data, then fixes any edge cases found in the ghost/highlight transparency system.

Output: Verification script with pass/fail report for all 61 models, and any fixes needed in Model3DViewer.tsx for edge cases.
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@components/details/Model3DViewer.tsx
@ranz_extract/model_mapping.json
@ranz_extract/stage_metadata.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create V3D color extraction verification script</name>
  <files>scripts/verify-v3d-colors.ts</files>
  <action>
Create a Node.js verification script at `scripts/verify-v3d-colors.ts` that:

1. Uses `@gltf-transform/core` (already in node_modules or install if needed) OR raw Buffer parsing to read each of the 61 GLB files from `public/models/`.

2. For each GLB file, extracts the GLTF JSON chunk (the first chunk in a GLB binary) and parses it to find `extensions.S8S_v3d_material_data` on each material.

3. Mirrors the same extraction logic as `extractV3DColors()` in Model3DViewer.tsx:
   - Find materials array in GLTF JSON
   - Skip materials named "Verge3D_Environment"
   - Look for `extensions.S8S_v3d_material_data.nodeGraph.nodes` array
   - Find node with `type === 'MATERIAL_MX'`
   - Check `inputs[1]` for [r,g,b,a] color array
   - Check `inputs[6]` for opacity value

4. Produces a report table with columns: Model File | Materials | V3D Colors Found | Missing Colors | Status (PASS/FAIL)

5. A model PASSES if it has at least 1 material with valid V3D color data.

6. Reports overall summary: X/61 passed, Y/61 failed.

Implementation notes:
- GLB format: 12-byte header (magic + version + length), then chunks. First chunk is JSON (type 0x4E4F534A).
- Read the GLB binary, extract JSON chunk, parse it, iterate materials.
- Use `fs.readdirSync('public/models')` to find all `.glb` files.
- Run with `npx tsx scripts/verify-v3d-colors.ts`.
- Do NOT import three.js or any browser APIs — this is pure Node.js file parsing.

Edge cases to detect and report:
- Materials with no `S8S_v3d_material_data` extension (report name)
- Materials where MATERIAL_MX node has fewer than 7 inputs
- Materials with opacity < 1.0 (flag as "transparent" — these interact with ghost effect)
- Models with no materials at all
  </action>
  <verify>
Run `npx tsx scripts/verify-v3d-colors.ts` and confirm:
1. Script completes without errors
2. All 61 models are processed
3. Report shows pass/fail for each model
4. Summary shows 61/61 passed (or identifies specific failures)
  </verify>
  <done>Verification script exists, runs successfully, and reports V3D color extraction status for all 61 GLB models. Zero failures expected — if any fail, Task 2 fixes them.</done>
</task>

<task type="auto">
  <name>Task 2: Harden ghost/highlight transparency for V3D-colored materials</name>
  <files>components/details/Model3DViewer.tsx</files>
  <action>
Review and harden the ghost/highlight transparency system in Model3DViewer.tsx based on verification results. Specific areas to audit and fix:

**A. Ghost opacity interaction with V3D transparent materials:**
The current code in the stage transition effect (line ~284-378) has two passes: ghost ALL visible meshes to 0.25 opacity, then highlight current stage's revealed components at 1.0. But if a V3D material already has opacity < 1.0 (set by `applyV3DColor`), ghosting it to 0.25 may look wrong. Fix:
- When ghosting a V3D-transparent material, use `min(original_opacity * 0.3, 0.25)` so already-transparent materials ghost to proportionally lower opacity.
- When restoring highlight on a V3D-transparent material, restore to its V3D opacity (from `originalOpacityMap`), NOT 1.0.

**B. depthWrite handling for ghost state:**
Current code sets `mat.depthWrite = opacity > 0.1`. This is correct but verify it handles the restore path — when a material goes from ghost (0.25) back to highlight (1.0), depthWrite must be set back to true. Check the `setMeshOpacity` function at line ~289 handles all three states:
- Ghost: opacity=0.25, transparent=true, depthWrite=true (0.25 > 0.1)
- Highlight: opacity=1.0, transparent=false, depthWrite=true
- Hidden: opacity=0 or visibility=false

**C. Ensure "transp" layers stay hidden during all stage transitions:**
Line ~317 hides layers with "transp" in the name. Verify this runs BEFORE the ghost/highlight passes so transp layers never get ghosted (which would make them visible as very faint).

**D. Material needsUpdate flag:**
Ensure `mat.needsUpdate = true` is set every time material properties change (opacity, transparent, depthWrite). This is already done in `setMeshOpacity` but verify no code path misses it.

After fixes, run the dev server and visually test at least one model (grf101.glb / F01) to confirm:
- Stage 1 (overview): all components visible, fully opaque
- Stage 2+: previous components ghosted, current highlighted
- No z-fighting or visual glitches on transparent parts
  </action>
  <verify>
1. Read Model3DViewer.tsx and confirm ghost/highlight logic handles V3D opacity correctly
2. Run `npx next lint` — no new lint errors
3. Run `npx tsc --noEmit` — no type errors
  </verify>
  <done>Ghost/highlight transparency correctly handles V3D-colored materials including those with original transparency. No z-fighting. depthWrite properly managed. "transp" layers stay hidden during all states.</done>
</task>

</tasks>

<verification>
1. `npx tsx scripts/verify-v3d-colors.ts` reports 61/61 models passed
2. `npx tsc --noEmit` has no type errors
3. `npx next lint` has no new errors
4. Model3DViewer.tsx ghost/highlight logic properly handles V3D opacity < 1.0 materials
</verification>

<success_criteria>
- All 61 GLB models have valid V3D color data extractable by the same logic used in Model3DViewer.tsx
- Ghost/highlight transparency handles edge cases (transparent V3D materials, depthWrite restoration)
- No regressions in existing 3D viewer functionality
</success_criteria>

<output>
After completion, create `.planning/phases/23-3d-viewer-verification-polish/23-01-SUMMARY.md`
</output>
