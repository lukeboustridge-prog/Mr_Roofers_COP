---
phase: 23-3d-viewer-verification-polish
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - components/details/Model3DViewer.tsx
autonomous: false

must_haves:
  truths:
    - "Black background renders on all 61 RANZ detail pages (no white/grey flash)"
    - "Lighting shows V3D material colors clearly against black background"
    - "3D viewer loads without console errors on all 61 detail pages"
    - "Stage transitions visually demonstrate ghost/highlight correctly"
  artifacts:
    - path: "components/details/Model3DViewer.tsx"
      provides: "Production-ready 3D viewer with polished environment"
  key_links:
    - from: "components/details/Model3DViewer.tsx"
      to: "Canvas scene.background"
      via: "onCreated callback sets #000000"
      pattern: "scene.background.*#000000"
---

<objective>
Polish 3D viewer environment (lighting, background, camera) and verify visually across multiple model categories.

Purpose: With V3D color extraction verified (Plan 01) and ghost/highlight hardened, this plan ensures the overall visual presentation — black background, lighting balance, camera defaults — matches the roofguide.co.nz reference app's appearance and loads cleanly across all model types.

Output: Polished Model3DViewer.tsx confirmed working across all 5 model categories (flashings, penetrations-corrugated, penetrations-rib, cladding-horizontal, cladding-vertical).
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@components/details/Model3DViewer.tsx
@.planning/phases/23-3d-viewer-verification-polish/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Polish lighting and environment for black background</name>
  <files>components/details/Model3DViewer.tsx</files>
  <action>
Fine-tune the 3D viewer environment settings in Model3DViewer.tsx for optimal appearance with V3D-colored materials on black background:

**A. Lighting balance audit:**
Current setup (lines ~969-971):
- `ambientLight intensity={0.6}`
- `directionalLight position={[5,5,5]} intensity={1.2} castShadow`
- `directionalLight position={[-3,2,-3]} intensity={0.5}`

The reference app (roofguide.co.nz Verge3D viewer) uses a black world material with environment-based reflections. Our R3F equivalent should:
- Keep ambient at 0.6 (provides base illumination so dark V3D colors are still visible)
- Adjust main directional to intensity={1.0} (1.2 may wash out lighter V3D colors on black bg)
- Keep fill light at 0.5 (prevents hard shadows on back faces)
- The `Environment preset="city"` with `background={false}` provides IBL reflections without showing the environment map — this is correct, keep it

**B. Ensure Canvas gl settings are optimal:**
Current: `gl={{ toneMappingExposure: 1.0 }}`. This is fine. Verify the default tone mapping (ACESFilmic) works well with V3D sRGB colors. If colors appear washed out, try adding `toneMapping={THREE.NoToneMapping}` to the Canvas — V3D colors are already in display space so additional tone mapping may desaturate them.

Test by comparing: with NoToneMapping vs default. If V3D colors look more accurate with NoToneMapping, apply it. If they look too bright/saturated, keep the default ACESFilmic.

**C. Camera defaults:**
- Default position [3,3,3] with FOV 40 is good for viewing roofing details from a 3/4 angle
- `maxPolarAngle={Math.PI / 2}` prevents viewing from below — correct for roofing models
- No changes needed unless testing reveals issues

**D. Remove any stale imports or dead code:**
Check for unused imports (Text from drei is only used in PlaceholderBox — that's fine).

After changes, run dev server and test with `grf101.glb` (Drip Edge Flashing) to confirm:
- Black background, no white flash on load
- V3D colors visible and well-lit (metals look metallic, foams look matte)
- Ghost state (stage 2+) shows ghosted parts as faintly visible, not invisible
- Environment reflections add subtle realism
  </action>
  <verify>
1. `npx tsc --noEmit` — no type errors
2. `npx next lint` — no new lint errors
3. Dev server starts without errors: `npx next dev`
  </verify>
  <done>Lighting, tone mapping, and environment settings optimized for V3D-colored materials on black background. No dead code. TypeScript clean.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of 3D viewer across model categories</name>
  <what-built>
V3D color extraction, ghost/highlight transparency, black background, and lighting polish across all 61 RANZ GLB models. The 3D viewer should now show:
- Correct material colors (metals, foam, cladding, fixings) extracted from V3D data
- Black background matching the reference app
- Ghost/highlight stage transitions working without visual glitches
- No console errors
  </what-built>
  <how-to-verify>
Start the dev server: `npx next dev`

**Spot-check at least 10 models across all 5 categories** (2 per category):

1. **Flashings:** F01 (Drip Edge), F09 (Apron to Side Apron)
   - Navigate to the detail page for each
   - Verify 3D model loads with colored materials (not all grey/white)
   - Click through stages (Overview -> Step 1 -> Step 2 -> ...)
   - Confirm ghost/highlight works (previous parts fade, new parts highlighted)

2. **Penetrations Corrugated:** C01 (Round Directly Fixed), C07 (Rectangular Overflashing with Cricket)
   - Same checks: colors, stage transitions, no glitches

3. **Penetrations Rib:** R01 (Round Directly Fixed), R10 (Rectangular Undersoaker with Cricket)
   - Same checks

4. **Cladding Horizontal:** H01 (External Corner), H07 (Window)
   - Same checks

5. **Cladding Vertical:** V01 (External Corner), V07 (Window)
   - Same checks

**For each model, verify:**
- [ ] Model loads (spinning cube loading indicator disappears)
- [ ] Background is black
- [ ] Materials have distinct colors (not all grey/white)
- [ ] Stage overview shows all components opaque
- [ ] Stage 2+ shows ghost/highlight (faded vs solid)
- [ ] No console errors (open browser DevTools Console)
- [ ] Step bar navigation works (clicking numbered buttons changes stage)

**Overall check:**
- [ ] Black background consistent across all models
- [ ] Lighting looks natural (not too bright, not too dark)
- [ ] No white flash on initial load
  </how-to-verify>
  <resume-signal>Type "approved" if 10+ models pass visual check, or describe specific issues found</resume-signal>
</task>

</tasks>

<verification>
1. Visual spot-check of 10+ models across all 5 categories passes
2. No console errors on any tested detail page
3. Ghost/highlight transitions work correctly on all tested models
4. Black background consistent, lighting appropriate
</verification>

<success_criteria>
- 10+ models visually verified with correct V3D colors, black background, and working stage transitions
- No console errors on any 3D viewer page
- Ghost/highlight transparency works without visual glitches across all model types
- Overall appearance matches reference app quality (black background, clear materials, smooth transitions)
</success_criteria>

<output>
After completion, create `.planning/phases/23-3d-viewer-verification-polish/23-02-SUMMARY.md`
</output>
