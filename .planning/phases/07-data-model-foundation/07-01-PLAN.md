---
phase: 07-data-model-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/schema.ts
  - lib/db/migrations/0002_topics_and_links.sql
autonomous: true

must_haves:
  truths:
    - "Database has topics table for semantic grouping"
    - "Database has category_topics junction table"
    - "Database has detail_links table with authority hierarchy"
    - "Database has legislative_references table with citation fields"
    - "Database has detail_legislative_links junction table"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "Schema definitions for topics, categoryTopics, detailLinks, legislativeReferences, detailLegislativeLinks"
      contains: "export const topics"
    - path: "lib/db/migrations/0002_topics_and_links.sql"
      provides: "SQL migration for new tables"
      contains: "CREATE TABLE"
  key_links:
    - from: "lib/db/schema.ts"
      to: "database tables"
      via: "drizzle-kit generate/push"
      pattern: "pgTable"
---

<objective>
Add schema definitions for cross-source linking infrastructure and semantic topic grouping.

Purpose: Establish database tables required for DATA-01 (cross-source links), DATA-02 (topic grouping), and DATA-03 (legislative references). This is the foundation all other Phase 7 work depends on.

Output: Updated schema.ts with 5 new table definitions, migration SQL file ready to apply.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-model-foundation/07-RESEARCH.md
@lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema definitions for topics, detailLinks, and legislativeReferences</name>
  <files>lib/db/schema.ts</files>
  <action>
Add 5 new table definitions to lib/db/schema.ts after the existing detailCrossReferences table:

1. **topics** table:
   - id: text primaryKey (e.g., 'flashings', 'penetrations')
   - name: text notNull
   - description: text (nullable)
   - iconUrl: text (nullable)
   - sortOrder: integer default 0

2. **categoryTopics** junction table:
   - categoryId: text references categories.id with onDelete: 'cascade'
   - topicId: text references topics.id with onDelete: 'cascade'
   - Primary key on both columns

3. **detailLinks** table for authority hierarchy:
   - id: text primaryKey
   - primaryDetailId: text references details.id with onDelete: 'cascade', notNull
   - supplementaryDetailId: text references details.id with onDelete: 'cascade', notNull
   - linkType: text notNull (values: 'installation_guide', 'technical_supplement', 'alternative')
   - matchConfidence: text nullable (values: 'exact', 'partial', 'related')
   - notes: text nullable
   - createdAt: timestamp defaultNow
   - Indexes on primaryDetailId and supplementaryDetailId
   - Note: CHECK constraint for no self-link added in migration SQL

4. **legislativeReferences** table:
   - id: text primaryKey (e.g., 'e2-as1-table20')
   - code: text notNull (e.g., 'E2/AS1')
   - edition: text nullable (e.g., '4th')
   - amendment: text nullable (e.g., 'Amd 10')
   - clause: text notNull (e.g., 'Table 20')
   - title: text notNull
   - authorityLevel: text notNull ('building_code', 'acceptable_solution', 'verification_method')
   - sourceUrl: text nullable
   - effectiveDate: timestamp nullable
   - supersededBy: text nullable references legislativeReferences.id
   - createdAt: timestamp defaultNow
   - Index on code field

5. **detailLegislativeLinks** junction table:
   - detailId: text references details.id with onDelete: 'cascade', notNull
   - legislativeRefId: text references legislativeReferences.id with onDelete: 'cascade', notNull
   - context: text nullable (values: 'compliance', 'guidance', 'exception')
   - Primary key on both columns

Follow existing schema patterns (use text IDs, consistent naming, proper references). Import `check` from drizzle-orm/pg-core if needed for constraints.
  </action>
  <verify>
Run: `npx tsc --noEmit lib/db/schema.ts` - should compile without errors.
Check that all 5 new exports exist: topics, categoryTopics, detailLinks, legislativeReferences, detailLegislativeLinks.
  </verify>
  <done>
schema.ts contains all 5 new table definitions with proper types, references, and indexes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate migration and apply to database</name>
  <files>lib/db/migrations/0002_topics_and_links.sql</files>
  <action>
1. Run `npm run db:generate` to generate migration from schema changes.

2. If drizzle-kit generates a migration, review it. The migration should create:
   - topics table
   - category_topics table with foreign keys
   - detail_links table with indexes
   - legislative_references table with index
   - detail_legislative_links table

3. If the auto-generated migration is missing the CHECK constraint for no self-links, create a manual migration file at `lib/db/migrations/0002_topics_and_links.sql` with:

```sql
-- Phase 7: Topics, Detail Links, and Legislative References
-- Adds cross-source linking infrastructure (DATA-01, DATA-02, DATA-03)

-- Topics for semantic grouping (DATA-02)
CREATE TABLE IF NOT EXISTS "topics" (
  "id" text PRIMARY KEY,
  "name" text NOT NULL,
  "description" text,
  "icon_url" text,
  "sort_order" integer DEFAULT 0
);

-- Category-to-Topic mapping (many-to-many)
CREATE TABLE IF NOT EXISTS "category_topics" (
  "category_id" text NOT NULL REFERENCES "categories"("id") ON DELETE CASCADE,
  "topic_id" text NOT NULL REFERENCES "topics"("id") ON DELETE CASCADE,
  PRIMARY KEY ("category_id", "topic_id")
);

-- Detail links with authority hierarchy (DATA-01)
CREATE TABLE IF NOT EXISTS "detail_links" (
  "id" text PRIMARY KEY,
  "primary_detail_id" text NOT NULL REFERENCES "details"("id") ON DELETE CASCADE,
  "supplementary_detail_id" text NOT NULL REFERENCES "details"("id") ON DELETE CASCADE,
  "link_type" text NOT NULL,
  "match_confidence" text,
  "notes" text,
  "created_at" timestamp DEFAULT now(),
  CONSTRAINT "no_self_link" CHECK ("primary_detail_id" != "supplementary_detail_id")
);

CREATE INDEX IF NOT EXISTS "idx_detail_links_primary" ON "detail_links" ("primary_detail_id");
CREATE INDEX IF NOT EXISTS "idx_detail_links_supplementary" ON "detail_links" ("supplementary_detail_id");
CREATE UNIQUE INDEX IF NOT EXISTS "idx_detail_links_unique" ON "detail_links" ("primary_detail_id", "supplementary_detail_id");

-- Legislative references normalization (DATA-03)
CREATE TABLE IF NOT EXISTS "legislative_references" (
  "id" text PRIMARY KEY,
  "code" text NOT NULL,
  "edition" text,
  "amendment" text,
  "clause" text NOT NULL,
  "title" text NOT NULL,
  "authority_level" text NOT NULL,
  "source_url" text,
  "effective_date" timestamp,
  "superseded_by" text REFERENCES "legislative_references"("id"),
  "created_at" timestamp DEFAULT now()
);

CREATE INDEX IF NOT EXISTS "idx_leg_refs_code" ON "legislative_references" ("code");

-- Detail-to-LegislativeReference mapping
CREATE TABLE IF NOT EXISTS "detail_legislative_links" (
  "detail_id" text NOT NULL REFERENCES "details"("id") ON DELETE CASCADE,
  "legislative_ref_id" text NOT NULL REFERENCES "legislative_references"("id") ON DELETE CASCADE,
  "context" text,
  PRIMARY KEY ("detail_id", "legislative_ref_id")
);
```

4. Apply migration using `npm run db:push` for development iteration.

5. Verify tables exist by checking Drizzle Studio or running a test query.
  </action>
  <verify>
Run: `npm run db:push` - should complete without errors.
Check that all 5 new tables exist in the database.
Verify indexes were created on detail_links and legislative_references.
  </verify>
  <done>
Migration applied successfully. Database has topics, category_topics, detail_links, legislative_references, and detail_legislative_links tables with proper constraints and indexes.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. TypeScript compiles: `npx tsc --noEmit`
2. Database schema matches: `npm run db:push` reports no changes needed
3. New tables queryable: Can SELECT from topics, category_topics, detail_links
</verification>

<success_criteria>
- lib/db/schema.ts exports 5 new tables: topics, categoryTopics, detailLinks, legislativeReferences, detailLegislativeLinks
- All tables have proper foreign key relationships with cascade delete
- detail_links has CHECK constraint preventing self-links
- Migration can be applied without errors
- Database reflects new schema
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-model-foundation/07-01-SUMMARY.md`
</output>
