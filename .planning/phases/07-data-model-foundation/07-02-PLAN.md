---
phase: 07-data-model-foundation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - scripts/seed-topics.ts
  - lib/db/seed-data/topics.ts
autonomous: true

must_haves:
  truths:
    - "All 6 substrates exist in database"
    - "Topics exist for semantic grouping (flashings, penetrations, junctions, ventilation, general)"
    - "Categories from both MRM and RANZ are mapped to appropriate topics"
    - "Substrate preservation ensured for empty substrates"
  artifacts:
    - path: "scripts/seed-topics.ts"
      provides: "Executable script to populate topics and category mappings"
      contains: "topics"
    - path: "lib/db/seed-data/topics.ts"
      provides: "Topic definitions and category-to-topic mappings"
      exports: ["topics", "categoryTopicMappings"]
  key_links:
    - from: "scripts/seed-topics.ts"
      to: "database topics table"
      via: "db.insert"
      pattern: "insert.*topics"
---

<objective>
Seed topics and map categories to enable unified navigation across MRM and RANZ sources.

Purpose: Implement DATA-02 (semantic topic grouping) and DATA-04 (substrate preservation). Creates the topic hierarchy and links existing categories from both sources to semantic topics, enabling "show all flashings" unified queries.

Output: Seeded topics table with category mappings, verified all 6 substrates exist.
</objective>

<execution_context>
@C:\Users\LukeBoustridge\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\LukeBoustridge\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-data-model-foundation/07-RESEARCH.md
@.planning/phases/07-data-model-foundation/07-01-SUMMARY.md
@lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create topic seed data definitions</name>
  <files>lib/db/seed-data/topics.ts</files>
  <action>
Create a new file `lib/db/seed-data/topics.ts` with topic definitions and category mappings.

Based on research, the existing categories are:
- MRM (5): flashings, penetrations, junctions, general, ventilation
- RANZ (5): flashings-corrugated, penetrations-corrugated, junctions-corrugated, general-corrugated, ventilation-corrugated

Define 5 semantic topics:
```typescript
export const topics = [
  { id: 'flashings', name: 'Flashings', description: 'Ridge, valley, barge, apron, and other flashing details', sortOrder: 1 },
  { id: 'penetrations', name: 'Penetrations', description: 'Pipe, vent, and other roof penetration details', sortOrder: 2 },
  { id: 'junctions', name: 'Junctions', description: 'Wall, gutter, and other junction details', sortOrder: 3 },
  { id: 'ventilation', name: 'Ventilation', description: 'Roof space and underlay ventilation details', sortOrder: 4 },
  { id: 'general', name: 'General', description: 'Fastening, fixing, and general installation details', sortOrder: 5 },
];
```

Define category-to-topic mappings (mapping both MRM and RANZ categories to unified topics):
```typescript
export const categoryTopicMappings = [
  // MRM categories
  { categoryId: 'flashings', topicId: 'flashings' },
  { categoryId: 'penetrations', topicId: 'penetrations' },
  { categoryId: 'junctions', topicId: 'junctions' },
  { categoryId: 'ventilation', topicId: 'ventilation' },
  { categoryId: 'general', topicId: 'general' },
  // RANZ categories (substrate-specific)
  { categoryId: 'flashings-corrugated', topicId: 'flashings' },
  { categoryId: 'penetrations-corrugated', topicId: 'penetrations' },
  { categoryId: 'junctions-corrugated', topicId: 'junctions' },
  { categoryId: 'ventilation-corrugated', topicId: 'ventilation' },
  { categoryId: 'general-corrugated', topicId: 'general' },
];
```

Also define the 6 core substrates for verification/seeding:
```typescript
export const coreSubstrates = [
  { id: 'profiled-metal', name: 'Profiled Metal', sortOrder: 1 },
  { id: 'pressed-metal', name: 'Pressed Metal Tile', sortOrder: 2 },
  { id: 'concrete-tile', name: 'Concrete Tile', sortOrder: 3 },
  { id: 'clay-tile', name: 'Clay Tile', sortOrder: 4 },
  { id: 'membrane', name: 'Membrane', sortOrder: 5 },
  { id: 'shingle', name: 'Asphalt Shingle', sortOrder: 6 },
];
```

Export all three for use in seed script.
  </action>
  <verify>
File exists and exports topics, categoryTopicMappings, coreSubstrates.
TypeScript compiles: `npx tsc --noEmit lib/db/seed-data/topics.ts`
  </verify>
  <done>
Topic definitions and mappings ready for seeding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create and run topic seeding script</name>
  <files>scripts/seed-topics.ts</files>
  <action>
Create `scripts/seed-topics.ts` that:

1. Imports db client from lib/db
2. Imports topics, categoryTopicMappings, coreSubstrates from lib/db/seed-data/topics
3. Imports schema tables (topics, categoryTopics, substrates, categories)

4. First, verify/seed all 6 core substrates (DATA-04):
   - Query existing substrates
   - For each coreSubstrate, upsert (insert if not exists) using onConflictDoNothing
   - Log which substrates were created vs already existed

5. Seed topics table:
   - Use db.insert().values(topics).onConflictDoNothing() for idempotency
   - Log count of topics seeded

6. Seed category_topics mappings:
   - First, query existing categories to get valid category IDs
   - Filter categoryTopicMappings to only include categories that exist
   - Insert valid mappings with onConflictDoNothing()
   - Log: "Mapped X categories to topics (Y mappings skipped - category not found)"

7. Verification query:
   - SELECT topics with COUNT of categories per topic
   - Log summary table

Use existing script patterns from scripts/enhance-mrm-data.ts or similar.

Add npm script to package.json if needed: `"db:seed-topics": "npx tsx scripts/seed-topics.ts"`

Run the script to populate the database.
  </action>
  <verify>
Run: `npx tsx scripts/seed-topics.ts`
Verify output shows:
- 6 substrates verified/created
- 5 topics created
- Category mappings created (at least 5 from MRM, potentially 5 from RANZ if those categories exist)

Query check: `SELECT t.name, COUNT(ct.category_id) FROM topics t LEFT JOIN category_topics ct ON t.id = ct.topic_id GROUP BY t.id`
  </verify>
  <done>
Topics table populated with 5 semantic topics.
Categories from both MRM and RANZ mapped to appropriate topics.
All 6 substrates verified to exist in database.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify category data and document gaps</name>
  <files>None (verification only)</files>
  <action>
Query the database to understand current category structure:

1. List all categories with their sourceId:
```sql
SELECT c.id, c.name, c.substrate_id, cs.short_name as source
FROM categories c
LEFT JOIN content_sources cs ON c.source_id = cs.id
ORDER BY c.source_id, c.name;
```

2. Check for categories not yet mapped to topics:
```sql
SELECT c.id, c.name
FROM categories c
LEFT JOIN category_topics ct ON c.id = ct.category_id
WHERE ct.topic_id IS NULL;
```

3. Verify topics have categories from both sources:
```sql
SELECT t.name as topic, cs.short_name as source, COUNT(*) as categories
FROM topics t
JOIN category_topics ct ON t.id = ct.topic_id
JOIN categories c ON ct.category_id = c.id
LEFT JOIN content_sources cs ON c.source_id = cs.id
GROUP BY t.name, cs.short_name
ORDER BY t.name, cs.short_name;
```

Document findings:
- If any categories are unmapped, add them to categoryTopicMappings
- If RANZ categories have different IDs than expected, update the mappings
- Log any data quality issues for future cleanup

This is diagnostic - no code changes unless mappings need adjustment.
  </action>
  <verify>
Output shows:
- All existing categories mapped to topics
- Topics have expected category distribution
- Any gaps documented for Phase 12 (Content Linking Population)
  </verify>
  <done>
Category-topic mappings verified complete.
Any gaps documented in summary.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Query `SELECT COUNT(*) FROM topics` returns 5
2. Query `SELECT COUNT(*) FROM category_topics` returns >= 5 (at least MRM categories)
3. Query `SELECT COUNT(*) FROM substrates` returns >= 6
4. All 6 core substrates exist (by ID check)
</verification>

<success_criteria>
- 5 semantic topics exist: flashings, penetrations, junctions, ventilation, general
- All existing categories mapped to appropriate topics
- All 6 substrates verified to exist (DATA-04 satisfied)
- Seed script is idempotent (can run multiple times safely)
- Any data gaps documented for future phases
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-model-foundation/07-02-SUMMARY.md`
</output>
