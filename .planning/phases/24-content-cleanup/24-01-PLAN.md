---
phase: 24-content-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/clean-cop-json.ts
  - public/cop/chapter-1.json
  - public/cop/chapter-2.json
  - public/cop/chapter-3.json
  - public/cop/chapter-4.json
  - public/cop/chapter-5.json
  - public/cop/chapter-6.json
  - public/cop/chapter-7.json
  - public/cop/chapter-8.json
  - public/cop/chapter-9.json
  - public/cop/chapter-10.json
  - public/cop/chapter-11.json
  - public/cop/chapter-12.json
  - public/cop/chapter-13.json
  - public/cop/chapter-14.json
  - public/cop/chapter-15.json
  - public/cop/chapter-16.json
  - public/cop/chapter-17.json
  - public/cop/chapter-18.json
  - public/cop/chapter-19.json
autonomous: true

must_haves:
  truths:
    - "User viewing COP Reader sees section content without embedded page numbers like '11' or '12' mid-paragraph"
    - "User viewing COP Reader sees section content without footer disclaimers like 'This is a controlled document'"
    - "User viewing COP Reader sees section titles appearing once per section (not repeated)"
    - "Technical content accuracy is preserved - no semantic changes to installation instructions or specifications"
  artifacts:
    - path: "scripts/clean-cop-json.ts"
      provides: "Automated COP JSON cleanup script with regex-based artifact removal"
      exports: ["cleanCopContent"]
    - path: "public/cop/chapter-*.json"
      provides: "19 cleaned chapter JSON files"
      contains: "Clean section content without PDF artifacts"
  key_links:
    - from: "scripts/clean-cop-json.ts"
      to: "public/cop/*.json"
      via: "fs.readFileSync + fs.writeFileSync"
      pattern: "readFileSync.*chapter-\\d+\\.json"
    - from: "app/cop/[chapterNumber]/page.tsx"
      to: "public/cop/*.json"
      via: "Server Component reads cleaned JSON"
      pattern: "readFileSync.*public/cop"
---

<objective>
Clean MRM COP chapter JSON files of PDF extraction artifacts while preserving technical accuracy.

Purpose: Strip embedded page numbers, footer disclaimers, and header repetition from 19 chapter JSON files so COP Reader displays clean formatted content for users.

Output: Agent-driven cleanup script + 19 cleaned chapter JSON files (3.7 MB total)
</objective>

<execution_context>
@C:/Users/LukeBoustridge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/LukeBoustridge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 17 established HTG content cleanup pattern
@.planning/phases/17-htg-content-pipeline/17-01-SUMMARY.md
@.planning/phases/17-htg-content-pipeline/17-02-SUMMARY.md

# Chapter JSON structure from Phase 13-14
@.planning/phases/13-data-foundation/13-01-SUMMARY.md
@.planning/phases/14-basic-cop-reader/14-01-SUMMARY.md

@public/cop/chapter-1.json
@lib/db/import-htg-content.ts
</context>

<tasks>

<task type="auto">
  <name>Create COP JSON cleanup script with artifact detection patterns</name>
  <files>scripts/clean-cop-json.ts</files>
  <action>
Create TypeScript script to clean all 19 COP chapter JSON files:

**Artifact patterns to remove:**
1. **Embedded page numbers**: Standalone digits (11, 12) or page refs mid-paragraph
   - Pattern: ` \d+\s+` between sentences or at start of paragraphs
   - NOT section numbers like "1.3A" or "1.5.1" - preserve these

2. **Footer disclaimers**: "This is a controlled document..." repetitions
   - Pattern: `This is a controlled document[^.]+\.`
   - Pattern: Trademark disclaimers with ® symbols

3. **Header repetition**: Section numbers + titles appearing twice
   - Pattern: Section title immediately followed by `\n{sectionNumber}\n{sectionTitle}` again
   - Example: "1.5.1 \nMediation \nMediation is..." → keep only first occurrence

4. **Spurious whitespace**: Multiple consecutive newlines, trailing spaces
   - Pattern: `\n{3,}` → `\n\n` (preserve paragraph breaks)
   - Pattern: ` +\n` → `\n`

**Script structure:**
```typescript
import * as fs from 'fs';
import * as path from 'path';

interface CopSection {
  number: string;
  title: string;
  content: string;
  subsections?: CopSection[];
}

function cleanContent(text: string, sectionNumber: string, sectionTitle: string): string {
  let cleaned = text;

  // Remove embedded page numbers (but not section refs)
  cleaned = cleaned.replace(/(?<!\d)\n\d{1,3}\n(?!\d)/g, '\n');

  // Remove footer disclaimers
  cleaned = cleaned.replace(/This is a controlled document[^.]+\./g, '');

  // Remove header repetition (section number + title at start)
  const headerPattern = new RegExp(`^${sectionNumber}\\s*\\n${sectionTitle}\\s*\\n`, 'i');
  cleaned = cleaned.replace(headerPattern, '');

  // Normalize whitespace
  cleaned = cleaned.replace(/\n{3,}/g, '\n\n');
  cleaned = cleaned.replace(/ +\n/g, '\n');
  cleaned = cleaned.trim();

  return cleaned;
}

function cleanSection(section: CopSection): void {
  section.content = cleanContent(section.content, section.number, section.title);

  if (section.subsections) {
    section.subsections.forEach(cleanSection);
  }
}

async function cleanAllChapters() {
  const copDir = path.join(process.cwd(), 'public/cop');

  for (let i = 1; i <= 19; i++) {
    const filepath = path.join(copDir, `chapter-${i}.json`);
    console.log(`Cleaning chapter ${i}...`);

    const data = JSON.parse(fs.readFileSync(filepath, 'utf-8'));

    // Clean all sections recursively
    if (data.sections) {
      data.sections.forEach(cleanSection);
    }

    // Write back (minified for production)
    fs.writeFileSync(filepath, JSON.stringify(data));
    console.log(`✓ Chapter ${i} cleaned`);
  }

  console.log('\n✅ All 19 chapters cleaned');
}

cleanAllChapters().catch(console.error);
```

**Validation:**
- Log sample before/after for first 3 chapters
- Count artifacts removed per chapter
- Verify JSON structure unchanged (parse + stringify test)

Add to package.json scripts:
```json
"db:clean-cop-json": "tsx scripts/clean-cop-json.ts"
```
  </action>
  <verify>
Run script: `npm run db:clean-cop-json`

Check output shows:
- 19 chapters processed
- Artifact counts logged per chapter
- No JSON parsing errors

Spot-check chapter-1.json:
- Section 1.3 Standards table has no embedded page numbers
- Section 1.5 Disputes has no "This is a controlled document" footer
- Section titles appear once only
  </verify>
  <done>
Script exists at scripts/clean-cop-json.ts with cleanContent function implementing 4 artifact removal patterns. Running `npm run db:clean-cop-json` processes all 19 chapters without errors. Manual inspection of 3 sample chapters confirms artifacts removed and technical content preserved.
  </done>
</task>

<task type="auto">
  <name>Execute cleanup script and verify content quality</name>
  <files>public/cop/chapter-1.json, public/cop/chapter-2.json, public/cop/chapter-3.json, public/cop/chapter-4.json, public/cop/chapter-5.json, public/cop/chapter-6.json, public/cop/chapter-7.json, public/cop/chapter-8.json, public/cop/chapter-9.json, public/cop/chapter-10.json, public/cop/chapter-11.json, public/cop/chapter-12.json, public/cop/chapter-13.json, public/cop/chapter-14.json, public/cop/chapter-15.json, public/cop/chapter-16.json, public/cop/chapter-17.json, public/cop/chapter-18.json, public/cop/chapter-19.json</files>
  <action>
Run cleanup script and verify results:

**Execution:**
```bash
npm run db:clean-cop-json
```

**Verification checks:**
1. **Artifact removal validation** - Spot-check 5 chapters for common artifacts:
   - Chapter 1 section 1.3 (Standards table - page numbers)
   - Chapter 1 section 1.5 (Disputes - footer disclaimers)
   - Chapter 5 (large chapter - header repetition)
   - Chapter 8 (Flashings - technical content preservation)
   - Chapter 19 (largest file - whitespace normalization)

2. **Content preservation** - Grep checks:
   - `grep -c "NZS\|AS/NZS" public/cop/chapter-*.json` - verify standards refs intact
   - `grep -c "\\d\\.\\d" public/cop/chapter-*.json` - verify section numbers intact
   - Technical terms preserved: "flashing", "membrane", "corrosion", "wind zone"

3. **File size comparison:**
   - Before: total ~3.7 MB
   - After: slightly smaller (artifacts removed)
   - Individual chapter sizes reasonable (largest <650 KB)

4. **JSON validity:**
   - `node -e "JSON.parse(require('fs').readFileSync('public/cop/chapter-1.json'))"` for all 19

**If issues found:**
- Refine regex patterns in cleanContent function
- Re-run script
- Repeat verification

**Final check:**
Start dev server, navigate to /cop/8 (Flashings), verify:
- Section content displays cleanly
- No visible page numbers or disclaimers
- Technical specifications readable
  </action>
  <verify>
All 19 chapter JSON files updated (git diff shows content changes).

Verification checks pass:
- 5 spot-checked chapters show artifacts removed
- Standards references (NZS, AS/NZS) count unchanged
- Section numbering structure intact
- All 19 files parse as valid JSON
- Dev server /cop/8 displays clean content

No semantic changes to technical content (installation instructions, specifications, compliance requirements).
  </verify>
  <done>
19 COP chapter JSON files cleaned of PDF artifacts. User viewing COP Reader at /cop/{chapterNumber} sees clean formatted text without embedded page numbers, footer disclaimers, or header repetition. Technical accuracy preserved - all NZS/AS standards references, section numbers, and installation specifications unchanged.
  </done>
</task>

</tasks>

<verification>
**Overall phase checks:**

1. **Artifact removal** - User verification:
   - Navigate to /cop/1, /cop/5, /cop/8, /cop/19
   - Confirm no visible PDF artifacts in displayed content
   - Section content flows naturally without interruptions

2. **Content preservation** - Technical verification:
   - Run `git diff public/cop/chapter-8.json | grep -E "flashing|membrane"`
   - Confirm technical terms present in both before/after
   - Section structure (number, title, content, subsections) unchanged

3. **Repeatability** - Script verification:
   - Script is idempotent (re-running produces same output)
   - Can be re-run on future COP updates (CLEAN-04 requirement)
   - npm script command documented in package.json

4. **Requirements mapping:**
   - CLEAN-01: ✓ MRM COP content cleaned of page numbers, disclaimers, headers
   - CLEAN-03: ✓ Original technical wording preserved
   - CLEAN-04: ✓ Repeatable script for future updates
</verification>

<success_criteria>
**Measurable completion:**

- [ ] scripts/clean-cop-json.ts exists with cleanContent function implementing 4 artifact patterns
- [ ] npm run db:clean-cop-json executes without errors
- [ ] All 19 public/cop/chapter-*.json files updated (git status shows modified)
- [ ] Spot-check of chapters 1, 5, 8, 19 confirms artifacts removed
- [ ] grep verification shows standards refs and section numbers intact
- [ ] Dev server /cop/8 displays clean content without visible artifacts
- [ ] Script documented in package.json for future re-runs

**User outcome:**
Viewing COP Reader (/cop/{chapterNumber}), user sees clean formatted technical content suitable for Building Code citation without distracting PDF extraction artifacts.
</success_criteria>

<output>
After completion, create `.planning/phases/24-content-cleanup/24-01-SUMMARY.md`
</output>
